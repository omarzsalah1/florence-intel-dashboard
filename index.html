<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NightingaleMD Florence AI Navigator</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-teal: #55B5B8;
            --brand-purple: #8B5CF6;
            --brand-yellow: #F8CA44;
            --brand-red: #E45740;
            --brand-green: #10B981;
            --text-dark: #1F2937;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ==================== ATHENA PANEL (LEFT) ==================== */
        .athena-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            overflow: hidden;
            font-family: 'Source Sans 3', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            color: #333333;
        }
        
        .athena-header {
            background: linear-gradient(135deg, #582c83 0%, #3d1e5c 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .athena-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .athena-logo span:first-child {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }
        
        .athena-logo span:last-child {
            font-size: 20px;
            font-weight: 300;
            color: #80cbc4;
        }
        
        .patient-banner {
            background: #e8f5e9;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .patient-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .patient-info strong {
            font-size: 15px;
            color: #1b5e20;
        }
        
        .patient-info span {
            color: #2e7d32;
            font-size: 13px;
        }
        
        .athena-actions {
            display: flex;
            gap: 8px;
        }
        
        .athena-actions button {
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-save {
            background: #ffffff;
            border: 1px solid #582c83;
            color: #582c83;
            height: 28px;
        }
        
        .btn-save:hover {
            background: #f0edf4;
        }
        
        .btn-sign {
            background: #582c83;
            border: 1px solid #582c83;
            color: white;
            height: 32px;
            padding: 8px 12px;
        }
        
        .btn-sign:hover {
            background: #3d1e5c;
        }
        
        .athena-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .athena-nav {
            width: 200px;
            background: #fafafa;
            border-right: 1px solid #e0e0e0;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 20px;
        }
        
        .nav-section-title {
            font-size: 10px;
            font-weight: 700;
            color: #9e9e9e;
            text-transform: uppercase;
            padding: 0 16px;
            margin-bottom: 8px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            color: #582c83;
        }
        
        .nav-item:hover {
            background: #f0edf4;
        }
        
        .nav-item.active {
            background: #f0edf4;
            color: #582c83;
            font-weight: 600;
        }
        
        .nav-item .icon {
            font-size: 16px;
        }
        
        .nav-item .badge {
            margin-left: auto;
            background: #582c83;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .athena-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* SOAP Sections */
        .soap-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .soap-header {
            background: #f5f5f5;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 700;
            color: #424242;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-badge {
            font-size: 10px;
            font-weight: 500;
            color: #757575;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .soap-content {
            padding: 16px;
        }
        
        /* Staged Items in Athena */
        .staged-item {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #81c784;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 12px;
            animation: stageIn 0.5s ease;
        }
        
        @keyframes stageIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .staged-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #55B5B8;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .gap-title {
            font-size: 12px;
            font-weight: 600;
            color: #31393F;
            margin-top: 3px;
        }
        
        .gap-description {
            font-size: 11px;
            color: #5A6872;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .gap-codes {
            font-size: 10px;
            color: #9e9e9e;
            margin-top: 3px;
        }olor: #558b2f;
        }
        
        /* CCA Staging Styles */
        .cca-staging {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
        }
        
        .staged-section-label {
            font-size: 10px;
            font-weight: 700;
            color: #1565c0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 12px;
            margin-bottom: 6px;
            padding-bottom: 3px;
            border-bottom: 1px solid #90caf9;
        }
        
        .staged-problem {
            font-size: 13px;
            color: #0d47a1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .hcc-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .staged-ap-block {
            background: rgba(255, 255, 255, 0.6);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #0d47a1;
            line-height: 1.6;
        }
        
        .ap-diagnosis {
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .ap-plan-text {
            margin-top: 6px;
        }
        
        .staged-order {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #0d47a1;
            margin-bottom: 6px;
            border-left: 3px solid #ff9800;
        }
        
        .staged-order-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #0d47a1;
            margin-bottom: 6px;
            border-left: 3px solid #ff9800;
        }
        
        .remove-btn {
            margin-top: 10px;
            background: transparent;
            border: none;
            color: #582c83;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: text-decoration 0.15s;
        }
        
        .remove-btn:hover {
            text-decoration: underline;
        }
        
        /* Finding rows */
        .finding-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .finding-label {
            width: 150px;
            font-size: 12px;
            color: #757575;
        }
        
        .finding-value {
            font-size: 13px;
            color: #424242;
            font-weight: 500;
        }
        
        .finding-value.alert {
            color: #c62828;
        }
        
        /* ==================== FLORENCE PANEL (RIGHT) ==================== */
        .florence-panel {
            width: 400px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            color: #31393F;
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .florence-panel.collapsed {
            width: 200px;
        }
        
        .florence-panel.collapsed .patient-card,
        .florence-panel.collapsed .workflow-buttons,
        .florence-panel.collapsed .florence-tabs,
        .florence-panel.collapsed .tab-content {
            display: none;
        }
        
        .sidebar-collapse-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(85, 181, 184, 0.1);
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            color: #55B5B8;
            font-size: 14px;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .sidebar-collapse-btn:hover {
            background: rgba(85, 181, 184, 0.2);
        }
        
        .florence-header {
            padding: 6px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .florence-header.auto-hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        
        .patient-card.auto-hidden {
            transform: translateY(-100%);
            opacity: 0;
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .florence-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .florence-logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .florence-logo-icon svg {
            width: 14px;
            height: 14px;
            fill: white;
        }
        
        .florence-title {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }
        
        .florence-subtitle {
            font-size: 9px;
            color: #5A6872;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #55B5B8;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            background: #55B5B8;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sync-notif-bell {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .sync-notif-bell:hover {
            transform: scale(1.1);
        }
        
        .sync-notif-bell svg {
            color: #55B5B8;
        }
        
        .sync-notif-bell.has-notifications svg {
            color: #ff6b35;
            animation: bellRing 0.5s ease;
        }
        
        .sync-notif-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ff6b35;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }
        
        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(10deg); }
        }
        
        /* Patient Card */
        .patient-card {
            margin: 8px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 12px;
        }
        
        .patient-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 0;
        }
        
        .patient-avatar {
            display: none;
        }
        
        .patient-details {
            flex: 1;
        }
        
        .patient-details h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .patient-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }
        
        .patient-action-btn {
            padding: 4px 8px;
            background: #55B5B8;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .patient-action-btn:hover {
            background: #449194;
        }
        
        .patient-action-btn.post-visit {
            background: #7B1FA2;
        }
        
        .patient-action-btn.post-visit:hover {
            background: #6A1B9A;
        }
        
        .patient-action-btn {
            background: linear-gradient(135deg, #55B5B8 0%, #4A9FA2 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .patient-action-btn:hover {
            background: linear-gradient(135deg, #4A9FA2 0%, #3D8D90 100%);
            transform: translateY(-1px);
        }
        
        .patient-action-btn svg {
            width: 10px;
            height: 10px;
        }
        
        .patient-action-btn.post-visit {
            background: linear-gradient(135deg, #8B5CF6, #6D28D9);
        }
        
        .patient-action-btn.post-visit:hover {
            background: linear-gradient(135deg, #7C3AED, #5B21B6);
        }
        
        .patient-tags {
            display: flex;
            gap: 6px;
        }
        
        .patient-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .patient-tag.risk {
            background: #ef5350;
            color: white;
        }
        
        .patient-tag.ccm {
            background: #66bb6a;
            color: white;
        }
        
        .patient-mrn {
            font-size: 12px;
            color: #5A6872;
            margin-top: 4px;
        }
        
        /* Workflow Buttons */
        .workflow-buttons {
            display: flex;
            gap: 8px;
            padding: 12px 0 0 0;
            margin-top: 12px;
            border-top: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .workflow-buttons.hidden {
            max-height: 0;
            padding: 0;
            margin-top: 0;
            border-top: none;
            opacity: 0;
        }
        
        .workflow-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            border: 2px solid;
        }
        
        .workflow-btn svg {
            width: 16px;
            height: 16px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .workflow-btn .btn-text {
            margin-left: 2px;
        }
        
        .workflow-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-engage {
            background: var(--brand-teal);
            border-color: var(--brand-teal);
            color: white;
        }
        
        .btn-engage:hover:not(:disabled) {
            background: #3D9A9D;
        }
        
        .btn-engage.active {
            background: #3D9A9D;
            animation: pulseBtn 1.5s infinite;
        }
        
        .btn-convene {
            background: transparent;
            border-color: var(--brand-purple);
            color: var(--brand-purple);
        }
        
        .btn-convene:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .btn-convene.active {
            background: var(--brand-purple);
            color: white;
            animation: pulseBtn 1.5s infinite;
        }
        
        .btn-checkin {
            background: transparent;
            border-color: var(--brand-yellow);
            color: var(--brand-yellow);
        }
        
        .btn-checkin:hover:not(:disabled) {
            background: rgba(248, 202, 68, 0.2);
        }
        
        .btn-checkin.active {
            background: var(--brand-yellow);
            color: #1F2937;
            animation: pulseBtn 1.5s infinite;
        }
        
        @keyframes pulseBtn {
            0%, 100% { box-shadow: 0 0 0 0 rgba(85, 181, 184, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(85, 181, 184, 0); }
        }
        
        /* Florence Toolbar - Hidden (buttons moved to patient card) */
        .florence-toolbar {
            display: none;
        }
        
        /* Florence Tabs */
        .florence-tabs {
            display: flex;
            gap: 4px;
            margin-top: 16px;
            padding: 0 8px;
            background: #49545E;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .florence-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 8px;
            background: transparent;
            border: none;
            color: #F2F3F4;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            border-radius: 6px 6px 0 0;
            position: relative;
        }
        
        .florence-tab:hover {
            color: #FFFFFF;
            background: rgba(85, 181, 184, 0.1);
        }
        
        .florence-tab.active {
            color: #FFFFFF;
            background: rgba(85, 181, 184, 0.15);
            border-bottom-color: #55B5B8;
        }
        
        .tab-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }
        
        .tab-panel {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .tab-panel.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Florence Summary - Collapsible */
        .florence-summary {
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #ff6b35;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .summary-header {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .summary-header:hover {
            background: #e9ecef;
        }
        
        .summary-header h4 {
            font-size: 13px;
            font-weight: 600;
            color: #ff6b35;
        }
        
        .summary-toggle {
            font-size: 12px;
            color: #5A6872;
            transition: transform 0.3s;
        }
        
        .summary-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .summary-content {
            padding: 0 12px 12px;
            font-size: 12px;
            line-height: 1.5;
            color: #31393F;
            display: none;
        }
        
        .summary-content.show {
            display: block;
        }
        
        /* Gaps Section */
        .gaps-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .gaps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .gaps-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gaps-title h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .gaps-count {
            background: #ef5350;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .prework-btn {
            background: #e9ecef;
            border: none;
            color: #31393F;
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* Search and Filters */
        .gaps-controls {
            margin-bottom: 12px;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            color: #31393F;
            font-size: 13px;
            margin-bottom: 10px;
        }
        
        .search-box::placeholder {
            color: #9e9e9e;
        }
        
        .filter-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            color: #31393F;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: #dee2e6;
        }
        
        .filter-btn.active {
            background: #55B5B8;
            color: white;
        }
        
        .show-staged-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #5A6872;
        }
        
        .show-staged-row input {
            accent-color: #55B5B8;
        }
        
        /* Gap Category Sections */
        .gap-category {
            margin-bottom: 12px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        
        .category-header:hover {
            background: #dee2e6;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #31393F;
        }
        
        .category-count {
            background: #55B5B8;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .category-toggle {
            font-size: 12px;
            color: #5A6872;
            transition: transform 0.3s;
        }
        
        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .category-gaps {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        
        .category-gaps.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }
        
        /* Gap Cards */
        .gaps-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .gap-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #55B5B8;
        }
        
        .gap-card.staged {
            opacity: 0.7;
            border-left-color: #9e9e9e;
        }
        
        .gap-card-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .gap-checkbox {
            margin-top: 4px;
            accent-color: #55B5B8;
        }
        
        .gap-info {
            flex: 1;
        }
        
        .gap-type-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            margin-right: 6px;
        }
        
        .gap-type-badge.recapture {
            background: #2196f3;
            color: white;
        }
        
        .gap-type-badge.suspect {
            background: #ff9800;
            color: white;
        }
        
        .gap-type-badge.quality {
            background: #9c27b0;
            color: white;
        }
        
        .gap-type-badge.frailty {
            background: #795548;
            color: white;
        }
        
        .coop-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 3px;
            background: linear-gradient(135deg, #d4a017, #c49000);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(196, 144, 0, 0.3);
        }
        
        .gap-priority {
            font-size: 10px;
            color: #ef5350;
            font-weight: 600;
        }
        
        .gap-title {
            font-size: 13px;
            font-weight: 600;
            margin: 6px 0 4px;
        }
        
        .gap-codes {
            font-size: 11px;
            color: #5A6872;
        }
        
        .gap-description {
            font-size: 12px;
            color: #31393F;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .gap-actions {
            display: flex;
            gap: 6px;
        }
        
        .stage-btn {
            flex: 1;
            padding: 8px 12px;
            background: #55B5B8;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stage-btn:hover {
            background: #449194;
        }
        
        .stage-btn.staged {
            background: #9e9e9e;
            cursor: default;
        }
        
        .detail-btn, .undo-btn {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid #c0c0c0;
            border-radius: 5px;
            color: #5A6872;
            font-size: 10px;
            cursor: pointer;
        }
        
        .staged-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 10px;
            color: #81c784;
        }
        
        .staged-indicator svg {
            width: 14px;
            height: 14px;
            fill: #81c784;
        }
        
        /* Stage for Future Visit */
        .future-visit-btn {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid #7B1FA2;
            border-radius: 5px;
            color: #7B1FA2;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .future-visit-btn:hover {
            background: #F3E5F5;
            border-color: #6A1B9A;
        }
        
        /* Bulk Gap Staging */
        .bulk-stage-btn {
            position: fixed;
            bottom: 20px;
            right: 432px; /* 400px panel width + 16px margin + 16px from edge */
            background: var(--brand-teal);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(85, 181, 184, 0.4);
            transition: all 0.3s;
            z-index: 1000;
            display: none;
        }
        
        .bulk-stage-btn:hover {
            background: #4A9FA2;
            box-shadow: 0 6px 16px rgba(85, 181, 184, 0.5);
            transform: translateY(-2px);
        }
        
        .bulk-stage-btn.visible {
            display: block;
        }
        
        .gap-card.deferred {
            opacity: 0.75;
            border-left-color: #7B1FA2;
        }
        
        .deferred-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 10px;
            color: #7B1FA2;
            background: #F3E5F5;
            padding: 6px 10px;
            border-radius: 6px;
        }
        
        .deferred-indicator svg {
            width: 14px;
            height: 14px;
            fill: #7B1FA2;
        }
        
        .stage-btn.deferred {
            background: #7B1FA2;
            cursor: default;
        }
        
        .deferred-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            background: #F3E5F5;
            color: #7B1FA2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== TRANSCRIPT TAB ==================== */
        .transcript-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.system {
            align-self: center;
            background: #e9ecef;
            color: #5A6872;
            font-size: 12px;
            padding: 8px 16px;
            max-width: 100%;
            text-align: center;
        }
        
        .message.florence {
            align-self: flex-start;
            background: var(--brand-teal);
            color: white;
            border-bottom-left-radius: 4px;
        }
        
        .message.patient {
            align-self: flex-end;
            background: #e9ecef;
            color: #31393F;
            border-bottom-right-radius: 4px;
        }
        
        .message.care-manager {
            align-self: flex-end;
            background: var(--brand-purple);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-header {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .message-header svg {
            width: 14px;
            height: 14px;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #e9ecef;
            border-radius: 16px;
            width: fit-content;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9e9e9e;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* ==================== DOCUMENTATION TAB ==================== */
        .doc-container {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: visible;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            max-height: calc(100vh - 340px);
        }
        
        .doc-header {
            background: #e9ecef;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .doc-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .doc-badge {
            background: var(--brand-teal);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .doc-content {
            padding: 16px;
            color: #2d3748;
            flex: 1;
            overflow-y: scroll;
            min-height: 0;
            max-height: calc(100vh - 400px);
            -webkit-overflow-scrolling: touch;
        }
        
        .doc-content::-webkit-scrollbar {
            width: 8px;
        }
        .doc-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .doc-content::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        .doc-content::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        
        .doc-scroll-hint {
            text-align: center;
            padding: 6px;
            font-size: 11px;
            color: #9CA3AF;
            background: linear-gradient(to bottom, transparent, #f8f9fa);
            border-top: 1px solid #E5E7EB;
        }
        
        .doc-section {
            margin-bottom: 16px;
        }
        
        .doc-section:last-child {
            margin-bottom: 0;
        }
        
        .doc-section h4 {
            font-size: 12px;
            font-weight: 700;
            color: var(--brand-teal);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .doc-section p, .doc-section ul {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .doc-section ul {
            padding-left: 20px;
        }
        
        .doc-section li {
            margin-bottom: 4px;
        }
        
        .file-btn {
            width: 100%;
            padding: 12px;
            background: var(--brand-teal);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .file-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .file-btn:hover {
            background: #3D9A9D;
        }
        
        .file-btn:disabled {
            background: #6B7280;
            cursor: not-allowed;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--brand-teal);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* ==================== LOG TAB - GAP TRACKER ==================== */
        .gap-tracker-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .gap-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .gap-tracker-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255,255,255,0.95);
        }
        
        .gap-tracker-stats {
            display: flex;
            gap: 20px;
        }
        
        .gap-tracker-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .gap-tracker-stats .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: rgba(255,255,255,0.95);
        }
        
        .gap-tracker-stats .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.5);
        }
        
        .gap-tracker-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tracker-gap-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .tracker-gap-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.15);
        }
        
        .tracker-gap-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .tracker-gap-status.open { background: #fbbf24; }
        .tracker-gap-status.staged { background: #60a5fa; }
        .tracker-gap-status.accepted { background: #34d399; }
        .tracker-gap-status.dismissed { background: #9ca3af; }
        .tracker-gap-status.documented { background: #a78bfa; }
        
        .tracker-gap-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .tracker-gap-title {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
        }
        
        .tracker-gap-meta {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }
        
        .tracker-gap-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        
        .tracker-gap-badge.open {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }
        
        .tracker-gap-badge.staged {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }
        
        .tracker-gap-badge.accepted {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }
        
        .tracker-gap-badge.dismissed {
            background: rgba(156, 163, 175, 0.15);
            color: #9ca3af;
        }
        
        .tracker-gap-badge.documented {
            background: rgba(167, 139, 250, 0.15);
            color: #a78bfa;
        }
        
        /* Dismissal Analytics Dashboard */
        .dismissal-analytics {
            margin-top: 24px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
        }
        
        .analytics-header {
            margin-bottom: 20px;
        }
        
        .analytics-header h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
            color: rgba(255,255,255,0.95);
        }
        
        .analytics-subtitle {
            margin: 0;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        
        .analytics-impact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .impact-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(52, 211, 153, 0.2);
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            color: #34d399;
        }
        
        .impact-text {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }
        
        .impact-text strong {
            font-size: 20px;
            color: #34d399;
        }
        
        .analytics-chart,
        .analytics-reasons {
            margin-top: 20px;
        }
        
        .analytics-chart h5,
        .analytics-reasons h5 {
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.7);
        }
        
        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chart-bar-label {
            width: 80px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
        }
        
        .chart-bar-track {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            transition: width 0.5s ease;
        }
        
        .reason-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .reason-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
        }
        
        .reason-text {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        .reason-count {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.6);
        }
        
        .log-icon {
            width: 32px;
            height: 32px;
            background: rgba(85, 181, 184, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--brand-teal);
        }
        
        .log-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .log-content h4 {
            font-size: 13px;
            font-weight: 600;
            color: #333333;
        }
        
        .log-content p {
            font-size: 12px;
            color: #757575;
        }
        
        .log-time {
            margin-left: auto;
            font-size: 11px;
            color: #999999;
        }
        

        /* Staged Problems */
        .staged-section-header {
            background: #FFF9C4;
            border: 1px solid #F57C00;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #E65100;
        }
        
        .problem-item.staged {
            background: #FFF9C4;
            border-left: 4px solid #F57C00;
        }
        
        .problem-status.staged {
            background: #F57C00;
            color: white;
        }
        
        .staged-source {
            font-size: 11px;
            color: #757575;
            margin-top: 4px;
        }
        
        .btn-approve {
            background: #43A047;
            color: white;
            border: 1px solid #43A047;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-approve:hover {
            background: #2E7D32;
        }
        
        .btn-dismiss {
            background: white;
            color: #C62828;
            border: 1px solid #C62828;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-dismiss:hover {
            background: #FFEBEE;
        }


        /* Completion Tracker */
        .completion-tracker {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .completion-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .completion-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .completion-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .completion-stat-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .completion-stat-icon.accepted {
            background: #E8F5E9;
            color: #43A047;
        }
        
        .completion-stat-icon.dismissed {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .completion-stat-icon.pending {
            background: #FFF9C4;
            color: #F57C00;
        }
        
        .completion-stat-icon.edited {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .completion-progress {
            width: 100%;
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .completion-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #43A047 0%, #66BB6A 100%);
            transition: width 0.3s ease;
        }
        
        .completion-summary {
            font-size: 11px;
            color: #757575;
            margin-top: 8px;
        }


        /* Staging Preview Modal */
        .staging-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .staging-preview-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }
        
        .staging-preview-header {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .staging-preview-section {
            background: #F5F5F5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .staging-preview-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #582c83;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .staging-preview-item {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .staging-preview-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E0E0E0;
        }
        
        .staging-preview-time {
            font-size: 11px;
            color: #757575;
        }
        
        .staging-preview-actions {
            display: flex;
            gap: 12px;
        }


        /* Batch Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            border: 2px solid #55B5B8;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .sync-indicator-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #E0F7F8;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #55B5B8;
            font-size: 16px;
        }
        
        .sync-indicator-text {
            flex: 1;
        }
        
        .sync-indicator-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .sync-indicator-subtitle {
            font-size: 11px;
            color: #757575;
        }
        
        .sync-indicator.syncing .sync-indicator-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        
        /* Bulk Staging Modal */
        .bulk-modal {
            max-width: 700px;
            max-height: 85vh;
        }
        
        .bulk-gap-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .bulk-gap-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #fafafa;
        }
        
        .bulk-gap-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .bulk-gap-title {
            font-size: 14px;
            font-weight: 600;
            color: #424242;
            flex: 1;
        }
        
        .bulk-gap-meta {
            font-size: 11px;
            color: #757575;
            margin-top: 4px;
        }
        
        .bulk-remove-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #E45740;
            border-radius: 4px;
            color: #E45740;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bulk-remove-btn:hover {
            background: #FFEBEE;
        }
        
        .bulk-meat-section {
            margin-top: 12px;
        }
        
        .bulk-meat-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .bulk-meat-toggle:hover {
            background: #f5f5f5;
        }
        
        .bulk-meat-toggle-icon {
            font-size: 12px;
            color: #757575;
            transition: transform 0.2s;
        }
        
        .bulk-meat-toggle-icon.expanded {
            transform: rotate(90deg);
        }
        
        .bulk-meat-content {
            display: none;
            margin-top: 8px;
            padding: 12px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .bulk-meat-content.expanded {
            display: block;
        }
        
        .bulk-meat-label {
            font-weight: 600;
            color: #424242;
            margin-top: 8px;
            margin-bottom: 4px;
        }
        
        .bulk-meat-label:first-child {
            margin-top: 0;
        }
        
        .gap-type-group {
            margin-bottom: 24px;
        }
        
        .gap-type-group-title {
            font-size: 12px;
            font-weight: 700;
            color: #757575;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header {
            background: #f5f5f5;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #424242;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9e9e9e;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-gap-info {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .modal-gap-title {
            font-size: 15px;
            font-weight: 600;
            color: #424242;
            margin-bottom: 6px;
        }
        
        .modal-gap-detail {
            font-size: 13px;
            color: #757575;
            line-height: 1.5;
        }
        
        .modal-destination {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .modal-destination-label {
            font-size: 10px;
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 4px;
        }
        
        .modal-destination-value {
            font-size: 14px;
            font-weight: 600;
            color: #1b5e20;
        }
        
        .modal-note {
            margin-bottom: 16px;
        }
        
        .modal-note label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #424242;
            margin-bottom: 6px;
        }
        
        .modal-note textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.cancel {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            color: #616161;
        }
        
        .modal-btn.confirm {
            background: #55B5B8;
            border: 1px solid #55B5B8;
            color: white;
        }
        
        .modal-btn.confirm:hover {
            background: #449194;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        
        .florence-panel ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .florence-panel ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }
    
/* Details Expandable Card (v7) */
.gap-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background: #f8f9fa;
    border-radius: 6px;
    margin-top: 12px;
}

.gap-details.expanded {
    max-height: 2000px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.gap-details-section {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
}

.gap-details-section:last-child {
    border-bottom: none;
}

.gap-details-section h4 {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin: 0 0 8px 0;
}

.gap-details-section p, .gap-details-section ul {
    font-size: 12px;
    color: #6c757d;
    margin: 0;
    line-height: 1.5;
}

.gap-details-section ul {
    padding-left: 20px;
}

.gap-details-section li {
    margin-bottom: 4px;
}

.coding-note {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 12px;
    margin: 12px 0;
    border-radius: 4px;
}

.coding-note h4 {
    color: #856404;
    margin: 0 0 6px 0;
}

.coding-note p {
    color: #856404;
    margin: 0;
}

/* CSS Transitions (v7) */
.tab-button {
    transition: all 0.2s ease;
}

.florence-summary {
    transition: max-height 0.3s ease-out;
}

button {
    transition: all 0.15s ease;
}

button:hover {
    transform: translateY(-1px);
}

.gap-action-btn {
    transition: all 0.2s ease;
}

.filter-chip {
    transition: all 0.15s ease;
}

.gap-card {
    transition: all 0.2s ease;
}

.gap-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

    
        /* Provider Attestation View */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2196F3;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .attestation-checkboxes {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #2196F3;
        }
        
        body.provider-view .attestation-checkboxes {
            display: block;
        }
        
        .attestation-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .attestation-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .attestation-item label {
            font-size: 13px;
            cursor: pointer;
            margin: 0;
        }
        
        /* Problem List Styles */
        .problem-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }
        
        .problem-item.staged {
            border-left: 4px solid #FFA726;
            background: linear-gradient(to right, #FFF8E1 0%, white 100%);
        }
        
        .problem-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .problem-status {
            font-size: 11px;
            font-weight: 600;
            color: #43A047;
            background: #E8F5E9;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        .problem-status.staged {
            color: #F57C00;
            background: #FFF8E1;
        }
        
        .problem-diagnosis {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .hcc-badge {
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: #FF6F00;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .problem-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #757575;
        }
        
        .problem-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn-link-small {
            background: none;
            border: none;
            color: #582c83;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }
        
        .btn-link-small:hover {
            color: #3d1e5c;
        }
        
        .btn-add-small {
            background: white;
            border: 1px solid #582c83;
            color: #582c83;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .btn-add-small:hover {
            background: #f0edf4;
        }
        
        /* A&P Block Styles */
        .ap-block {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            background: white;
        }
        
        .ap-block.staged {
            border-left: 4px solid #FFA726;
            background: linear-gradient(to right, #FFF8E1 0%, white 100%);
        }
        
        .ap-block-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .ap-block-number {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .ap-block-diagnosis {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .ap-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #582c83;
            text-transform: uppercase;
            margin-top: 12px;
            margin-bottom: 6px;
        }
        
        .ap-text {
            font-size: 13px;
            color: #424242;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .meat-section {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .meat-section:last-child {
            border-bottom: none;
        }
        
        .meat-section strong {
            color: #1a237e;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .ap-orders {
            margin-top: 12px;
        }
        
        .ap-order-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        
        .ap-order-checkbox {
            width: 16px;
            height: 16px;
        }
        
        .ap-order-text {
            font-size: 13px;
            color: #333;
            flex: 1;
        }
        
        .ap-order-badge {
            font-size: 10px;
            font-weight: 600;
            color: #E65100;
            background: #FFE0B2;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .ap-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        
        .staged-badge {
            font-size: 11px;
            font-weight: 600;
            color: #F57C00;
            background: #FFF8E1;
            padding: 4px 8px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        
        /* Medication Styles */
        .med-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }
        
        .med-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        
        .med-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        .med-sig {
            font-size: 12px;
            color: #757575;
        }
        
        .adherence-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: auto;
        }
        
        .adherence-badge.good {
            color: #43A047;
            background: #E8F5E9;
        }
        
        .adherence-badge.warning {
            color: #F57C00;
            background: #FFF8E1;
        }
        
        .adherence-badge.poor {
            color: #E53935;
            background: #FFEBEE;
        }
        
        .med-details {
            font-size: 12px;
            color: #757575;
        }
        
        /* Referral Styles */
        .referral-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }
        
        .referral-item.staged {
            border-left: 4px solid #FFA726;
            background: linear-gradient(to right, #FFF8E1 0%, white 100%);
        }
        
        .referral-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .referral-status {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        .referral-status.unsigned {
            color: #F57C00;
            background: #FFF8E1;
        }
        
        .referral-status.signed {
            color: #43A047;
            background: #E8F5E9;
        }
        
        .referral-status.pending {
            color: #F57C00;
            background: #FFF3E0;
        }
        
        .referral-status.completed {
            color: #1976D2;
            background: #E3F2FD;
        }
        
        .referral-status.noshow {
            color: #C62828;
            background: #FFEBEE;
        }
        
        .referral-item.pending {
            border-left: 4px solid #FFA726;
        }
        
        .referral-item.completed {
            border-left: 4px solid #42A5F5;
        }
        
        .referral-item.noshow {
            border-left: 4px solid #EF5350;
        }
        
        .referral-specialty {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .referral-details {
            font-size: 12px;
            color: #424242;
            line-height: 1.6;
        }
        
        .referral-details div {
            margin-bottom: 4px;
        }
        
        /* Vitals Tracking Styles */
        .vital-trend {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }
        
        .vital-trend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .vital-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        .vital-alert {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .vital-alert.warning {
            color: #F57C00;
            background: #FFF8E1;
        }
        
        .vital-alert.critical {
            color: #E53935;
            background: #FFEBEE;
        }
        
        .vital-alert.normal {
            color: #43A047;
            background: #E8F5E9;
        }
        
        .vital-values {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: #424242;
        }
        
        /* Appointment Styles */
        .appointment-section {
            margin-bottom: 24px;
        }
        
        .appointment-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #582c83;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #582c83;
        }
        
        .appointment-item {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
        }
        
        .appointment-item.needed {
            border-left: 4px solid #FFA726;
            background: linear-gradient(to right, #FFF8E1 0%, white 100%);
        }
        
        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .appointment-type {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        .appointment-type.cca {
            color: #1976D2;
        }
        
        .appointment-type.specialist {
            color: #7B1FA2;
        }
        
        .appointment-type.followup {
            color: #F57C00;
        }
        
        .appointment-type.tcm {
            color: #C62828;
        }
        
        .appointment-date {
            font-size: 12px;
            font-weight: 600;
            color: #582c83;
        }
        
        .appointment-priority {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
        }
        
        .appointment-priority.high {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .appointment-priority.medium {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .appointment-details {
            font-size: 12px;
            color: #424242;
            line-height: 1.6;
        }
        
        .appointment-details > div {
            margin-bottom: 4px;
        }
        
        .status-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        .status-badge.scheduled {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-badge.pending {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .status-badge.completed {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .status-badge.noshow {
            background: #FFEBEE;
            color: #C62828;
        }

        /* Florence Toolbar - REMOVED (duplicate rule, toolbar is hidden above) */

        /* Sync Button */
        .sync-button {
            position: static;
            background: linear-gradient(135deg, #55B5B8 0%, #4A9FA2 100%);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(85, 181, 184, 0.3);
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .sync-button:hover {
            background: linear-gradient(135deg, #4A9FA2 0%, #3D8D90 100%);
            box-shadow: 0 4px 12px rgba(85, 181, 184, 0.4);
            transform: translateY(-1px);
        }
        
        .sync-button:active {
            transform: translateY(0);
        }
        
        .sync-button.syncing {
            opacity: 0.7;
            cursor: wait;
        }
        
        .sync-button.syncing svg {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Sync Report Modal */
        .sync-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .sync-report-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
        }
        
        .sync-report-header {
            background: linear-gradient(135deg, #55B5B8 0%, #4A9FA2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sync-report-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sync-report-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        
        .sync-report-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-report-body {
            padding: 24px;
        }
        
        .sync-report-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .sync-stat-card {
            background: #F5F5F5;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .sync-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .sync-stat-icon.confirmed {
            background: #E8F5E9;
            color: #43A047;
        }
        
        .sync-stat-icon.dismissed {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .sync-stat-icon.pending {
            background: #FFF9C4;
            color: #F57C00;
        }
        
        .sync-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        
        .sync-stat-label {
            font-size: 13px;
            color: #757575;
            font-weight: 500;
        }
        
        .sync-report-section {
            margin-bottom: 24px;
        }
        
        .sync-report-section-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-gap-item {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .sync-gap-item.confirmed {
            border-left: 4px solid #43A047;
            background: #F1F8F4;
        }
        
        .sync-gap-item.dismissed {
            border-left: 4px solid #C62828;
            background: #FFF5F5;
        }
        
        .sync-gap-item.pending {
            border-left: 4px solid #F57C00;
            background: #FFFBF0;
        }
        
        .sync-gap-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .sync-gap-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .sync-gap-code {
            font-size: 12px;
            color: #757575;
        }
        
        .sync-gap-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .sync-gap-badge.confirmed {
            background: #43A047;
            color: white;
        }
        
        .sync-gap-badge.dismissed {
            background: #C62828;
            color: white;
        }
        
        .sync-gap-badge.pending {
            background: #F57C00;
            color: white;
        }
        
        .sync-gap-documentation {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .sync-gap-doc-label {
            font-size: 11px;
            font-weight: 600;
            color: #757575;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .sync-gap-doc-text {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
        }

    </style>
</head>
<body>
    <!-- ATHENA PANEL -->
    <div class="athena-panel">
        <div class="athena-header">
            <div class="athena-logo">
                <span>athena</span><span>One</span>
            </div>
            <div class="athena-actions">
                <button class="btn-save">Save Draft</button>
                <button class="btn-sign">Sign & Close</button>
            </div>
        </div>
        
        <div class="patient-banner">
            <div class="patient-info">
                <strong>Doe, Jane</strong>
                <span>68 y/o F  DOB: 05/27/1955  MRN: 202070</span>
            </div>
        </div>
        
        <div class="athena-body">
            <nav class="athena-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Patient Chart</div>
                    <div class="nav-item" data-section="visit-summary">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2.5" y="2" width="11" height="13" rx="2" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M6 2V1.5C6 1.22386 6.22386 1 6.5 1H9.5C9.77614 1 10 1.22386 10 1.5V2" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="5.5" y1="6" x2="10.5" y2="6" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5.5" y1="9" x2="10.5" y2="9" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5.5" y1="12" x2="8.5" y2="12" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
</svg></span>
                        <span>Visit Summary</span>
                    </div>
                    <div class="nav-item" data-section="problems">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M9.5 1.5H4C3.44772 1.5 3 1.94772 3 2.5V13.5C3 14.0523 3.44772 14.5 4 14.5H10.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9.5 1.5V4.5C9.5 4.77614 9.72386 5 10 5H13" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9.5 1.5L13 5V9" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M10 14.5L14 10.5L12.5 9L8.5 13V14.5H10Z" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg></span>
                        <span>Problems</span>
                        <span class="badge" id="problems-badge" style="display:none;">0</span>
                    </div>
                    <div class="nav-item" data-section="medications">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="4" y="1.5" width="8" height="13" rx="4" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="4" y1="8" x2="12" y2="8" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
</svg></span>
                        <span>Medications</span>
                    </div>
                    <div class="nav-item" data-section="labs">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6 1.5V10L4 13C3.5 14 4.2 15 5.5 15H10.5C11.8 15 12.5 14 12 13L10 10V1.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="5" y1="1.5" x2="11" y2="1.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="6" y1="10" x2="10" y2="10" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/>
</svg></span>
                        <span>Labs</span>
                    </div>
                    <div class="nav-item" data-section="questionnaires">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2" y="9" width="3" height="5.5" rx="0.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <rect x="6.5" y="4" width="3" height="10.5" rx="0.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <rect x="11" y="6.5" width="3" height="8" rx="0.5" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg></span>
                        <span>Questionnaires</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Value-Based Care</div>
                    <div class="nav-item" data-section="quality-measures">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M8 1.5L9.8 5.9L14.5 6.3L10.9 9.5L12 14.1L8 11.6L4 14.1L5.1 9.5L1.5 6.3L6.2 5.9L8 1.5Z" stroke="#582c83" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg></span>
                        <span>Quality Measures</span>
                        <span class="badge" id="quality-badge" style="display:none;">0</span>
                    </div>
                    <div class="nav-item" data-section="care-gaps">
                        <span class="icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="8" cy="8" r="6.5" stroke="#582c83" stroke-width="1.5"/>
  <circle cx="8" cy="8" r="3.5" stroke="#582c83" stroke-width="1.5"/>
  <circle cx="8" cy="8" r="1" fill="#582c83"/>
</svg></span>
                        <span>Care Gaps</span>
                    </div>
                </div>
            </nav>
            
            <div class="athena-content" id="athena-content">
                <!-- SUBJECTIVE Section -->
                <div class="soap-section" id="section-subjective">
                    <div class="soap-header">
                        SUBJECTIVE
                        <span class="section-badge">HPI / ROS</span>
                    </div>
                    <div class="soap-content">
                        <div id="subjective-staged"></div>
                        <p style="font-size: 13px; color: #616161; line-height: 1.6;">
                            <strong>Chief Complaint:</strong> Post-hospital discharge follow-up (TCM call)<br><br>
                            <strong>HPI:</strong> 68 y/o female with history of hypertension, type 2 diabetes, and CKD Stage 3a was discharged from St. Joseph's Hospital this morning (February 15, 2026) following admission for acute myocardial infarction (heart attack). Patient underwent cardiac catheterization with stent placement. Discharge medications include Metoprolol succinate 50mg daily, Clopidogrel 75mg daily, Atorvastatin 80mg at bedtime, Lisinopril 20mg daily, and Aspirin 81mg daily. Patient reports feeling "okay, just a little tired and nervous about being home." Denies chest pain at rest. Reports mild shortness of breath with ambulation to bathroom, which is expected in early MI recovery. Patient confirms she picked up all discharge medications and understands the regimen. Red flag education provided. PCP follow-up appointment scheduled for Monday, February 18, 2026 at 10:00 AM with Dr. Campbell.<br><br>
                            <strong>Review of Systems:</strong> As above. Patient is alert, oriented, and engaged in conversation.
                        </p>
                    </div>
                </div>
                
                <!-- OBJECTIVE Section -->
                <div class="soap-section" id="section-objective">
                    <div class="soap-header">
                        OBJECTIVE
                        <span class="section-badge">Vitals / Exam / Findings</span>
                    </div>
                    <div class="soap-content">
                        <div id="objective-staged"></div>
                        <div style="margin-bottom: 16px;">
                            <strong style="font-size: 13px; color: #424242;">Vitals:</strong>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px;">
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">BP</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #424242; margin-left: 8px;">142/88 mmHg</span>
                                </div>
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">HR</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #424242; margin-left: 8px;">76 bpm</span>
                                </div>
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">Weight</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #424242; margin-left: 8px;">198 lbs</span>
                                </div>
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">BMI</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #ef5350; margin-left: 8px;">29.3</span>
                                </div>
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">SpO2</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #424242; margin-left: 8px;">97%</span>
                                </div>
                                <div class="finding-row" style="border: none; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                                    <span style="font-size: 12px; color: #757575;">Temp</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #424242; margin-left: 8px;">98.4F</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="findings-section">
                            <strong style="font-size: 13px; color: #424242;">Screenings & Findings:</strong>
                            <div style="margin-top: 8px;" id="findings-content">
                                <div class="finding-row">
                                    <span class="finding-label">PHQ-9 Score</span>
                                    <span class="finding-value">8 (Mild)</span>
                                </div>
                                <div class="finding-row">
                                    <span class="finding-label">Morse Fall Scale</span>
                                    <span class="finding-value alert">55 (High Risk)</span>
                                </div>
                                <div class="finding-row">
                                    <span class="finding-label">Last A1c</span>
                                    <span class="finding-value alert">8.9% (12/20/2025)</span>
                                </div>
                                <div class="finding-row">
                                    <span class="finding-label">eGFR</span>
                                    <span class="finding-value alert">42 mL/min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PROBLEM LIST Section -->
                <div class="soap-section" id="section-problem-list">
                    <div class="soap-header">
                        PROBLEM LIST
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">+ Add Problem</button>
                    </div>
                    <div class="soap-content">
                        <div id="problem-list-staged"></div>
                        <div id="problem-list-active">
                            <!-- Active Problems -->
                            <div class="problem-item active">
                                <div class="problem-header">
                                    <span class="problem-status"> ACTIVE</span>
                                    <span class="problem-diagnosis">Essential Hypertension (I10)</span>
                                    <span class="hcc-badge">HCC 85</span>
                                </div>
                                <div class="problem-details">
                                    <span>Onset: 01/15/2020</span>
                                    <div class="problem-actions">
                                        <button class="btn-link-small">Edit</button>
                                        <button class="btn-link-small">Change Status</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="problem-item active">
                                <div class="problem-header">
                                    <span class="problem-status"> ACTIVE</span>
                                    <span class="problem-diagnosis">Type 2 Diabetes Mellitus with Diabetic CKD (E11.22)</span>
                                    <span class="hcc-badge">HCC 18</span>
                                    <span class="hcc-badge">HCC 136</span>
                                </div>
                                <div class="problem-details">
                                    <span>Onset: 03/10/2018</span>
                                    <div class="problem-actions">
                                        <button class="btn-link-small">Edit</button>
                                        <button class="btn-link-small">Change Status</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ASSESSMENT & PLAN Section -->
                <div class="soap-section" id="section-ap">
                    <div class="soap-header">
                        ASSESSMENT & PLAN
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">+ Add Block</button>
                    </div>
                    <div class="soap-content">
                        <div id="ap-staged"></div>
                        <div id="ap-active">
                            <!-- Active A&P Blocks will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <!-- SOCIAL HISTORY / SDOH Section -->
                <div class="soap-section" id="section-sdoh">
                    <div class="soap-header">
                        SOCIAL HISTORY
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">Edit</button>
                    </div>
                    <div class="soap-content">
                        <div id="sdoh-staged"></div>
                        
                        <div style="margin-bottom: 16px;">
                            <strong style="font-size: 13px; color: #424242;">SOCIAL DETERMINANTS OF HEALTH (SDOH)</strong>
                            <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div style="font-size: 12px;"><strong>Housing:</strong> Stable housing</div>
                                <div style="font-size: 12px;"><strong>Food Security:</strong> <span style="color: #F57C00;"> Food insecure (Z59.41)</span></div>
                                <div style="font-size: 12px;"><strong>Transportation:</strong>  Reliable</div>
                                <div style="font-size: 12px;"><strong>Financial:</strong> Moderate difficulty</div>
                                <div style="font-size: 12px;"><strong>Social Isolation:</strong> Lives alone</div>
                                <div style="font-size: 12px;"><strong>Employment:</strong> Retired</div>
                            </div>
                        </div>
                        
                        <div>
                            <strong style="font-size: 13px; color: #424242;">TOBACCO / ALCOHOL / SUBSTANCE USE</strong>
                            <div style="margin-top: 8px; font-size: 12px; line-height: 1.6;">
                                <div><strong>Tobacco:</strong> Former smoker (quit 2015)</div>
                                <div><strong>Alcohol:</strong> Occasional (1-2 drinks/week)</div>
                                <div><strong>Drugs:</strong> None</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MEDICATIONS Section -->
                <div class="soap-section" id="section-medications">
                    <div class="soap-header">
                        MEDICATIONS
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">+ Add Medication</button>
                    </div>
                    <div class="soap-content">
                        <div id="medications-staged"></div>
                        
                        <div class="med-item">
                            <div class="med-header">
                                <span class="med-name">Metoprolol Succinate 50mg</span>
                                <span class="med-sig">1 tablet daily</span>
                                <span class="adherence-badge good"> Adherent</span>
                            </div>
                            <div class="med-details">
                                <span>Last filled: 02/15/2026 (discharge)  Refills: 3 remaining  <strong style="color: #1a936f;">New post-MI medication</strong></span>
                            </div>
                        </div>
                        
                        <div class="med-item">
                            <div class="med-header">
                                <span class="med-name">Clopidogrel 75mg</span>
                                <span class="med-sig">1 tablet daily</span>
                                <span class="adherence-badge good"> Adherent</span>
                            </div>
                            <div class="med-details">
                                <span>Last filled: 02/15/2026 (discharge)  Refills: 3 remaining  <strong style="color: #1a936f;">New post-MI medication</strong></span>
                            </div>
                        </div>
                        
                        <div class="med-item">
                            <div class="med-header">
                                <span class="med-name">Atorvastatin 80mg</span>
                                <span class="med-sig">1 tablet once daily at bedtime</span>
                                <span class="adherence-badge good"> Adherent</span>
                            </div>
                            <div class="med-details">
                                <span>Last filled: 02/15/2026 (discharge)  Refills: 3 remaining  <strong style="color: #1a936f;">New post-MI medication</strong></span>
                            </div>
                        </div>
                        
                        <div class="med-item">
                            <div class="med-header">
                                <span class="med-name">Lisinopril 20mg</span>
                                <span class="med-sig">1 tablet daily</span>
                                <span class="adherence-badge good"> Adherent</span>
                            </div>
                            <div class="med-details">
                                <span>Last filled: 02/15/2026 (discharge)  Refills: 3 remaining  Continued from prior</span>
                            </div>
                        </div>
                        
                        <div class="med-item">
                            <div class="med-header">
                                <span class="med-name">Aspirin 81mg</span>
                                <span class="med-sig">1 tablet daily</span>
                                <span class="adherence-badge good"> Adherent</span>
                            </div>
                            <div class="med-details">
                                <span>Last filled: 02/15/2026 (discharge)  Refills: 3 remaining  <strong style="color: #1a936f;">New post-MI medication</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- QUALITY MEASURES Section -->
                <div class="soap-section" id="section-quality">
                    <div class="soap-header">
                        QUALITY MEASURES
                        <span class="section-badge">Care Gaps</span>
                    </div>
                    <div class="soap-content">
                        <div id="quality-staged"></div>
                        <div style="font-size: 13px; color: #616161;">
                            <strong>Open Quality Measures:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px; line-height: 1.8;">
                                <li>Colorectal Cancer Screening - Due (last 2015)</li>
                                <li>Depression Screening - Completed (PHQ-9: 8)</li>
                                <li>Fall Risk Assessment - Completed (High Risk)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- REFERRALS Section -->
                <div class="soap-section" id="section-referrals">
                    <div class="soap-header">
                        REFERRALS
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">+ Add Referral</button>
                    </div>
                    <div class="soap-content">
                        <div id="referrals-staged"></div>
                        
                        <div class="referral-item signed">
                            <div class="referral-header">
                                <span class="referral-status signed"> SIGNED</span>
                                <span class="referral-specialty">Ophthalmology - Diabetic Eye Exam</span>
                            </div>
                            <div class="referral-details">
                                <div><strong>Linked to:</strong> Type 2 Diabetes (E11.22)</div>
                                <div><strong>Signed:</strong> 02/12/2026 by Dr. Campbell</div>
                                <div><strong>Status:</strong> <span style="color: #43A047;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="1.5" y="2.5" width="11" height="10" rx="2" fill="#43A047"/>
  <rect x="1.5" y="2.5" width="11" height="3" rx="2" fill="#2E7D32"/>
  <line x1="4.5" y1="1" x2="4.5" y2="3.5" stroke="#43A047" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="9.5" y1="1" x2="9.5" y2="3.5" stroke="#43A047" stroke-width="1.5" stroke-linecap="round"/>
  <path d="M4.5 8.5L6 10L9.5 7" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Scheduled - Appt 03/15/2026 10:00 AM</span></div>
                                <div style="font-size: 11px; color: #757575; margin-top: 4px;">Updated by Florence AI on 02/13/2026</div>
                            </div>
                        </div>
                        
                        <div class="referral-item signed">
                            <div class="referral-header">
                                <span class="referral-status signed"> SIGNED</span>
                                <span class="referral-specialty">Physical Therapy - Fall Prevention</span>
                            </div>
                            <div class="referral-details">
                                <div><strong>Linked to:</strong> History of Falling (Z91.81)</div>
                                <div><strong>Signed:</strong> 02/12/2026 by Dr. Campbell</div>
                                <div><strong>Status:</strong> <span style="color: #F57C00;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#F57C00"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>Patient Declined</span></div>
                                <div style="font-size: 11px; color: #424242; margin-top: 4px;"><strong>Note:</strong> Patient re-educated on importance. Barrier: transportation. Nurse connected patient to ride service.</div>
                                <div style="font-size: 11px; color: #757575; margin-top: 4px;">Florence AI outreach: 02/13/2026 - Patient reconsidering after transportation arranged</div>
                            </div>
                        </div>
                        
                        <div class="referral-item pending">
                            <div class="referral-header">
                                <span class="referral-status pending"> PENDING</span>
                                <span class="referral-specialty">Nephrology - CKD Management</span>
                            </div>
                            <div class="referral-details">
                                <div><strong>Linked to:</strong> Chronic Kidney Disease Stage 3a (N18.31)</div>
                                <div><strong>Ordered:</strong> 02/13/2026 by Dr. Campbell</div>
                                <div><strong>Status:</strong> <span style="color: #F57C00;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2" y="2" width="10" height="11.5" rx="2" fill="#F57C00"/>
  <path d="M5.5 2V1.25C5.5 1.112 5.612 1 5.75 1H8.25C8.388 1 8.5 1.112 8.5 1.25V2" stroke="white" stroke-width="1" stroke-linecap="round"/>
  <circle cx="7" cy="8.5" r="3" stroke="white" stroke-width="1.2"/>
  <path d="M7 7V8.5L8.2 9.2" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Awaiting Signature</span></div>
                                <div style="font-size: 11px; color: #757575; margin-top: 4px;">Florence AI recommendation: eGFR 42 mL/min warrants nephrology evaluation</div>
                            </div>
                        </div>
                        
                        <div class="referral-item completed">
                            <div class="referral-header">
                                <span class="referral-status completed"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="6" fill="#43A047"/>
  <path d="M4.5 7L6.2 8.8L9.5 5.2" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>COMPLETED</span>
                                <span class="referral-specialty">Cardiology - Hypertension Management</span>
                            </div>
                            <div class="referral-details">
                                <div><strong>Linked to:</strong> Essential Hypertension (I10)</div>
                                <div><strong>Signed:</strong> 11/15/2025 by Dr. Campbell</div>
                                <div><strong>Appointment:</strong> 12/20/2025 - Completed</div>
                                <div><strong>Status:</strong> <span style="color: #2E7D32;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="6" fill="#2E7D32"/>
  <path d="M4.5 7L6.2 8.8L9.5 5.2" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Visit Completed</span></div>
                                <div style="font-size: 11px; color: #757575; margin-top: 4px;">Florence AI outreach: 12/19/2025 - Confirmed patient attended appointment</div>
                            </div>
                        </div>
                        
                        <div class="referral-item noshow">
                            <div class="referral-header">
                                <span class="referral-status noshow"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="6" fill="#C62828"/>
  <path d="M5 5L9 9" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <path d="M9 5L5 9" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
</svg>NO-SHOW</span>
                                <span class="referral-specialty">Endocrinology - Diabetes Management</span>
                            </div>
                            <div class="referral-details">
                                <div><strong>Linked to:</strong> Type 2 Diabetes (E11.22)</div>
                                <div><strong>Signed:</strong> 01/10/2026 by Dr. Campbell</div>
                                <div><strong>Appointment:</strong> 02/05/2026 - No-show</div>
                                <div><strong>Status:</strong> <span style="color: #C62828;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="7" cy="7" r="6" fill="#C62828"/>
  <path d="M5 5L9 9" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <path d="M9 5L5 9" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
</svg>Patient Did Not Attend</span></div>
                                <div style="font-size: 11px; color: #C62828; margin-top: 4px; font-weight: 600;">Florence AI outreach: 02/06/2026 - Left voicemail, awaiting callback to reschedule</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VITALS TRACKING Section -->
                <div class="soap-section" id="section-vitals">
                    <div class="soap-header">
                        VITALS TRACKING
                        <span class="section-badge">Trends & Alerts</span>
                    </div>
                    <div class="soap-content">
                        <div id="vitals-staged"></div>
                        
                        <div class="vital-trend">
                            <div class="vital-trend-header">
                                <span class="vital-name">Blood Pressure</span>
                                <span class="vital-alert warning"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#F57C00"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>Elevated</span>
                            </div>
                            <div class="vital-values">
                                <span>Today: 142/88 mmHg</span>
                                <span>Last visit: 138/82 mmHg (11/15/2025)</span>
                                <span>Trend:  Increasing</span>
                            </div>
                        </div>
                        
                        <div class="vital-trend">
                            <div class="vital-trend-header">
                                <span class="vital-name">Weight / BMI</span>
                                <span class="vital-alert warning"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#F57C00"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>Overweight</span>
                            </div>
                            <div class="vital-values">
                                <span>Today: 198 lbs (BMI 29.3)</span>
                                <span>Last visit: 195 lbs (BMI 28.8) (11/15/2025)</span>
                                <span>Trend:  Increasing</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- APPOINTMENTS Section -->
                <div class="soap-section" id="section-appointments">
                    <div class="soap-header">
                        APPOINTMENTS
                        <button class="btn-add-small" style="margin-left: auto; font-size: 12px; padding: 4px 12px;">+ Schedule Appointment</button>
                    </div>
                    <div class="soap-content">
                        <div id="appointments-staged"></div>
                        
                        <!-- Upcoming Appointments -->
                        <div class="appointment-section">
                            <div class="appointment-section-title">UPCOMING APPOINTMENTS</div>
                            
                            <div class="appointment-item">
                                <div class="appointment-header">
                                    <span class="appointment-type cca"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2" y="2" width="10" height="11" rx="2" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M5.5 2V1.25C5.5 1.112 5.612 1 5.75 1H8.25C8.388 1 8.5 1.112 8.5 1.25V2" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M7 11C7 11 4 8.5 4 7C4 6 4.8 5.5 5.5 5.5C6.1 5.5 6.7 5.9 7 6.3C7.3 5.9 7.9 5.5 8.5 5.5C9.2 5.5 10 6 10 7C10 8.5 7 11 7 11Z" stroke="#1976D2" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Annual Wellness Visit (AWV)</span>
                                    <span class="appointment-date">12/15/2026 10:00 AM</span>
                                </div>
                                <div class="appointment-details">
                                    <div><strong>Provider:</strong> Dr. Campbell</div>
                                    <div><strong>Location:</strong> Main Clinic</div>
                                    <div><strong>Status:</strong> <span class="status-badge scheduled"> Scheduled</span></div>
                                    <div style="font-size: 11px; color: #757575; margin-top: 4px;">Scheduled 11 months out per CCA protocol</div>
                                </div>
                            </div>
                            
                            <div class="appointment-item">
                                <div class="appointment-header">
                                    <span class="appointment-type specialist"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2" y="3" width="10" height="10" rx="1" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="7" y1="5.5" x2="7" y2="9.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5" y1="7.5" x2="9" y2="7.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <path d="M5 3V1.5H9V3" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Ophthalmology - Diabetic Eye Exam</span>
                                    <span class="appointment-date">03/15/2026 10:00 AM</span>
                                </div>
                                <div class="appointment-details">
                                    <div><strong>Provider:</strong> Dr. Smith (Ophthalmology)</div>
                                    <div><strong>Location:</strong> Eye Care Center</div>
                                    <div><strong>Status:</strong> <span class="status-badge scheduled"> Scheduled</span></div>
                                    <div><strong>Linked Referral:</strong> Diabetic Eye Exam (Type 2 Diabetes E11.22)</div>
                                    <div style="font-size: 11px; color: #757575; margin-top: 4px;">Updated by Florence AI on 02/13/2026</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Needed Appointments -->
                        <div class="appointment-section">
                            <div class="appointment-section-title">APPOINTMENTS NEEDED</div>
                            
                            <div class="appointment-item needed">
                                <div class="appointment-header">
                                    <span class="appointment-type followup"> Chronic Condition Follow-up</span>
                                    <span class="appointment-priority high"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#F57C00"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>Due in 4 weeks</span>
                                </div>
                                <div class="appointment-details">
                                    <div><strong>Reason:</strong> Diabetes Management - HbA1c 8.9%</div>
                                    <div><strong>Recommended:</strong> 4-6 weeks from today</div>
                                    <div><strong>Provider:</strong> Dr. Campbell</div>
                                    <div style="font-size: 11px; color: #757575; margin-top: 4px;">Florence AI recommendation based on elevated HbA1c</div>
                                </div>
                            </div>
                            
                            <div class="appointment-item needed">
                                <div class="appointment-header">
                                    <span class="appointment-type specialist"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="2" y="3" width="10" height="10" rx="1" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="7" y1="5.5" x2="7" y2="9.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="5" y1="7.5" x2="9" y2="7.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <path d="M5 3V1.5H9V3" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Nephrology Consultation</span>
                                    <span class="appointment-priority medium"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect x="1.5" y="2.5" width="11" height="10" rx="2" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <line x1="1.5" y1="5.5" x2="12.5" y2="5.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="4.5" y1="1" x2="4.5" y2="3.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="9.5" y1="1" x2="9.5" y2="3.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round"/>
</svg>Due in 8 weeks</span>
                                </div>
                                <div class="appointment-details">
                                    <div><strong>Reason:</strong> CKD Stage 3a Management (eGFR 42)</div>
                                    <div><strong>Recommended:</strong> 8-12 weeks from today</div>
                                    <div><strong>Linked Referral:</strong> Nephrology Referral for CKD Management</div>
                                    <div style="font-size: 11px; color: #757575; margin-top: 4px;">Florence AI recommendation based on eGFR decline</div>
                                </div>
                            </div>
                            
                            <div class="appointment-item needed">
                                <div class="appointment-header">
                                    <span class="appointment-type tcm"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M2 6.5L7 2L12 6.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M3.5 7.5V12C3.5 12.276 3.724 12.5 4 12.5H5.5V9.5H8.5V12.5H10C10.276 12.5 10.5 12.276 10.5 12V7.5" stroke="#1976D2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>TCM Follow-up</span>
                                    <span class="appointment-priority high"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#F57C00"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>Due in 7 days</span>
                                </div>
                                <div class="appointment-details">
                                    <div><strong>Reason:</strong> Post-Hospital Discharge Follow-up</div>
                                    <div><strong>Discharge Date:</strong> 02/06/2026</div>
                                    <div><strong>Required By:</strong> 02/20/2026 (14 days post-discharge)</div>
                                    <div><strong>Provider:</strong> Dr. Campbell</div>
                                    <div style="font-size: 11px; color: #E65100; margin-top: 4px; font-weight: 600;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M6.134 1.692C6.514 1.035 7.486 1.035 7.866 1.692L12.928 10.462C13.296 11.1 12.822 11.9 12.062 11.9H1.938C1.178 11.9 0.704 11.1 1.072 10.462L6.134 1.692Z" fill="#E65100"/>
  <line x1="7" y1="5" x2="7" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="7" cy="10" r="0.75" fill="white"/>
</svg>TCM billing requires appointment within 14 days of discharge</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PLAN Section -->
                <div class="soap-section" id="section-plan">
                    <div class="soap-header">
                        PLAN
                        <span class="section-badge">Orders / Referrals</span>
                    </div>
                    <div class="soap-content">
                        <div id="plan-staged"></div>
                        <div style="font-size: 13px; color: #616161;">
                            <strong>Existing Orders:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px; line-height: 1.8;">
                                <li>Continue Lisinopril 20mg daily</li>
                                <li>Continue Metformin 1000mg BID</li>
                                <li>Lab: Comprehensive Metabolic Panel (pending)</li>
                                <li>Lab: Hemoglobin A1c (pending)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FLORENCE PANEL -->
    <div class="florence-panel" id="florence-panel">
        <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Collapse/Expand Sidebar">
            <span id="collapse-icon"></span>
        </button>
        <div class="florence-header" style="position: relative;">
            <div style="position: absolute; top: 8px; right: 16px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; margin: 0;">
                    <input type="checkbox" id="provider-view-toggle" style="cursor: pointer;">
                    <span id="view-mode-label"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <circle cx="8" cy="5" r="3" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M2.5 14.5C2.5 11.5 4.5 9.5 8 9.5C11.5 9.5 13.5 11.5 13.5 14.5" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>Navigator View</span>
                </label>
            </div>
            <div class="florence-logo">
                <img src="https://raw.githubusercontent.com/omarzsalah1/nightingale-brand-assets/main/logos/full-logo.png" alt="NightingaleMD" style="height: 40px; width: auto;">
            </div>
            <div class="connection-status">
                <div class="connection-dot"></div>
                Connected
                <button id="sync-notif-bell" class="sync-notif-bell" onclick="clearSyncNotifications()" title="Sync notifications">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span id="sync-notif-badge" class="sync-notif-badge" style="display: none;">0</span>
                </button>
            </div>
        </div>
        <div class="florence-toolbar" id="florence-toolbar">
            <button id="sync-button" class="sync-button" onclick="performSync()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                </svg>
                Sync from athenaOne
            </button>
        </div>
        
        <div class="patient-card">
            <div class="patient-card-header">
                <div class="patient-avatar">JD</div>
                <div class="patient-details">
                    <h3>Jane Doe (68 y/o F)</h3>
                    <div class="patient-tags">
                        <span class="patient-tag risk">High Risk</span>
                        <span class="patient-tag ccm">CCM</span>
                    </div>
                    <div class="patient-mrn">MRN: 202070</div>
                </div>
                <div class="patient-action-buttons">
                    <button class="patient-action-btn" id="sync-button-relocated" onclick="performSync()">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                        </svg>
                        Sync
                    </button>
                    <button class="patient-action-btn post-visit" id="post-visit-btn-relocated" onclick="showPostVisitView()">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                        Post-Visit
                    </button>
                </div>
            </div>
            
            <!-- Workflow Buttons -->
            <div class="workflow-buttons">
                <button class="workflow-btn btn-engage" id="engage-btn" onclick="startWorkflow('engage')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                    <span class="btn-text">Engage</span>
                </button>
                <button class="workflow-btn btn-convene" id="convene-btn" onclick="startWorkflow('convene')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="overflow:hidden; flex-shrink:0;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="btn-text" style="margin-left:2px;">Convene</span>
                </button>
                <button class="workflow-btn btn-checkin" id="checkin-btn" onclick="startWorkflow('checkin')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="btn-text">Check-In</span>
                </button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="florence-tabs">
                <button class="florence-tab active" data-tab="facesheet" title="Patient overview and care gaps">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Overview</span>
                </button>
                <button class="florence-tab" data-tab="transcript" title="Real-time conversation transcript">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Transcript</span>
                </button>
                <button class="florence-tab" data-tab="documentation" title="Auto-generated clinical documentation">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>Documentation</span>
                </button>
                <button class="florence-tab" data-tab="log" title="Gap status tracking and analytics">
                    <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    <span>Analytics</span>
                </button>
            </div>
        </div>
        
        <div class="tab-content">
            <!-- Facesheet Tab -->
            <div class="tab-panel active" id="facesheet-panel">
                <div class="florence-summary">
                    <div class="summary-header" onclick="toggleSummary()">
                        <h4>Florence Summary</h4>
                        <span class="summary-toggle" id="summary-toggle"></span>
                    </div>
                    <div class="summary-content" id="summary-content">
                        Jane Doe is a 68 y/o female with HTN, T2DM, and suspected CKD Stage 3. PHQ-9 score of 18 indicates moderately severe depression. History of falling noted. Multiple diagnosis and quality gaps identified for pre-visit staging.
                    </div>
                </div>
                
                <div class="gaps-section">
                    <div class="gaps-header">
                        <div class="gaps-title">
                            <h3>Care & Diagnosis Gaps</h3>
                            <span class="gaps-count" id="gaps-count">10</span>
                        </div>
                        <button class="prework-btn">View Pre-Work Summary</button>
                    </div>
                    
                    <div class="gaps-controls">
                        <input type="text" class="search-box" placeholder="Search gaps..." id="search-input">
                        <div class="filter-row">
                            <button class="filter-btn active" data-filter="all">All (<span id="count-all">10</span>)</button>
                            <button class="filter-btn" data-filter="recapture">Recapture (<span id="count-recapture">2</span>)</button>
                            <button class="filter-btn" data-filter="suspect">Suspect (<span id="count-suspect">3</span>)</button>
                            <button class="filter-btn" data-filter="quality">Quality (<span id="count-quality">3</span>)</button>
                            <button class="filter-btn" data-filter="frailty">Frailty (<span id="count-frailty">2</span>)</button>
                        </div>
                        <div class="show-staged-row">
                            <input type="checkbox" id="show-staged">
                            <label for="show-staged">Show staged items</label>
                        </div>
                    </div>
                    
                    <div class="gaps-list" id="gaps-list">
                        <!-- Gap cards will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- Transcript Tab -->
            <div class="tab-panel" id="transcript-panel">
                <div class="transcript-container" id="transcript-container">
                    <p style="color: #a0aec0; text-align: center; padding: 40px;">
                        Click Engage, Convene, or Check-In to start a workflow.
                    </p>
                </div>
            </div>
            
            <!-- Documentation Tab -->
            <div class="tab-panel" id="documentation-panel">
                <div class="doc-container">
                    <div class="doc-header">
                        <h3 id="doc-title">Clinical Note</h3>
                        <span class="doc-badge">Auto-Generated</span>
                    </div>
                    <div class="doc-content" id="doc-content">
                        <p style="color: #a0aec0; text-align: center; padding: 40px;">
                            Documentation will appear here after completing a workflow.
                        </p>
                    </div>
                </div>
                <button class="file-btn hidden" id="file-btn" onclick="fileToEHR()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    File to EHR
                </button>
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <!-- Post-Visit Task List Overlay -->
            <div class="post-visit-overlay" id="post-visit-overlay">
                <div class="pv-header">
                    <h3>Post-Visit Task List</h3>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span class="automation-pulse">Florence Active</span>
                        <button id="run-demo-btn" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap;" onclick="runPostEncounterDemo()">&#9654; Run Demo</button>
                        <button class="pv-close" onclick="closePostVisitView()">Back to Gaps</button>
                    </div>
                </div>
                
                <div class="pv-stats" id="pv-stats">
                    <div class="pv-stat">
                        <div class="pv-stat-number green" id="pv-confirmed-count">0</div>
                        <div class="pv-stat-label">Confirmed</div>
                    </div>
                    <div class="pv-stat">
                        <div class="pv-stat-number orange" id="pv-pending-count">0</div>
                        <div class="pv-stat-label">Pending</div>
                    </div>
                    <div class="pv-stat">
                        <div class="pv-stat-number red" id="pv-dismissed-count">0</div>
                        <div class="pv-stat-label">Dismissed</div>
                    </div>
                    <div class="pv-stat">
                        <div class="pv-stat-number purple" id="pv-automated-count">0</div>
                        <div class="pv-stat-label">Automated</div>
                    </div>
                </div>
                
                <div id="pv-task-sections">
                    <!-- Task sections will be rendered dynamically -->
                </div>
                
                <!-- Communication Timeline -->
                <div class="pv-section">
                    <div class="pv-section-header">
                        Patient Communication Timeline
                        <span class="pv-count" id="comm-count">0</span>
                    </div>
                    <div class="comm-timeline" id="comm-timeline">
                        <!-- Communication items rendered dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Log Tab -->
            <div class="tab-panel" id="log-panel">
                <div class="gap-tracker-container">
                    <div class="gap-tracker-header">
                        <h3>Gap Status Tracker</h3>
                        <div class="gap-tracker-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="tracker-open">9</span>
                                <span class="stat-label">Open</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="tracker-staged">0</span>
                                <span class="stat-label">Staged</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="tracker-accepted">0</span>
                                <span class="stat-label">Accepted</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="tracker-dismissed">0</span>
                                <span class="stat-label">Dismissed</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="tracker-documented">0</span>
                                <span class="stat-label">Documented</span>
                            </div>
                        </div>
                    </div>
                    <div class="gap-tracker-list" id="gap-tracker-list">
                        <!-- Gap tracker items will be dynamically rendered here -->
                    </div>
                    
                    <!-- Dismissal Analytics Dashboard -->
                    <div class="dismissal-analytics" id="dismissal-analytics" style="display: none;">
                        <div class="analytics-header">
                            <h4>Dismissal Analytics</h4>
                            <p class="analytics-subtitle">Your feedback helps improve Florence's recommendations</p>
                        </div>
                        <div class="analytics-impact">
                            <div class="impact-icon"></div>
                            <div class="impact-text">
                                <strong id="impact-count">0</strong> recommendations improved by your feedback
                            </div>
                        </div>
                        <div class="analytics-chart">
                            <h5>Dismissals by Gap Type</h5>
                            <div class="chart-bars" id="dismissal-chart">
                                <!-- Chart bars will be dynamically rendered -->
                            </div>
                        </div>
                        <div class="analytics-reasons">
                            <h5>Top Dismissal Reasons</h5>
                            <div class="reason-list" id="dismissal-reasons">
                                <!-- Reasons will be dynamically rendered -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- STAGING MODAL -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Stage for Provider Review</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-gap-info">
                    <div class="modal-gap-title" id="modal-gap-title">Gap Title</div>
                    <div class="modal-gap-detail" id="modal-gap-detail">Gap details will appear here</div>
                </div>
                <div class="modal-destination">
                    <div class="modal-destination-label">WILL BE STAGED IN ATHENA:</div>
                    <div class="modal-destination-value" id="modal-destination">Assessment Section</div>
                </div>
                <div class="modal-note">
                    <label>Nurse Prep Note (optional):</label>
                    <textarea id="modal-note" placeholder="Add any additional context for the provider..."></textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmStaging()">Stage for MD Review</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== SYNC SOUND EFFECTS ====================
        // Professional, subtle audio feedback for sync events
        // Uses Web Audio API for instant, high-quality sounds

        class SyncSounds {
            constructor() {
                this.context = null;
                this.enabled = true;
                this.volume = 0.15; // Subtle volume (15%)
                
                // Initialize AudioContext on first user interaction (browser requirement)
                this.initializeContext();
            }
            
            initializeContext() {
                // Create AudioContext lazily to avoid browser warnings
                if (!this.context) {
                    try {
                        this.context = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.warn('Web Audio API not supported', e);
                        this.enabled = false;
                    }
                }
            }
            
            // Resume context if suspended (required by some browsers)
            async resumeContext() {
                if (this.context && this.context.state === 'suspended') {
                    await this.context.resume();
                }
            }
            
            // Play a whoosh sound for gap staging
            async playWhoosh() {
                if (!this.enabled) return;
                await this.resumeContext();
                
                const now = this.context.currentTime;
                const duration = 0.3;
                
                // Create oscillator for frequency sweep
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                // Frequency sweep from 800Hz to 300Hz (downward whoosh)
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.frequency.exponentialRampToValueAtTime(300, now + duration);
                
                // Envelope: quick attack, gentle decay
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(this.volume, now + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                oscillator.type = 'sine';
                oscillator.start(now);
                oscillator.stop(now + duration);
            }
            
            // Play a success chime for confirmations
            async playChime() {
                if (!this.enabled) return;
                await this.resumeContext();
                
                const now = this.context.currentTime;
                const duration = 0.25;
                
                // Two-tone chime: C5 (523Hz)  E5 (659Hz)
                this.playTone(523, now, 0.15, this.volume * 0.8);
                this.playTone(659, now + 0.08, 0.2, this.volume);
            }
            
            // Play a notification ding for updates
            async playDing() {
                if (!this.enabled) return;
                await this.resumeContext();
                
                const now = this.context.currentTime;
                
                // Single bright tone: A5 (880Hz)
                this.playTone(880, now, 0.15, this.volume * 0.7);
            }
            
            // Play a celebration sound for major events (File to EHR, appointments)
            async playCelebration() {
                if (!this.enabled) return;
                await this.resumeContext();
                
                const now = this.context.currentTime;
                
                // Three-tone ascending: C5  E5  G5 (major chord)
                this.playTone(523, now, 0.2, this.volume * 0.7);        // C5
                this.playTone(659, now + 0.1, 0.2, this.volume * 0.8);  // E5
                this.playTone(784, now + 0.2, 0.3, this.volume);        // G5
            }
            
            // Helper function to play a single tone
            playTone(frequency, startTime, duration, volume) {
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'sine';
                
                // Envelope: smooth attack and decay
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }
            
            // Toggle sound on/off
            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
            
            // Set volume (0.0 to 1.0)
            setVolume(level) {
                this.volume = Math.max(0, Math.min(1, level));
            }
        }

        // Initialize global sound manager
        const syncSounds = new SyncSounds();
        window.syncSounds = syncSounds; // Make globally accessible

        // Initialize AudioContext on first user interaction
        document.addEventListener('click', function initAudio() {
            syncSounds.initializeContext();
            syncSounds.resumeContext();
        }, { once: true });

        // ==================== GAP DATA ====================
        let selectedGaps = []; // For bulk gap staging
        const gaps = [
            {
                id: 1,
                type: 'recapture',
                title: 'Essential Hypertension',
                icd: 'I10',
                hcc: 'HCC 85',
                description: 'Annual recapture required. Current BP: 142/88 mmHg. On Lisinopril 20mg daily. Linked to CKD and diabetes.',
                priority: 'high',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Problem List',
                staged: true,
                stagedTime: null,
                detailsExpanded: false,
                relatedGaps: ['Type 2 Diabetes Mellitus with Diabetic CKD', 'CKD Stage 3a'],
                supportingEvidence: [
                    'BP: 142/88 mmHg (2024-01-20)',
                    'Current medications: Lisinopril 20mg daily',
                    'Previous BP readings: 145/90 (2023-12-15), 138/85 (2023-11-10)'
                ],
                clinicalRationale: 'Patient has documented hypertension with current elevated readings despite medication. Linked to diabetic CKD.',
                suggestedDocumentation: 'Essential hypertension (I10). Comorbid with Type 2 diabetes mellitus with diabetic chronic kidney disease.',
                historicalData: 'Hypertension diagnosed 2018. On Lisinopril since 2019.',
                codingNotes: 'Coding Note: Link hypertension with CKD and diabetes when comorbid',
                // Staging data
                orders: {
                    rx: { drug: 'Lisinopril', dose: '20mg', frequency: 'daily', quantity: 30, refills: 3 },
                    labs: ['BMP'],
                    referrals: []
                },
                meatText: {
                    monitor: 'Last BP: 142/88 mmHg (2024-01-20)',
                    evaluate: 'Patient reports stable blood pressure control on current medications',
                    assess: 'Controlled on current regimen. Linked to diabetic CKD',
                    treat: 'Continue Lisinopril 20mg daily. Recheck BP in 3 months. Monitor for orthostatic hypotension given fall risk.'
                }
            },
            {
                id: 2,
                type: 'recapture',
                title: 'Type 2 Diabetes Mellitus with Diabetic Chronic Kidney Disease',
                icd: 'E11.22',
                hcc: 'HCC 18',
                description: 'Patient has documented Type 2 diabetes with diabetic CKD. See related CKD Stage 3a gap.',
                priority: 'high',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Problem List',
                staged: true,
                stagedTime: null,
                detailsExpanded: false,
                relatedGaps: ['CKD Stage 3a (linked to diabetes)', 'Essential Hypertension (comorbid)'],
                supportingEvidence: [
                    'HbA1c: 8.2% (2024-01-15)',
                    'eGFR: 52 mL/min/1.73m (2024-01-15) - indicates diabetic CKD',
                    'Current medications: Metformin 1000mg BID'
                ],
                clinicalRationale: 'Patient has Type 2 diabetes with documented kidney disease (eGFR 52). Diabetic CKD diagnosis appropriate given diabetes history and declining renal function.',
                suggestedDocumentation: 'Type 2 diabetes mellitus with diabetic chronic kidney disease (E11.22). See also: Chronic kidney disease, stage 3a (N18.31). Essential hypertension (I10).',
                historicalData: 'Diabetes diagnosed 2015. CKD first noted 2022.',
                codingNotes: 'Coding Note: Link diabetes with CKD when both conditions are present and related',
                // Staging data
                orders: {
                    rx: { drug: 'Metformin', dose: '1000mg', frequency: 'BID', quantity: 60, refills: 3 },
                    labs: ['HbA1c', 'BMP'],
                    referrals: []
                },
                meatText: {
                    monitor: 'Last HbA1c: 8.2% (2024-01-15). eGFR: 52 mL/min/1.73m (2024-01-15)',
                    evaluate: 'Patient reports blood sugars running higher (fasting 140-160). Denies polyuria, polydipsia',
                    assess: 'Suboptimally controlled diabetes with diabetic CKD. A1c above target. Declining renal function',
                    treat: 'Continue Metformin 1000mg BID. Recheck HbA1c in 3 months. Monitor renal function. Consider nephrology referral.'
                }
            },
            {
                id: 3,
                type: 'suspect',
                title: 'Chronic Kidney Disease Stage 3a',
                icd: 'N18.31',
                hcc: 'HCC 138',
                description: 'eGFR 52 mL/min/1.73m (range 45-59) indicates CKD Stage 3a.',
                priority: 'high',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Add as Suspected',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                fullDescription: 'Chronic kidney disease, stage 3a. Stage 3a is defined as eGFR 45-59 mL/min/1.73m. Stage 3b is eGFR 30-44 mL/min/1.73m.',
                supportingEvidence: [
                    'eGFR: 52 mL/min/1.73m (2024-01-15)',
                    'Creatinine: 1.4 mg/dL (2024-01-15)',
                    'Previous eGFR: 55 mL/min/1.73m (2023-06-10)'
                ],
                clinicalRationale: 'Patient has consistent eGFR readings in the 45-59 range, indicating CKD Stage 3a. Linked to diabetic CKD.',
                suggestedDocumentation: 'Chronic kidney disease, stage 3a (N18.31). Linked to Type 2 diabetes mellitus with diabetic chronic kidney disease.',
                relatedGaps: ['Type 2 Diabetes Mellitus with Diabetic CKD'],
                historicalData: 'eGFR declining: 62 (2022)  55 (2023)  52 (2024)',
                codingNotes: 'Coding Note: Always specify CKD stage 3a (eGFR 45-59) or 3b (eGFR 30-44) when eGFR data is available',
                // Staging data
                orders: {
                    rx: null,
                    labs: ['BMP', 'Creatinine', 'eGFR'],
                    referrals: ['Nephrology']
                },
                meatText: {
                    monitor: 'eGFR: 52 mL/min/1.73m (2024-01-15). Creatinine: 1.4 mg/dL',
                    evaluate: 'Patient denies urinary symptoms, edema, or fatigue',
                    assess: 'CKD Stage 3a. Declining renal function trend. Linked to diabetic nephropathy',
                    treat: 'Monitor renal function every 3 months. Nephrology referral placed. Continue ACE inhibitor for renoprotection.'
                }
            },
            {
                id: 4,
                type: 'suspect',
                title: 'Major Depressive Disorder, Recurrent, Moderate',
                icd: 'F33.1',
                hcc: 'HCC 59',
                description: 'Florence AI flagged recurrent major depressive disorder based on previous episodes, but current PHQ-9 score of 8 (mild) may not support moderate severity coding.',
                priority: 'high',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Add as Suspected',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                fullDescription: 'Major depressive disorder, recurrent episode, moderate severity. Requires documentation of: (1) recurrent episodes, (2) severity level (mild/moderate/severe), (3) current episode status.',
                supportingEvidence: [
                    'PHQ-9 Score: 8 (mild) (2024-01-10)',
                    'Previous depression diagnosis: 2022, 2023',
                    'Current medications: Sertraline 100mg daily',
                    'Note: PHQ-9 of 8 is below moderate threshold (>=10)'
                ],
                clinicalRationale: 'Florence AI flagged based on historical depression diagnosis (2022, 2023). However, current PHQ-9 of 8 (mild) does not meet threshold for moderate severity (F33.1 requires PHQ-9 >=10). Physician may dismiss if clinical presentation does not support.',
                suggestedDocumentation: 'Major depressive disorder, recurrent episode, moderate (F33.1)',
                historicalData: 'First episode 2022. Recurrence 2023. Current episode 2024.',
                codingNotes: 'Coding Note: SNOMED term must match ICD-10 specificity (recurrent, moderate)',
                // Staging data
                orders: {
                    rx: { drug: 'Sertraline', dose: '100mg', frequency: 'daily', quantity: 30, refills: 3 },
                    labs: [],
                    referrals: ['Behavioral Health']
                },
                meatText: {
                    monitor: 'PHQ-9 Score: 8 (mild) (2024-01-10). Previous scores: 15 (2023), 12 (2022)',
                    evaluate: 'Patient reports feeling "a bit down" with decreased motivation. Sleep disrupted (waking 2-3x/night). Denies suicidal ideation. Current PHQ-9 of 8 suggests mild symptoms.',
                    assess: 'Historical recurrent major depressive disorder. Current PHQ-9 of 8 (mild) does not meet moderate severity threshold. Previous episodes in 2022, 2023 were moderate.',
                    treat: 'Continue Sertraline 100mg daily. Monitor symptoms. Follow-up PHQ-9 in 4 weeks. Consider behavioral health referral if symptoms worsen.'
                }
            },
            {
                id: 5,
                type: 'suspect',
                title: 'Type 2 Diabetes Mellitus with Hyperglycemia',
                icd: 'E11.65',
                hcc: 'HCC 19',
                description: 'Patient has elevated HbA1c (8.2%) and fasting glucose (156 mg/dL) consistent with hyperglycemia.',
                priority: 'medium',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Upgrade Diagnosis',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                fullDescription: 'Type 2 diabetes mellitus with hyperglycemia. Hyperglycemia is defined as elevated blood glucose levels (fasting >126 mg/dL or HbA1c >6.5%).',
                supportingEvidence: [
                    'HbA1c: 8.2% (2024-01-15)',
                    'Fasting glucose: 156 mg/dL (2024-01-20)',
                    'Current medications: Metformin 1000mg BID'
                ],
                clinicalRationale: 'Patient has elevated HbA1c and fasting glucose consistent with hyperglycemia despite current medication.',
                suggestedDocumentation: 'Type 2 diabetes mellitus with hyperglycemia (E11.65)',
                historicalData: 'Previous HbA1c: 7.8% (2023-07-15)',
                codingNotes: 'Coding Note: "Uncontrolled diabetes" is obsolete terminology. Use "with hyperglycemia" instead.',
                orders: { rx: null, labs: ['HbA1c', 'Fasting Glucose'], referrals: [] },
                meatText: { monitor: 'HbA1c: 8.2% (2024-01-15). Fasting glucose: 156 mg/dL (2024-01-20)', evaluate: 'Patient reports blood sugars running higher despite medication compliance', assess: 'Hyperglycemia. A1c above target despite current Metformin therapy', treat: 'Continue Metformin 1000mg BID. Consider adding second agent. Recheck HbA1c in 3 months. Diabetes education reinforced.' }
            },
            {
                id: 6,
                type: 'quality',
                title: 'Colorectal Cancer Screening',
                icd: null,
                hcc: null,
                description: 'Last colonoscopy in 2015. Patient is overdue for screening.',
                priority: 'medium',
                athenaSection: 'quality',
                athenaLabel: 'Quality Measures  Care Gap',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                supportingEvidence: [
                    'Last colonoscopy: 2015 (9 years ago)',
                    'Age: 68 (screening recommended every 10 years)',
                    'No family history of colorectal cancer'
                ],
                clinicalRationale: 'Patient is due for colorectal cancer screening. Last colonoscopy was 9 years ago.',
                suggestedDocumentation: 'Colorectal cancer screening recommended. Patient counseled and order placed.',
                qualityMeasure: 'HEDIS COL: Colorectal Cancer Screening',
                historicalData: 'Last colonoscopy 2015 (normal findings)',
                orders: { rx: null, labs: [], referrals: ['Gastroenterology - Colonoscopy'] },
                meatText: { monitor: 'Last colonoscopy: 2015 (9 years ago)', evaluate: 'Patient age 68. No family history of colorectal cancer. No GI symptoms', assess: 'Overdue for colorectal cancer screening per USPSTF guidelines', treat: 'Colonoscopy referral placed. Patient counseled on prep instructions. Screening due every 10 years.' }
            },
            {
                id: 7,
                type: 'quality',
                title: 'Statin Therapy for Cardiovascular Disease',
                icd: null,
                hcc: null,
                description: 'Patient with diabetes and hypertension not on statin therapy. Consider adding atorvastatin.',
                priority: 'medium',
                athenaSection: 'plan',
                athenaLabel: 'Plan  Stage Order',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                supportingEvidence: [
                    'Diabetes: Yes (Type 2 DM with diabetic CKD)',
                    'Hypertension: Yes (Essential HTN)',
                    'Age: 68',
                    'Current medications: No statin therapy'
                ],
                clinicalRationale: 'Patient meets criteria for statin therapy (diabetes + hypertension + age >65). ASCVD risk reduction indicated.',
                suggestedDocumentation: 'Statin therapy initiated for ASCVD risk reduction. Atorvastatin 20mg daily prescribed.',
                qualityMeasure: 'HEDIS SPC: Statin Therapy for Patients with Cardiovascular Disease',
                historicalData: 'No previous statin therapy',
                orders: { rx: { drug: 'Atorvastatin', dose: '20mg', frequency: 'daily', quantity: 30, refills: 3 }, labs: ['Lipid Panel'], referrals: [] },
                meatText: { monitor: 'No current statin therapy. Diabetes + Hypertension + Age 68', evaluate: 'Patient denies muscle pain or statin intolerance history', assess: 'ASCVD risk reduction indicated. Meets criteria for statin therapy', treat: 'Atorvastatin 20mg daily initiated. Lipid panel in 6 weeks. Patient counseled on benefits and side effects.' }
            },
            {
                id: 8,
                type: 'quality',
                title: 'Nephrology Referral for CKD Management',
                icd: null,
                hcc: null,
                description: 'eGFR 52 mL/min/1.73m (Stage 3a CKD) warrants nephrology evaluation for CKD management.',
                priority: 'high',
                athenaSection: 'plan',
                athenaLabel: 'Plan  Stage Referral',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                supportingEvidence: [
                    'eGFR: 52 mL/min/1.73m (Stage 3a)',
                    'Diabetic CKD present',
                    'Declining renal function trend'
                ],
                clinicalRationale: 'Nephrology referral indicated for CKD Stage 3a with diabetic nephropathy. Specialist management recommended.',
                suggestedDocumentation: 'Nephrology referral placed for CKD Stage 3a management and diabetic nephropathy.',
                historicalData: 'No previous nephrology consultation',
                orders: { rx: null, labs: [], referrals: ['Nephrology'] },
                meatText: { monitor: 'eGFR: 52 mL/min/1.73m (Stage 3a CKD)', evaluate: 'Patient denies urinary symptoms. No edema noted', assess: 'CKD Stage 3a with diabetic nephropathy. Specialist management indicated', treat: 'Nephrology referral placed for CKD management. Continue ACE inhibitor. Monitor renal function quarterly.' }
            },
            {
                id: 9,
                type: 'frailty',
                title: 'Fall Risk Assessment - High',
                icd: 'Z91.81',
                hcc: null,
                description: 'Morse Fall Scale score of 55 indicates high fall risk. History of falls noted.',
                priority: 'high',
                athenaSection: 'objective',
                athenaLabel: 'Objective  Findings',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                supportingEvidence: [
                    'Morse Fall Scale: 55 (high risk)',
                    'History of falls: 2 falls in past 6 months',
                    'Dizziness reported with position changes'
                ],
                clinicalRationale: 'Patient has high fall risk based on Morse Fall Scale and recent fall history. Fall prevention interventions indicated.',
                suggestedDocumentation: 'History of falling (Z91.81). Fall prevention plan initiated.',
                historicalData: 'Falls: December 2023, January 2024',
                orders: { rx: null, labs: [], referrals: ['Physical Therapy'] },
                meatText: { monitor: 'Morse Fall Scale: 55 (high risk). History of 2 falls in past 6 months', evaluate: 'Patient reports dizziness with position changes. Uses no assistive device', assess: 'High fall risk. History of falling. Orthostatic hypotension suspected', treat: 'Fall prevention plan initiated. PT referral for gait training and balance. Home safety assessment ordered. Patient counseled on fall prevention.' }
            },
            {
                id: 10,
                type: 'frailty',
                title: 'Comprehensive Frailty Assessment',
                icd: 'R54',
                hcc: 'HCC 161',
                description: 'Patient shows signs of frailty: fatigue, decreased activity, unintentional weight changes.',
                priority: 'medium',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Add Diagnosis',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                supportingEvidence: [
                    'Fatigue: Reported daily',
                    'Decreased activity: Walking distance reduced by 50%',
                    'Weight loss: 8 lbs in 3 months (unintentional)'
                ],
                clinicalRationale: 'Patient meets criteria for frailty syndrome based on fatigue, decreased activity, and unintentional weight loss.',
                suggestedDocumentation: 'Age-related physical debility (R54)',
                historicalData: 'Weight: 253 lbs (2023-10)  245 lbs (2024-01)',
                orders: { rx: null, labs: ['Albumin', 'Prealbumin'], referrals: ['Nutrition'] },
                meatText: { monitor: 'Weight loss: 8 lbs in 3 months (unintentional). BMI declining', evaluate: 'Patient reports daily fatigue. Walking distance reduced by 50%. Decreased activity level', assess: 'Frailty syndrome. Unintentional weight loss, fatigue, decreased mobility', treat: 'Nutrition referral placed. Labs ordered to assess nutritional status. Home health evaluation for ADL support.' }
            },
            {
                id: 11,
                type: 'suspect',
                title: 'Morbid Obesity with Obstructive Sleep Apnea',
                icd: 'E66.01',
                hcc: 'HCC 22',
                priority: 'high',
                description: 'BMI 36 (morbid obesity range 35-39.9) with documented comorbid obstructive sleep apnea.',
                athenaSection: 'assessment',
                athenaLabel: 'Assessment  Add as Suspected',
                staged: false,
                stagedTime: null,
                detailsExpanded: false,
                fullDescription: 'Morbid (severe) obesity due to excess calories, BMI 35-39.9. For HCC capture with BMI 35-39.9, must document a comorbid condition: osteoarthritis, sleep apnea, diabetes, hypertension, or hyperlipidemia. Note: BMI 40 qualifies as E66.01 without comorbid condition.',
                supportingEvidence: [
                    'BMI: 36 (2024-01-20)',
                    'Weight: 237 lbs, Height: 5\'7"',
                    'Comorbid condition: Obstructive Sleep Apnea (documented, on CPAP)',
                    'Sleep study: AHI 22 events/hour (moderate OSA) - 09/2024'
                ],
                clinicalRationale: 'Patient meets criteria for morbid obesity (BMI 35-39.9) with documented comorbid obstructive sleep apnea, qualifying for HCC 22 capture. Note: At BMI 36, a comorbid condition is required. Sleep apnea is documented with AHI 22.',
                suggestedDocumentation: 'Morbid (severe) obesity due to excess calories, BMI 35-39.9, with comorbid obstructive sleep apnea (E66.01). Sleep apnea documented: AHI 22, on CPAP therapy.',
                relatedGaps: ['Obstructive Sleep Apnea (G47.33)'],
                historicalData: 'BMI has been >35 since 2022. Diabetes diagnosed 2015.',
                codingNotes: 'Coding Note: Morbid obesity (BMI 35-39.9) requires documented comorbid condition for HCC capture. Sleep apnea qualifies. At BMI 40, no comorbid condition needed (code directly to E66.01).',
                orders: { rx: null, labs: [], referrals: ['Nutrition'] },
                meatText: { monitor: 'BMI: 36 (morbid obesity range 35-39.9). Weight: 237 lbs. CPAP compliance: 78%', evaluate: 'Patient reports difficulty with weight management. Uses CPAP nightly for obstructive sleep apnea (AHI 22). Reports daytime fatigue improving with CPAP', assess: 'Morbid obesity (BMI 36) with comorbid obstructive sleep apnea. BMI 36 with sleep apnea qualifies for E66.01 per CMS guidelines', treat: 'Nutrition referral for weight management counseling. Continue CPAP therapy. Discussed diet, exercise, and behavioral modifications. Consider bariatric surgery consultation if lifestyle modifications ineffective.' }
            }
        ];
        
        // ==================== WORKFLOW SCRIPTS ====================
        const scripts = {
            engage: [
                { type: 'system', text: 'Florence initiating TCM outreach call to Jane Doe...' },
                { type: 'system', text: ' Call connected' },
                { type: 'florence', text: "Hello Jane, this is Florence calling from Dr. Campbell's office. I see here that you were released from St. Joseph's Hospital this morning after your heart attack. How are you feeling?" },
                { type: 'patient', text: "Oh hello Florence. I'm doing okay, just a little tired and nervous about being home." },
                { type: 'florence', text: "That's completely understandable, Jane. I'm here to help make sure you have everything you need. First, let me ask - did you pick up all your new medications from the pharmacy?" },
                { type: 'patient', text: "Yes, my daughter helped me get them this afternoon." },
                { type: 'florence', text: "Wonderful! Let me quickly review them with you to make sure we're on the same page. You should have Metoprolol for your heart rate, Clopidogrel to prevent blood clots, and Atorvastatin for cholesterol. Do you have all three of those?" },
                { type: 'patient', text: "Yes, I have them all here. The pharmacist explained them to me." },
                { type: 'florence', text: "Perfect. Now this is very important, Jane - the hospital should have given you a scale to weigh yourself daily. Have you been weighing yourself?" },
                { type: 'patient', text: "Yes, I weighed myself this morning. I was 198 pounds." },
                { type: 'florence', text: "Good! Here's what you need to watch for: if you gain 2 pounds in one day, or 5 pounds in one week, you need to call us immediately. That could be a sign of fluid buildup. Can you remember that? 2 pounds in a day, or 5 pounds in a week." },
                { type: 'patient', text: "2 pounds in a day, 5 pounds in a week. I wrote it down." },
                { type: 'florence', text: "Excellent! Now, have you had any chest pain, shortness of breath, or swelling in your legs since you got home?" },
                { type: 'patient', text: "No chest pain, but I do feel a little short of breath when I walk to the bathroom." },
                { type: 'florence', text: "That's normal in the first few days after a heart attack, but we'll want Dr. Campbell to check that at your follow-up visit. Speaking of which, let me get you scheduled. Dr. Campbell needs to see you within the next few days. Let me conference in the office right now to find you an appointment. Can you hold for just a moment?" },
                { type: 'patient', text: "Yes, of course." },
                { type: 'system', text: ' Connecting to Dr. Campbell\'s office...' },
                { type: 'system', text: ' 3-way call initiated' },
                { type: 'care-manager', text: "This is Sarah at Dr. Campbell's office, how can I help?" },
                { type: 'florence', text: "Hi Sarah, this is Florence. I have Jane Doe on the line - she was discharged from St. Joseph's this morning after an MI. We need to get her in for a post-discharge follow-up as soon as possible." },
                { type: 'care-manager', text: "Of course! Let me check the schedule. I have Monday at 10am or 2pm. Which works better for you, Jane?" },
                { type: 'patient', text: "Monday at 10am would be perfect." },
                { type: 'care-manager', text: "Great! You're all set for Monday, February 18th at 10am with Dr. Campbell. We'll see you then, Jane." },
                { type: 'florence', text: "Perfect! Jane, you're scheduled for Monday at 10am. I'll send you a text reminder the day before. Is there anything else you're worried about or any questions I can answer?" },
                { type: 'patient', text: "No, I think that covers everything. Thank you so much for calling and helping me get that appointment." },
                { type: 'florence', text: "You're very welcome, Jane. Remember - if you have any chest pain, severe shortness of breath, or sudden weight gain, call 911 right away. Otherwise, we'll see you Monday at 10am. Take care!" },
                { type: 'patient', text: "Thank you, Florence. Goodbye." },
                { type: 'system', text: ' Call ended  Duration: 4:32' }
            ],
            convene: [
                { type: 'system', text: 'Florence initiating Convene call...' },
                { type: 'system', text: ' Calling Jane...' },
                { type: 'system', text: ' Jane connected' },
                { type: 'florence', text: "Hello Jane, this is Florence calling from Cunningham Medical Group. Are you ready for your meeting with your care manager?" },
                { type: 'patient', text: "Yes, I'm ready." },
                { type: 'florence', text: "Great! Let me patch you in with Sarah Martinez now." },
                { type: 'system', text: ' Connecting Sarah Martinez...' },
                { type: 'system', text: ' Sarah Martinez joined' },
                { type: 'care-manager', text: "Hi Jane, this is Sarah Martinez, your care manager. How are you feeling today?" },
                { type: 'patient', text: "Hi Sarah, I'm doing better, thank you." },
                { type: 'care-manager', text: "That's wonderful to hear. I wanted to review your medications with you. I see you're on Bumetanide now for fluid management. How is that going?" },
                { type: 'patient', text: "It's going well. I'm taking it in the morning like they told me." },
                { type: 'care-manager', text: "Excellent. And your Lisinopril was increased. Any dizziness or side effects?" },
                { type: 'patient', text: "No, I feel fine." },
                { type: 'care-manager', text: "Perfect. Keep monitoring your weight daily and call us if you gain more than 3 pounds in a day." },
                { type: 'patient', text: "I will, thank you." },
                { type: 'care-manager', text: "Take care, Jane. Florence will wrap things up with you." },
                { type: 'system', text: ' Sarah Martinez left' },
                { type: 'florence', text: "Jane, that was a great check-in with Sarah. To summarize: Continue taking your Bumetanide in the morning, keep monitoring your weight daily, and you have your follow-up with Dr. Chen on Thursday at 10 AM. If you experience any shortness of breath, chest pain, or rapid weight gain, call us immediately. Do you have any questions?" },
                { type: 'patient', text: "No, I think I'm all set. Thank you, Florence." },
                { type: 'florence', text: "You're welcome, Jane. Remember, you can call me anytime if you need anything. Take care!" },
                { type: 'system', text: ' Call ended  Duration: 2:45' }
            ],
            checkin: [
                { type: 'system', text: 'Florence initiating automated Check-In with Jane Doe...' },
                { type: 'system', text: ' SMS sent to (555) 202-0700' },
                { type: 'florence', text: "Hi Jane, this is Florence from your doctor's office. Quick check-in! How are you feeling today? Reply 1 for Good, 2 for Okay, 3 for Not well." },
                { type: 'patient', text: "2" },
                { type: 'florence', text: "Thanks for letting me know you're feeling okay. Have you taken all your medications today? Reply YES or NO." },
                { type: 'patient', text: "YES" },
                { type: 'florence', text: "Great job staying on track! What was your fasting blood sugar this morning? Please reply with the number." },
                { type: 'patient', text: "156" },
                { type: 'florence', text: "Thank you! I've recorded 156 mg/dL. That's a bit elevated - remember to watch your carbs. Any dizziness or falls today? Reply YES or NO." },
                { type: 'patient', text: "NO" },
                { type: 'florence', text: "Wonderful! Your check-in is complete. Remember, your appointment is coming up soon. Reply HELP anytime if you need assistance. Have a great day, Jane! " },
                { type: 'system', text: ' Check-In completed  5 responses collected' }
            ]
        };
        
        const documentation = {
            engage: {
                title: 'Care Manager\'s Note',
                content: `
                    <div class="doc-section">
                        <h4>Call Date/Time</h4>
                        <p>February 15, 2026 at 2:15 PM  Duration: 4:32</p>
                    </div>
                    <div class="doc-section">
                        <h4>Discharge Information</h4>
                        <ul>
                            <li><strong>Hospital:</strong> St. Joseph's Hospital</li>
                            <li><strong>Discharge Date:</strong> February 15, 2026 (this morning)</li>
                            <li><strong>Diagnosis:</strong> Acute Myocardial Infarction (Heart Attack)</li>
                            <li><strong>Procedure:</strong> Cardiac catheterization with stent placement</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Patient Status</h4>
                        <p>Patient reports feeling "okay, just a little tired and nervous about being home." No chest pain at rest. 
                        Mild shortness of breath with ambulation (walking to bathroom), which is expected in early post-MI recovery. 
                        Patient is alert, oriented, and engaged in conversation.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Medication Reconciliation</h4>
                        <p><strong>Confirmed patient picked up and has all discharge medications:</strong></p>
                        <ul>
                            <li>Metoprolol succinate 50mg once daily (heart rate control)</li>
                            <li>Clopidogrel 70mg once daily (antiplatelet/blood clot prevention)</li>
                            <li>Atorvastatin 80mg once daily at bedtime (cholesterol)</li>
                            <li>Lisinopril 10mg once daily (blood pressure)</li>
                            <li>Furosemide 45mg once daily (fluid management)</li>
                            <li>Aspirin 81mg once daily (antiplatelet)</li>
                            <li>Metformin 1000mg twice daily with meals (diabetes)</li>
                        </ul>
                        <p><strong>Patient Education:</strong> Pharmacist reviewed all medications with patient. Patient demonstrates understanding of medication regimen.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Vital Signs / Home Monitoring</h4>
                        <ul>
                            <li><strong>Weight:</strong> 198 lbs (patient weighed this morning)</li>
                            <li><strong>Weight Monitoring Education Provided:</strong> Patient instructed to call immediately if weight gain of 2 lbs in one day OR 5 lbs in one week (signs of fluid retention/heart failure)</li>
                            <li><strong>Patient Comprehension:</strong> Patient repeated back "2 pounds in a day, 5 pounds in a week" and wrote it down</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Red Flags / Symptoms Monitored</h4>
                        <p><strong>Assessed for post-MI warning signs:</strong></p>
                        <ul>
                            <li><strong>Chest Pain:</strong> None reported </li>
                            <li><strong>Shortness of Breath:</strong> Mild with ambulation (expected in early recovery)</li>
                            <li><strong>Leg Swelling:</strong> None reported </li>
                        </ul>
                        <p><strong>Patient Education:</strong> Instructed to call 911 immediately for any chest pain, severe shortness of breath, or sudden weight gain.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Follow-Up Plan</h4>
                        <p><strong>PCP Appointment Scheduled:</strong></p>
                        <ul>
                            <li><strong>Date/Time:</strong> Monday, February 18, 2026 at 10:00 AM</li>
                            <li><strong>Provider:</strong> Dr. Campbell</li>
                            <li><strong>Scheduling Method:</strong> 3-way call with Dr. Campbell's office (Sarah Martinez, Care Manager)</li>
                            <li><strong>Patient Preference:</strong> Patient selected 10am appointment over 2pm option</li>
                            <li><strong>Reminder:</strong> Florence will send text reminder the day before</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Next Steps</h4>
                        <ul>
                            <li> TCM call completed within required timeframe (day of discharge)</li>
                            <li> Medication reconciliation completed</li>
                            <li> Patient education provided (weight monitoring, red flags)</li>
                            <li> PCP follow-up appointment scheduled for Monday, 2/18/26 at 10am</li>
                            <li> Text reminder to be sent Sunday, 2/17/26</li>
                            <li> Care gaps to be staged for Monday visit (CKD, depression screening, fall risk)</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Care Manager Notes</h4>
                        <p>Patient is appropriate for discharge home. Support system in place (daughter assisted with pharmacy pickup). 
                        Patient demonstrates good understanding of post-MI care requirements. No immediate concerns. Will monitor for 
                        appointment attendance and follow up as needed.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Documented By</h4>
                        <p>Florence AI Navigator  Care Manager: Sarah Martinez, RN  Date: 2/15/2026</p>
                    </div>
                `
            },
            convene: {
                title: 'Convene Session Note',
                content: `
                    <div class="doc-section">
                        <h4>Encounter Type</h4>
                        <p>3-Way Convene Call  Duration: 2:45</p>
                    </div>
                    <div class="doc-section">
                        <h4>Participants</h4>
                        <ul>
                            <li>Patient: Jane Doe</li>
                            <li>Care Manager: Sarah Martinez</li>
                            <li>AI Navigator: Florence</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Discussion Summary</h4>
                        <p>Care coordination call to review medications following recent hospital discharge. 
                        Patient reports feeling better and is compliant with new medication regimen.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Medication Review</h4>
                        <ul>
                            <li>Bumetanide - Patient taking in morning as directed, tolerating well</li>
                            <li>Lisinopril (increased dose) - No dizziness or side effects reported</li>
                            <li>Daily weight monitoring discussed - alert if gain &gt;3 lbs/day</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Care Plan</h4>
                        <ul>
                            <li>Continue Bumetanide in the morning for fluid management</li>
                            <li>Continue daily weight monitoring - call if gain &gt;3 lbs/day</li>
                            <li>Follow-up with Dr. Chen on Thursday at 10 AM</li>
                            <li>Call immediately if shortness of breath, chest pain, or rapid weight gain</li>
                        </ul>
                    </div>
                `
            },
            checkin: {
                title: 'Automated Check-In Summary',
                content: `
                    <div class="doc-section">
                        <h4>Encounter Type</h4>
                        <p>SMS Check-In  5 responses collected</p>
                    </div>
                    <div class="doc-section">
                        <h4>Patient Status</h4>
                        <ul>
                            <li>Overall feeling: Okay (2/3)</li>
                            <li>Medication adherence: Yes - all medications taken</li>
                            <li>Dizziness/falls today: None reported</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Vitals Collected</h4>
                        <ul>
                            <li>Fasting Blood Sugar: 156 mg/dL (elevated)</li>
                            <li>Trend: Consistent with reported home monitoring</li>
                        </ul>
                    </div>
                    <div class="doc-section">
                        <h4>Risk Assessment</h4>
                        <p>Blood sugar remains elevated but patient is medication compliant. 
                        No acute symptoms reported. Continue monitoring.</p>
                    </div>
                    <div class="doc-section">
                        <h4>Next Steps</h4>
                        <ul>
                            <li>Continue daily automated check-ins</li>
                            <li>Flag elevated blood sugars for provider review</li>
                            <li>Upcoming appointment reminder sent</li>
                        </ul>
                    </div>
                `
            }
        };
        
        // ==================== STATE VARIABLES ====================
        let currentFilter = 'all';
        let showStaged = false;
        let currentGapId = null;
        let currentWorkflow = null;
        let lastCompletedWorkflow = null;
        let isWorkflowInProgress = false;
        let abortController = null;
        
        // ==================== SIDEBAR COLLAPSE TOGGLE ====================
        function toggleSidebarCollapse() {
            const panel = document.getElementById('florence-panel');
            const icon = document.getElementById('collapse-icon');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                icon.textContent = ''; // Left arrow
                localStorage.setItem('florence-sidebar-collapsed', 'false');
            } else {
                panel.classList.add('collapsed');
                icon.textContent = ''; // Right arrow
                localStorage.setItem('florence-sidebar-collapsed', 'true');
            }
        }
        
        // ==================== SMART AUTO-HIDE HEADER ====================
        let lastScrollTop = 0;
        let scrollTimeout = null;
        
        function setupSmartAutoHide() {
            const tabContent = document.querySelector('.tab-content');
            const header = document.querySelector('.florence-header');
            const patientCard = document.querySelector('.patient-card');
            
            if (!tabContent || !header || !patientCard) return;
            
            tabContent.addEventListener('scroll', () => {
                const scrollTop = tabContent.scrollTop;
                
                // Clear previous timeout
                if (scrollTimeout) clearTimeout(scrollTimeout);
                
                // Only auto-hide if scrolled down more than 50px
                if (scrollTop > 50) {
                    if (scrollTop > lastScrollTop) {
                        // Scrolling down - hide header
                        header.classList.add('auto-hidden');
                        patientCard.classList.add('auto-hidden');
                    } else {
                        // Scrolling up - show header
                        header.classList.remove('auto-hidden');
                        patientCard.classList.remove('auto-hidden');
                    }
                } else {
                    // Near top - always show header
                    header.classList.remove('auto-hidden');
                    patientCard.classList.remove('auto-hidden');
                }
                
                lastScrollTop = scrollTop;
            });
        }
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            renderGaps();
            updateCounts();
            setupEventListeners();
            setupSmartAutoHide();
            
            // Restore sidebar collapse state from localStorage
            const isCollapsed = localStorage.getItem('florence-sidebar-collapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('florence-panel').classList.add('collapsed');
                document.getElementById('collapse-icon').textContent = '';
            }
            
            // Initialize workflow buttons as hidden (Overview tab is default)
            const workflowButtons = document.querySelector('.workflow-buttons');
            const postVisitBtn = document.getElementById('post-visit-btn-relocated');
            if (workflowButtons) workflowButtons.classList.add('hidden');
            if (postVisitBtn) postVisitBtn.style.display = 'none';
        });
        
        function setupEventListeners() {
            // Filter buttons (v7 fix: event delegation)
            const filterContainer = document.querySelector('.filter-row');
            if (filterContainer) {
                filterContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.filter-btn') || e.target.closest('.filter-btn')) {
                        const btn = e.target.matches('.filter-btn') ? e.target : e.target.closest('.filter-btn');
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentFilter = btn.dataset.filter;
                        renderGaps();
                    }
                });
            }
            
            // Show staged checkbox
            document.getElementById('show-staged').addEventListener('change', (e) => {
                showStaged = e.target.checked;
                renderGaps();
            });
            
            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                renderGaps(e.target.value.toLowerCase());
            });
            
            // Nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    scrollToSection(section);
                });
            });
            
            // Tab switching
            document.querySelectorAll('.florence-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchToTab(tab.dataset.tab);
                });
            });

            // Provider view toggle
            const providerToggle = document.getElementById('provider-view-toggle');
            const viewModeLabel = document.getElementById('view-mode-label');
            if (providerToggle) {
                providerToggle.addEventListener('change', function(e) {
                    console.log('Provider toggle changed:', e.target.checked);
                    if (e.target.checked) {
                        document.body.classList.add('provider-view');
if (viewModeLabel) viewModeLabel.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 1.5V2.5C4 5.5 5.5 7 8 7C10.5 7 12 5.5 12 2.5V1.5" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7V10C8 12 6.5 13.5 4.5 13.5C3 13.5 2 12.5 2 11" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12.5" cy="9" r="1.5" stroke="#333333" stroke-width="1.5"/><path d="M12.5 7.5V5" stroke="#333333" stroke-width="1.5" stroke-linecap="round"/><circle cx="4" cy="1.5" r="0.75" fill="#333333"/><circle cx="12" cy="2.5" r="0.75" fill="#333333"/></svg>Provider View';
                        console.log('Provider view enabled');
                    } else {
                        document.body.classList.remove('provider-view');
                        if (viewModeLabel) viewModeLabel.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="5" r="3" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.5 14.5C2.5 11.5 4.5 9.5 8 9.5C11.5 9.5 13.5 11.5 13.5 14.5" stroke="#333333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Navigator View';
                        console.log('Navigator view enabled');
                    }
                });
            }
            
            // Attestation checkbox delegation
            document.getElementById('gaps-list').addEventListener('change', function(e) {
                if (e.target.dataset.attestType) {
                    const gapId = parseInt(e.target.dataset.gapId);
                    const attestType = e.target.dataset.attestType;
                    const gap = gaps.find(g => g.id === gapId);
                    if (gap && e.target.checked) {
                        handleAttestation(gap, attestType);
                    }
                }
            });
            
            // Handle attestation actions
            function handleAttestation(gap, attestType) {
                console.log(`Attestation: ${attestType} for gap ${gap.id}`);
                
                const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const attestationLabels = {
                    monitored: ' Monitored',
                    rx: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="10" height="6" rx="3" stroke="white" stroke-width="1.5"/><line x1="8" y1="5" x2="8" y2="11" stroke="white" stroke-width="1.5"/></svg> Rx',
                    labs: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 2H11V10C11 11.6569 9.65685 13 8 13C6.34315 13 5 11.6569 5 10V2Z" stroke="white" stroke-width="1.5"/><line x1="5" y1="2" x2="11" y2="2" stroke="white" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="8" x2="11" y2="8" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg> Labs',
                    referred: '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="2" width="8" height="11" stroke="white" stroke-width="1.5"/><path d="M7 4V8M5 6H9" stroke="white" stroke-width="1.5" stroke-linecap="round"/><rect x="5" y="10" width="1.5" height="3" fill="white"/><rect x="7.5" y="10" width="1.5" height="3" fill="white"/></svg> Referred'
                };
                
                // Create log entry for Monitored and Referred
                if (attestType === 'monitored' || attestType === 'referred') {
                    addLogEntry(
                        `Provider Attestation: ${attestationLabels[attestType]}`,
                        `${gap.title} (${gap.code}) - Provider attested: ${attestationLabels[attestType]}`,
                        'just now'
                    );
                }
                
                // Update documentation for Rx
                if (attestType === 'rx') {
                    addToDocumentation(
                        'Medications',
                        `${gap.title} (${gap.code}) - Medication prescribed/reviewed for this condition. Documented ${timestamp}.`
                    );
                }
                
                // Update both log and documentation for Labs
                if (attestType === 'labs') {
                    addLogEntry(
                        `Labs Ordered: ${gap.title}`,
                        `Labs ordered/reviewed for ${gap.title} (${gap.code})`,
                        'just now'
                    );
                    addToDocumentation(
                        'Labs',
                        `${gap.title} (${gap.code}) - Labs ordered/reviewed for this condition. Documented ${timestamp}.`
                    );
                }
                
                // Show toast notification
                showToast(` Attestation recorded: ${attestationLabels[attestType]} for ${gap.title}`);
            }
            
            // Add entry to log
            function addLogEntry(title, description, time) {
                const logContainer = document.getElementById('log-container');
                if (!logContainer) {
                    console.error('Log container not found');
                    return;
                }
                
                const entry = document.createElement('div');
                entry.className = 'log-item';
                entry.innerHTML = `
                    <div class="log-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                    </div>
                    <div class="log-content">
                        <h4>${title}</h4>
                        <p>${description}</p>
                    </div>
                    <span class="log-time">${time}</span>
                `;
                
                // Insert at the top
                if (logContainer.children.length > 0) {
                    logContainer.insertBefore(entry, logContainer.children[0]);
                } else {
                    logContainer.appendChild(entry);
                }
                console.log('Log entry added:', title);
            }
            
            // Add entry to documentation
            function addToDocumentation(section, text) {
                const docPanel = document.getElementById('documentation-panel');
                if (!docPanel) return;
                
                // Find or create the section
                let sectionDiv = null;
                const sections = docPanel.querySelectorAll('.doc-section');
                for (let s of sections) {
                    const header = s.querySelector('h4');
                    if (header && header.textContent === section) {
                        sectionDiv = s;
                        break;
                    }
                }
                
                if (!sectionDiv) {
                    sectionDiv = document.createElement('div');
                    sectionDiv.className = 'doc-section';
                    sectionDiv.innerHTML = `<h4>${section}</h4><ul></ul>`;
                    docPanel.appendChild(sectionDiv);
                }
                
                // Add the text as a list item
                const ul = sectionDiv.querySelector('ul');
                if (ul) {
                    const li = document.createElement('li');
                    li.textContent = text;
                    ul.appendChild(li);
                }
            }
            
            // Show toast notification
            function showToast(message) {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #55B5B8;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-size: 14px;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;
                
                // Add to body
                document.body.appendChild(toast);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
        }
        
        // ==================== GAP RENDERING ====================
        function toggleDetails(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            if (!gap) return;
            
            gap.detailsExpanded = !gap.detailsExpanded;
            renderGaps();
        }

        function renderGapDetails(gap) {
            if (!gap.detailsExpanded) return '';
            
            let html = '<div class="gap-details expanded">';
            
            if (gap.fullDescription) {
                html += '<div class="gap-details-section">';
                html += '<h4>Full ICD-10 Description</h4>';
                html += '<p>' + gap.fullDescription + '</p>';
                html += '</div>';
            }
            
            if (gap.supportingEvidence && gap.supportingEvidence.length > 0) {
                html += '<div class="gap-details-section">';
                html += '<h4> Supporting Evidence from Chart</h4>';
                html += '<ul>';
                gap.supportingEvidence.forEach(function(e) {
                    html += '<li>' + e + '</li>';
                });
                html += '</ul></div>';
            }
            
            if (gap.clinicalRationale) {
                html += '<div class="gap-details-section">';
                html += '<h4> Clinical Rationale</h4>';
                html += '<p>' + gap.clinicalRationale + '</p>';
                html += '</div>';
            }
            
            if (gap.suggestedDocumentation) {
                html += '<div class="gap-details-section">';
                html += '<h4>Suggested Documentation Language</h4>';
                html += '<p>' + gap.suggestedDocumentation + '</p>';
                html += '</div>';
            }
            
            if (gap.relatedGaps && gap.relatedGaps.length > 0) {
                html += '<div class="gap-details-section">';
                html += '<h4> Related Gaps or Dependencies</h4>';
                html += '<ul>';
                gap.relatedGaps.forEach(function(r) {
                    html += '<li>' + r + '</li>';
                });
                html += '</ul></div>';
            }
            
            if (gap.qualityMeasure) {
                html += '<div class="gap-details-section">';
                html += '<h4>Quality Measure Details</h4>';
                html += '<p>' + gap.qualityMeasure + '</p>';
                html += '</div>';
            }
            
            if (gap.historicalData) {
                html += '<div class="gap-details-section">';
                html += '<h4>Historical Data</h4>';
                html += '<p>' + gap.historicalData + '</p>';
                html += '</div>';
            }
            
            if (gap.codingNotes) {
                html += '<div class="coding-note">';
                html += '<h4>Coding Note</h4>';
                html += '<p>' + gap.codingNotes + '</p>';
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function renderGaps(searchTerm = '') {
            const container = document.getElementById('gaps-list');
            container.innerHTML = '';
            
            const filteredGaps = gaps.filter(gap => {
                if (!showStaged && (gap.staged || gap.deferred)) return false;
                if (currentFilter !== 'all' && gap.type !== currentFilter) return false;
                if (searchTerm && !gap.title.toLowerCase().includes(searchTerm) && 
                    !gap.description.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
            
            // Group gaps by type
            const groupedGaps = {
                suspect: filteredGaps.filter(g => g.type === 'suspect'),
                quality: filteredGaps.filter(g => g.type === 'quality'),
                frailty: filteredGaps.filter(g => g.type === 'frailty'),
                recapture: filteredGaps.filter(g => g.type === 'recapture')
            };
            
            // Render each category
            Object.keys(groupedGaps).forEach(category => {
                const categoryGaps = groupedGaps[category];
                if (categoryGaps.length === 0) return;
                
                // Create category section
                const categorySection = document.createElement('div');
                categorySection.className = 'gap-category';
                categorySection.setAttribute('data-category', category);
                
                // Category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.onclick = () => toggleCategory(category);
                categoryHeader.innerHTML = `
                    <div class="category-title">
                        <span class="category-count">${categoryGaps.length}</span>
                        <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                    </div>
                    <span class="category-toggle"></span>
                `;
                
                // Category gaps container
                const categoryGapsContainer = document.createElement('div');
                categoryGapsContainer.className = 'category-gaps';
                categoryGapsContainer.setAttribute('data-category', category);
                
                categorySection.appendChild(categoryHeader);
                categorySection.appendChild(categoryGapsContainer);
                container.appendChild(categorySection);
            });
            
            // Now render gaps into their categories
            filteredGaps.forEach(gap => {
                const card = document.createElement('div');
                card.className = `gap-card ${gap.staged ? 'staged' : gap.deferred ? 'deferred' : ''}`;
                card.innerHTML = `
                    <div class="gap-card-header">
                        <input type="checkbox" class="gap-checkbox" ${gap.staged ? 'checked disabled' : ''}>
                        <div class="gap-info">
                            <span class="gap-type-badge ${gap.type}">${gap.type}</span><span class="coop-badge">COOP</span>
                            ${gap.priority === 'high' ? '<span class="gap-priority"> High</span>' : ''}
                            <div class="gap-title">${gap.title}</div>
                            <div class="gap-codes">${gap.icd ? `ICD-10: ${gap.icd}` : ''}${gap.hcc ? `  ${gap.hcc}` : ''}</div>
                        </div>
                    </div>
                    <div class="gap-description">${gap.description}</div>
                    <div class="gap-actions">
                        ${gap.staged ? `
                            <button class="stage-btn staged"> Staged for MD Review</button>
                            <button class="undo-btn" onclick="unstageGap(${gap.id})">Undo</button>
                        ` : gap.deferred ? `
                            <button class="stage-btn deferred"> Deferred to Future Visit</button>
                            <button class="undo-btn" onclick="undeferGap(${gap.id})">Undo</button>
                        ` : `
                            <button class="stage-btn" onclick="stageGap(${gap.id})">Stage for MD Review</button>
                            ${(gap.type === 'quality' || gap.type === 'frailty') ? `<button class="future-visit-btn" onclick="stageForFutureVisit(${gap.id})"> Future Visit</button>` : ''}
                            <button class="detail-btn" onclick="toggleDetails(${gap.id})">${gap.detailsExpanded ? ' Hide' : ' Details'}</button>
                        `}
                    </div>
                    ${gap.staged ? `
                        <div class="staged-indicator">
                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Staged by Sarah Chen, RN  ${gap.stagedTime}
                        </div>
                    ` : gap.deferred ? `
                        <div class="deferred-indicator">
                            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                            Deferred to future visit by Sarah Chen, RN  ${gap.deferredTime}  Reason: ${gap.deferralReason || 'Not appropriate for today\'s visit'}
                        </div>
                    ` : ''}
                    ${renderGapDetails(gap)}
                ` + 
                '<div class="attestation-checkboxes">' +
                    '<div class="attestation-item">' +
                        '<input type="checkbox" id="attest-monitored-' + gap.id + '" data-gap-id="' + gap.id + '" data-attest-type="monitored">' +
                        '<label for="attest-monitored-' + gap.id + '"> Monitored - Patient is being monitored for this condition</label>' +
                    '</div>' +
                    '<div class="attestation-item">' +
                        '<input type="checkbox" id="attest-rx-' + gap.id + '" data-gap-id="' + gap.id + '" data-attest-type="rx">' +
                        '<label for="attest-rx-' + gap.id + '"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="10" height="6" rx="3" stroke="#582c83" stroke-width="1.5"/><line x1="8" y1="5" x2="8" y2="11" stroke="#582c83" stroke-width="1.5"/></svg> Rx - Medication prescribed/reviewed for this condition</label>' +
                    '</div>' +
                    '<div class="attestation-item">' +
                        '<input type="checkbox" id="attest-labs-' + gap.id + '" data-gap-id="' + gap.id + '" data-attest-type="labs">' +
                        '<label for="attest-labs-' + gap.id + '"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 2H11V10C11 11.6569 9.65685 13 8 13C6.34315 13 5 11.6569 5 10V2Z" stroke="#582c83" stroke-width="1.5"/><line x1="5" y1="2" x2="11" y2="2" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="8" x2="11" y2="8" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/></svg> Labs - Labs ordered/reviewed for this condition</label>' +
                    '</div>' +
                    '<div class="attestation-item">' +
                        '<input type="checkbox" id="attest-referred-' + gap.id + '" data-gap-id="' + gap.id + '" data-attest-type="referred">' +
                        '<label for="attest-referred-' + gap.id + '"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="2" width="8" height="11" stroke="#582c83" stroke-width="1.5"/><path d="M7 4V8M5 6H9" stroke="#582c83" stroke-width="1.5" stroke-linecap="round"/><rect x="5" y="10" width="1.5" height="3" fill="#582c83"/><rect x="7.5" y="10" width="1.5" height="3" fill="#582c83"/></svg> Referred - Patient referred to specialist for this condition</label>' +
                    '</div>' +
                '</div>';
                
                // Append to category container instead of main container
                const categoryContainer = container.querySelector(`.category-gaps[data-category="${gap.type}"]`);
                if (categoryContainer) {
                    categoryContainer.appendChild(card);
                } else {
                    container.appendChild(card);
                }
                
                // Add checkbox event listener
                const checkbox = card.querySelector('.gap-checkbox');
                if (checkbox) {
                    checkbox.dataset.gapId = gap.id;
                    checkbox.checked = selectedGaps.includes(gap.id);
                    checkbox.addEventListener('change', (e) => {
                        toggleGapSelection(gap.id, e.target.checked);
                    });
                }
            });
            
            // Set max-height for all category-gaps containers (for smooth collapse/expand)
            document.querySelectorAll('.category-gaps').forEach(container => {
                if (!container.classList.contains('collapsed')) {
                    container.style.maxHeight = container.scrollHeight + 'px';
                }
            });
        }
        
        // Toggle category collapse/expand
        function toggleCategory(category) {
            const categoryGapsContainer = document.querySelector(`.category-gaps[data-category="${category}"]`);
            const categoryToggle = document.querySelector(`.gap-category[data-category="${category}"] .category-toggle`);
            
            if (categoryGapsContainer && categoryToggle) {
                const isCollapsed = categoryGapsContainer.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand
                    categoryGapsContainer.style.maxHeight = categoryGapsContainer.scrollHeight + 'px';
                    categoryGapsContainer.classList.remove('collapsed');
                    categoryToggle.classList.remove('collapsed');
                } else {
                    // Collapse
                    categoryGapsContainer.style.maxHeight = categoryGapsContainer.scrollHeight + 'px';
                    setTimeout(() => {
                        categoryGapsContainer.style.maxHeight = '0';
                        categoryGapsContainer.classList.add('collapsed');
                        categoryToggle.classList.add('collapsed');
                    }, 10);
                }
            }
        }
        
        function updateCounts() {
            const counts = {
                all: gaps.filter(g => !g.staged).length,
                recapture: gaps.filter(g => g.type === 'recapture' && !g.staged).length,
                suspect: gaps.filter(g => g.type === 'suspect' && !g.staged).length,
                quality: gaps.filter(g => g.type === 'quality' && !g.staged).length,
                frailty: gaps.filter(g => g.type === 'frailty' && !g.staged).length
            };
            
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-recapture').textContent = counts.recapture;
            document.getElementById('count-suspect').textContent = counts.suspect;
            document.getElementById('count-quality').textContent = counts.quality;
            document.getElementById('count-frailty').textContent = counts.frailty;
            document.getElementById('gaps-count').textContent = counts.all;
            
            // Update nav badges
            const problemsStaged = gaps.filter(g => g.staged && g.athenaSection === 'assessment').length;
            const qualityStaged = gaps.filter(g => g.staged && (g.athenaSection === 'quality' || g.athenaSection === 'plan')).length;
            
            if (problemsStaged > 0) {
                document.getElementById('problems-badge').style.display = 'block';
                document.getElementById('problems-badge').textContent = problemsStaged;
            } else {
                document.getElementById('problems-badge').style.display = 'none';
            }
            if (qualityStaged > 0) {
                document.getElementById('quality-badge').style.display = 'block';
                document.getElementById('quality-badge').textContent = qualityStaged;
            } else {
                document.getElementById('quality-badge').style.display = 'none';
            }
            
            // Update gap tracker
            renderGapTracker();
        }
        
        // ==================== GAP TRACKER (LOG TAB) ====================
        function renderGapTracker() {
            const trackerList = document.getElementById('gap-tracker-list');
            if (!trackerList) return;
            
            // Calculate stats
            const stats = {
                open: gaps.filter(g => !g.staged && !g.dismissed && !g.accepted && !g.documented).length,
                staged: gaps.filter(g => g.staged && !g.accepted && !g.dismissed).length,
                accepted: gaps.filter(g => g.accepted && !g.documented).length,
                dismissed: gaps.filter(g => g.dismissed).length,
                documented: gaps.filter(g => g.documented).length
            };
            
            // Update stat counters
            document.getElementById('tracker-open').textContent = stats.open;
            document.getElementById('tracker-staged').textContent = stats.staged;
            document.getElementById('tracker-accepted').textContent = stats.accepted;
            document.getElementById('tracker-dismissed').textContent = stats.dismissed;
            document.getElementById('tracker-documented').textContent = stats.documented;
            
            // Render gap items
            trackerList.innerHTML = gaps.map(gap => {
                let status = 'open';
                let statusText = 'Open';
                
                if (gap.documented) {
                    status = 'documented';
                    statusText = 'Documented';
                } else if (gap.accepted) {
                    status = 'accepted';
                    statusText = 'Accepted by MD';
                } else if (gap.dismissed) {
                    status = 'dismissed';
                    statusText = 'Dismissed';
                } else if (gap.staged) {
                    status = 'staged';
                    statusText = 'Staged for MD Review';
                } else if (gap.deferred) {
                    status = 'staged';
                    statusText = 'Deferred to Future Visit';
                }
                
                const typeLabel = gap.type.charAt(0).toUpperCase() + gap.type.slice(1);
                const hccLabel = gap.hcc ? `  ${gap.hcc}` : '';
                
                return `
                    <div class="tracker-gap-item">
                        <div class="tracker-gap-status ${status}"></div>
                        <div class="tracker-gap-info">
                            <div class="tracker-gap-title">${gap.title}</div>
                            <div class="tracker-gap-meta">${typeLabel}${hccLabel}  ${gap.icd || 'No ICD'}</div>
                        </div>
                        <div class="tracker-gap-badge ${status}">${statusText}</div>
                    </div>
                `;
            }).join('');
            
            // Also render dismissal analytics
            renderDismissalAnalytics();
        }
        
        // ==================== DISMISSAL ANALYTICS ====================
        function renderDismissalAnalytics() {
            const dismissedGaps = gaps.filter(g => g.dismissed);
            const analyticsContainer = document.getElementById('dismissal-analytics');
            
            if (dismissedGaps.length === 0) {
                analyticsContainer.style.display = 'none';
                return;
            }
            
            analyticsContainer.style.display = 'block';
            
            // Update impact count
            document.getElementById('impact-count').textContent = dismissedGaps.length;
            
            // Calculate dismissals by type
            const byType = {
                recapture: dismissedGaps.filter(g => g.type === 'recapture').length,
                suspect: dismissedGaps.filter(g => g.type === 'suspect').length,
                quality: dismissedGaps.filter(g => g.type === 'quality').length,
                frailty: dismissedGaps.filter(g => g.type === 'frailty').length
            };
            
            const maxCount = Math.max(...Object.values(byType));
            
            // Render chart bars
            const chartHtml = Object.entries(byType)
                .filter(([type, count]) => count > 0)
                .map(([type, count]) => {
                    const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
                    return `
                        <div class="chart-bar">
                            <div class="chart-bar-label">${typeLabel}</div>
                            <div class="chart-bar-track">
                                <div class="chart-bar-fill" style="width: ${percentage}%">${count}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('dismissal-chart').innerHTML = chartHtml;
            
            // Calculate top dismissal reasons
            const reasonCounts = {};
            dismissedGaps.forEach(gap => {
                if (gap.dismissalReason) {
                    reasonCounts[gap.dismissalReason] = (reasonCounts[gap.dismissalReason] || 0) + 1;
                }
            });
            
            const topReasons = Object.entries(reasonCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([reason, count]) => `
                    <div class="reason-item">
                        <div class="reason-text">${reason}</div>
                        <div class="reason-count">${count}</div>
                    </div>
                `).join('');
            
            document.getElementById('dismissal-reasons').innerHTML = topReasons || '<div class="reason-item"><div class="reason-text">No dismissal reasons recorded</div></div>';
        }
        
        // ==================== STAGING MODAL ====================
        function openStagingModal(gapId) {
            currentGapId = gapId;
            const gap = gaps.find(g => g.id === gapId);
            
            document.getElementById('modal-gap-title').textContent = gap.title;
            document.getElementById('modal-gap-detail').innerHTML = `
                ${gap.icd ? `<strong>ICD-10:</strong> ${gap.icd}<br>` : ''}
                ${gap.hcc ? `<strong>HCC:</strong> ${gap.hcc}<br>` : ''}
                ${gap.description}
            `;
            document.getElementById('modal-destination').textContent = gap.athenaLabel;
            document.getElementById('modal-note').value = '';
            document.getElementById('modal-overlay').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
            currentGapId = null;
        }
        
        function stageGap(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            if (!gap || gap.staged) return;
            
            // Show staging preview modal
            showStagingPreviewModal(gap);
        }
        
        function confirmStagingFromPreview(gapId) {
            // Close modal immediately
            closeStagingPreviewModal();
            
            const gap = gaps.find(g => g.id === gapId);
            if (!gap || gap.staged) return;
            
            gap.staged = true;
            gap.stagedTime = new Date().toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
            
            // Play whoosh sound for sync event
            syncSounds.playWhoosh();
            
            // Update UI immediately
            renderGaps();
            updateCounts();
            
            // Add staged item to Athena
            addStagedItemToAthena(gap);
            
            // Add to staged items for physician acceptance
            if (typeof stagedItems !== 'undefined') {
                stagedItems.push({
                    gapId: gap.id,
                    type: gap.type,
                    diagnosis: gap.title,
                    icd10: gap.icd,
                    hccs: gap.hcc ? [gap.hcc.replace('HCC ', '')] : [],
                    assessment: gap.details,
                    orders: gap.orders ? Object.values(gap.orders).flat() : [],
                    stagedAt: new Date().toISOString()
                });
                
                // Update completion tracker
                if (typeof updateCompletionTracker === 'function') {
                    updateCompletionTracker();
                }
                
                // Render staged problems in athenaOne
                if (typeof renderStagedProblems === 'function') {
                    renderStagedProblems();
                }
            }
            
            // Scroll to the section in Athena
            scrollToAthenaSection(gap.athenaSection);
            
            // Add to log
            addToLog('Gap Staged', `${gap.title} staged for MD review`);
            
            // Show sync notification
            showSyncNotification(`${gap.title} staged for MD review`);
        }
        
        function showStagingPreviewModal(gap) {
            const modal = document.createElement('div');
            modal.className = 'staging-preview-modal';
            modal.id = 'staging-preview-modal';
            
            let ordersHtml = '';
            if (gap.orders) {
                const allOrders = [];
                if (gap.orders.rx) {
                    allOrders.push(`Rx: ${gap.orders.rx.drug} ${gap.orders.rx.dose}`);
                }
                if (gap.orders.labs) {
                    allOrders.push(...gap.orders.labs.map(lab => `Lab: ${lab}`));
                }
                if (gap.orders.referrals) {
                    allOrders.push(...gap.orders.referrals.map(ref => `Referral: ${ref}`));
                }
                
                if (allOrders.length > 0) {
                    ordersHtml = `
                        <div class="staging-preview-section">
                            <div class="staging-preview-section-title">
                                 Orders (${allOrders.length})
                            </div>
                            ${allOrders.map(order => `
                                <div class="staging-preview-item">
                                     ${order}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            modal.innerHTML = `
                <div class="staging-preview-content">
                    <div class="staging-preview-header">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        Staging Preview
                    </div>
                    
                    <div class="staging-preview-section">
                        <div class="staging-preview-section-title">
                             Problem List Entry
                        </div>
                        <div class="staging-preview-item">
                            <strong>${gap.title} (${gap.icd})</strong><br>
                            ${gap.hcc ? gap.hcc : 'No HCC'}<br>
                            <span style="color: #757575;">Status: STAGED (awaiting physician approval)</span>
                        </div>
                    </div>
                    
                    <div class="staging-preview-section">
                        <div class="staging-preview-section-title">
                             Assessment & Plan Block
                        </div>
                        <div class="staging-preview-item">
                            <strong>1. ${gap.title} (${gap.icd})</strong><br>
                            ${gap.hcc ? gap.hcc : ''}<br><br>
                            <strong>Assessment:</strong><br>
                            ${gap.details || 'Assessment text will be generated based on MEAT criteria...'}
                        </div>
                    </div>
                    
                    ${ordersHtml}
                    
                    <div class="staging-preview-footer">
                        <div class="staging-preview-time">
                            Estimated Provider Review Time: 30 seconds
                        </div>
                        <div class="staging-preview-actions">
                            <button class="modal-btn cancel" onclick="closeStagingPreviewModal()">Cancel</button>
                            <button class="modal-btn confirm" onclick="confirmStagingFromPreview(${gap.id})">Confirm Stage</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeStagingPreviewModal() {
            const modal = document.getElementById('staging-preview-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function addStagedItemToAthena(gap) {
            // Generate CCA staging output based on gap type
            if (gap.athenaSection === 'assessment' || gap.athenaSection === 'objective') {
                addProblemListAndAPBlock(gap);
            } else if (gap.athenaSection === 'plan') {
                addOrdersToPlan(gap);
            } else if (gap.athenaSection === 'quality') {
                addQualityMeasureStaging(gap);
            }
        }
        
        function addProblemListAndAPBlock(gap) {
            // Add to Problem List section
            const problemListContainer = document.getElementById('problem-list-staged');
            const apContainer = document.getElementById('ap-staged');
            
            // Generate MEAT plan text
            let planText = '';
            if (gap.meatText) {
                planText = `<div class="meat-section"><strong>Monitor:</strong> ${gap.meatText.monitor}</div>
                           <div class="meat-section"><strong>Evaluate:</strong> ${gap.meatText.evaluate}</div>
                           <div class="meat-section"><strong>Assess:</strong> ${gap.meatText.assess}</div>
                           <div class="meat-section"><strong>Treat:</strong> ${gap.meatText.treat}</div>`;
            }
            
            // Generate orders HTML
            let ordersHtml = '';
            if (gap.orders) {
                if (gap.orders.rx) {
                    const rx = gap.orders.rx;
                    ordersHtml += `<div class="staged-order"><strong>Rx Order (UNSIGNED):</strong> ${rx.drug} ${rx.dose} ${rx.frequency} #${rx.quantity} (${rx.refills} refills)</div>`;
                }
                if (gap.orders.labs && gap.orders.labs.length > 0) {
                    ordersHtml += `<div class="staged-order"><strong>Lab Orders (UNSIGNED):</strong> ${gap.orders.labs.join(', ')}</div>`;
                }
                if (gap.orders.referrals && gap.orders.referrals.length > 0) {
                    ordersHtml += `<div class="staged-order"><strong>Referral Orders (UNSIGNED):</strong> ${gap.orders.referrals.join(', ')}</div>`;
                }
            }
            
            // Add to Problem List
            const problemHtml = `
                <div class="problem-item staged" id="problem-staged-${gap.id}">
                    <div class="problem-header">
                        <span class="problem-status staged">STAGED</span>
                        <span class="problem-diagnosis">${gap.title} (${gap.icd})</span>
                        ${gap.hcc ? `<span class="hcc-badge">${gap.hcc}</span>` : ''}
                    </div>
                    <div class="problem-details">
                        <span>Staged by: Sarah Chen, RN  Just now</span>
                        <div class="problem-actions">
                            <button class="btn-link-small" onclick="unstageGap(${gap.id})">Remove</button>
                        </div>
                    </div>
                </div>
            `;
            problemListContainer.insertAdjacentHTML('beforeend', problemHtml);
            
            // Add to A&P section
            const apHtml = `
                <div class="ap-block staged" id="ap-staged-${gap.id}">
                    <div class="ap-block-header">
                        <span class="ap-block-number">#1</span>
                        <span class="ap-block-diagnosis">${gap.title} (${gap.icd})</span>
                        ${gap.hcc ? `<span class="hcc-badge">${gap.hcc}</span>` : ''}
                        <span class="staged-badge">STAGED</span>
                    </div>
                    
                    <div class="ap-section-title">PLAN TEXT (MEAT CRITERIA)</div>
                    <div class="ap-text">${planText}</div>
                    
                    ${ordersHtml ? `<div class="ap-section-title">ORDERS TO SIGN</div><div class="ap-orders">${ordersHtml}</div>` : ''}
                    
                    <div class="ap-actions">
                        <button class="btn-link-small" onclick="editMeatCriteria(${gap.id})">Edit</button>
                        <button class="btn-link-small" onclick="unstageGap(${gap.id})">Remove Staging</button>
                    </div>
                </div>
            `;
            apContainer.insertAdjacentHTML('beforeend', apHtml);
        }
        
        function addOrdersToPlan(gap) {
            const container = document.getElementById('plan-staged');
            
            // Generate orders HTML
            let ordersHtml = '';
            if (gap.orders) {
                if (gap.orders.rx) {
                    const rx = gap.orders.rx;
                    ordersHtml += `<div class="staged-order-item"><strong>Prescription (UNSIGNED):</strong> ${rx.drug} ${rx.dose} ${rx.frequency} #${rx.quantity} (${rx.refills} refills)</div>`;
                }
                if (gap.orders.labs && gap.orders.labs.length > 0) {
                    gap.orders.labs.forEach(lab => {
                        ordersHtml += `<div class="staged-order-item"><strong>Lab (UNSIGNED):</strong> ${lab} - Clinical indication: ${gap.title}</div>`;
                    });
                }
                if (gap.orders.referrals && gap.orders.referrals.length > 0) {
                    gap.orders.referrals.forEach(ref => {
                        ordersHtml += `<div class="staged-order-item"><strong>Referral (UNSIGNED):</strong> ${ref} - Reason: ${gap.title}</div>`;
                    });
                }
            }
            
            const stagedHtml = `
                <div class="staged-item cca-staging" id="staged-${gap.id}">
                    <div class="staged-badge"> STAGED FOR MD REVIEW</div>
                    <div class="staged-title">${gap.title}</div>
                    ${ordersHtml}
                    <div class="staged-meta">
                        <span>Sarah Chen, RN</span>
                        <span> Just now</span>
                        <button class="remove-btn" onclick="unstageGap(${gap.id})">Remove Staging</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', stagedHtml);
        }
        
        function addQualityMeasureStaging(gap) {
            const container = document.getElementById('quality-staged');
            
            // Generate orders HTML
            let ordersHtml = '';
            if (gap.orders) {
                if (gap.orders.referrals && gap.orders.referrals.length > 0) {
                    gap.orders.referrals.forEach(ref => {
                        ordersHtml += `<div class="staged-order-item"><strong>Order (UNSIGNED):</strong> ${ref}</div>`;
                    });
                }
                if (gap.orders.labs && gap.orders.labs.length > 0) {
                    gap.orders.labs.forEach(lab => {
                        ordersHtml += `<div class="staged-order-item"><strong>Lab (UNSIGNED):</strong> ${lab}</div>`;
                    });
                }
            }
            
            const stagedHtml = `
                <div class="staged-item cca-staging" id="staged-${gap.id}">
                    <div class="staged-badge"> STAGED FOR MD REVIEW</div>
                    <div class="staged-title">${gap.title}</div>
                    <div class="staged-detail">${gap.description}</div>
                    ${ordersHtml}
                    <div class="staged-meta">
                        <span>Sarah Chen, RN</span>
                        <span> Just now</span>
                        <button class="remove-btn" onclick="unstageGap(${gap.id})">Remove Staging</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', stagedHtml);
        }
        
        function scrollToAthenaSection(section) {
            const sectionMap = {
                'assessment': 'section-assessment',
                'quality': 'section-quality',
                'plan': 'section-plan',
                'objective': 'section-objective',
                'subjective': 'section-subjective'
            };
            
            const navMap = {
                'assessment': 'problems',
                'quality': 'quality-measures',
                'plan': 'care-gaps',
                'objective': 'questionnaires',
                'subjective': 'visit-summary'
            };
            
            // Highlight nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === navMap[section]) {
                    item.classList.add('active');
                }
            });
            
            // Scroll to section
            const sectionEl = document.getElementById(sectionMap[section]);
            if (sectionEl) {
                sectionEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Add highlight effect
                sectionEl.style.boxShadow = '0 0 0 3px #55B5B8';
                setTimeout(() => {
                    sectionEl.style.boxShadow = '';
                }, 2000);
            }
        }
        
        function scrollToSection(section) {
            const sectionMap = {
                'visit-summary': 'section-subjective',
                'problems': 'section-problem-list',
                'medications': 'section-medications',
                'labs': 'section-objective',
                'questionnaires': 'section-objective',
                'quality-measures': 'section-quality',
                'care-gaps': 'section-plan'
            };
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });
            
            const sectionEl = document.getElementById(sectionMap[section]);
            const athenaContent = document.getElementById('athena-content');
            if (sectionEl && athenaContent) {
                // Calculate the position of the section relative to the container
                const containerTop = athenaContent.scrollTop;
                const sectionTop = sectionEl.offsetTop - athenaContent.offsetTop;
                
                // Smooth scroll within the athena-content container
                athenaContent.scrollTo({
                    top: sectionTop,
                    behavior: 'smooth'
                });
            }
        }
        
        function unstageGap(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            gap.staged = false;
            gap.stagedTime = null;
            gap.nurseNote = null;
            
            // Remove from all Athena sections
            const problemEl = document.getElementById(`problem-staged-${gapId}`);
            if (problemEl) problemEl.remove();
            
            const apEl = document.getElementById(`ap-staged-${gapId}`);
            if (apEl) apEl.remove();
            
            const stagedEl = document.getElementById(`staged-${gapId}`);
            if (stagedEl) stagedEl.remove();
            
            // Add to log
            addToLog('Staging Removed', `${gap.title} removed from staging`);
            
            renderGaps();
            updateCounts();
        }
        
        function stageForFutureVisit(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            if (!gap || gap.staged || gap.deferred) return;
            
            // Show future visit modal
            showFutureVisitModal(gap);
        }
        
        // ==================== BULK GAP STAGING ====================
        
        function toggleGapSelection(gapId, checked) {
            if (checked) {
                if (!selectedGaps.includes(gapId)) {
                    selectedGaps.push(gapId);
                }
            } else {
                selectedGaps = selectedGaps.filter(id => id !== gapId);
            }
            updateBulkStageButton();
        }
        
        function updateBulkStageButton() {
            const bulkBtn = document.getElementById('bulk-stage-btn');
            if (selectedGaps.length > 0) {
                bulkBtn.classList.add('visible');
                bulkBtn.textContent = `Stage Selected (${selectedGaps.length})`;
            } else {
                bulkBtn.classList.remove('visible');
            }
        }
        
        function openBulkStagingModal() {
            if (selectedGaps.length === 0) return;
            
            const modal = document.getElementById('bulk-staging-modal');
            const listContainer = document.getElementById('bulk-gap-list');
            
            // Group gaps by type
            const selectedGapObjects = selectedGaps.map(id => gaps.find(g => g.id === id));
            const groupedGaps = {
                suspect: selectedGapObjects.filter(g => g.type === 'suspect'),
                recapture: selectedGapObjects.filter(g => g.type === 'recapture'),
                quality: selectedGapObjects.filter(g => g.type === 'quality'),
                frailty: selectedGapObjects.filter(g => g.type === 'frailty')
            };
            
            let html = '';
            
            // Render each type group
            Object.keys(groupedGaps).forEach(type => {
                if (groupedGaps[type].length === 0) return;
                
                const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
                html += `<div class="gap-type-group">`;
                html += `<div class="gap-type-group-title">${typeLabel} Gaps (${groupedGaps[type].length})</div>`;
                
                groupedGaps[type].forEach(gap => {
                    html += `
                        <div class="bulk-gap-card" data-gap-id="${gap.id}">
                            <div class="bulk-gap-header">
                                <div>
                                    <div class="bulk-gap-title">${gap.title}</div>
                                    <div class="bulk-gap-meta">${gap.icd || ''}${gap.hcc ? '  ' + gap.hcc : ''}</div>
                                </div>
                                <button class="bulk-remove-btn" onclick="removeFromBulkSelection(${gap.id})">Remove</button>
                            </div>
                            <div class="bulk-meat-section">
                                <div class="bulk-meat-toggle" onclick="toggleBulkMEAT(${gap.id})">
                                    <span class="bulk-meat-toggle-icon" id="meat-icon-${gap.id}"></span>
                                    <span style="font-size: 12px; font-weight: 600; color: #424242;">MEAT Criteria</span>
                                </div>
                                <div class="bulk-meat-content" id="meat-content-${gap.id}">
                                    <div class="bulk-meat-label">Monitor:</div>
                                    <div>${gap.meatText?.monitor || 'N/A'}</div>
                                    <div class="bulk-meat-label">Evaluate:</div>
                                    <div>${gap.meatText?.evaluate || 'N/A'}</div>
                                    <div class="bulk-meat-label">Assess:</div>
                                    <div>${gap.meatText?.assess || 'N/A'}</div>
                                    <div class="bulk-meat-label">Treat:</div>
                                    <div>${gap.meatText?.treat || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            listContainer.innerHTML = html;
            modal.classList.add('show');
        }
        
        function closeBulkStagingModal() {
            const modal = document.getElementById('bulk-staging-modal');
            modal.classList.remove('show');
        }
        
        function removeFromBulkSelection(gapId) {
            selectedGaps = selectedGaps.filter(id => id !== gapId);
            
            // Remove the card from the modal
            const card = document.querySelector(`[data-gap-id="${gapId}"]`);
            if (card) card.remove();
            
            // Uncheck the checkbox
            const checkbox = document.querySelector(`.gap-checkbox[data-gap-id="${gapId}"]`);
            if (checkbox) checkbox.checked = false;
            
            updateBulkStageButton();
            
            // Close modal if no gaps left
            if (selectedGaps.length === 0) {
                closeBulkStagingModal();
            }
        }
        
        function toggleBulkMEAT(gapId) {
            const icon = document.getElementById(`meat-icon-${gapId}`);
            const content = document.getElementById(`meat-content-${gapId}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = '';
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                icon.textContent = '';
            }
        }
        
        function confirmBulkStaging() {
            if (selectedGaps.length === 0) return;
            
            const count = selectedGaps.length;
            const gapTitles = selectedGaps.map(id => {
                const gap = gaps.find(g => g.id === id);
                return gap ? gap.title : '';
            }).filter(t => t).join(', ');
            
            // Stage each gap
            selectedGaps.forEach(gapId => {
                const gap = gaps.find(g => g.id === gapId);
                if (gap && !gap.staged) {
                    gap.staged = true;
                    gap.stagedTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    
                    // Add to athenaOne sections (reuse existing staging logic)
                    addStagedItemToAthena(gap);
                    
                    // Add to staged items for physician acceptance
                    if (typeof stagedItems !== 'undefined') {
                        stagedItems.push({
                            gapId: gap.id,
                            type: 'problem',
                            diagnosis: gap.title,
                            icd10: gap.icd,
                            hccs: gap.hcc ? [gap.hcc.replace('HCC ', '')] : [],
                            assessment: gap.details,
                            orders: gap.orders ? Object.values(gap.orders).flat() : [],
                            stagedAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            // Clear selection
            selectedGaps = [];
            
            // Play chime sound for bulk staging
            syncSounds.playChime();
            
            // Close modal
            closeBulkStagingModal();
            
            // Update UI
            renderGaps();
            updateCounts();
            updateBulkStageButton();
            
            // Show notification
            showToast(` ${count} gaps staged for MD review`);
            showSyncNotification(`${count} gaps staged for MD review`);
            
            // Add to log
            addToLog('Bulk Staging', `Bulk staged ${count} gaps: ${gapTitles}`);
        }
        
        function showFutureVisitModal(gap) {
            // Prevent duplicate modal
            const existing = document.getElementById('future-visit-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'future-visit-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 480px; max-width: 90vw; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #7B1FA2, #9C27B0); color: white; padding: 16px 24px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;"></span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700;">Stage for Future Visit</div>
                            <div style="font-size: 12px; opacity: 0.9;">Defer this gap to a future encounter</div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px 24px;">
                        <div style="background: #F3E5F5; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #4A148C; font-size: 14px;">${gap.title}</div>
                            <div style="font-size: 12px; color: #6A1B9A; margin-top: 4px;">
                                ${gap.icd ? 'ICD-10: ' + gap.icd : ''}
                                ${gap.qualityMeasure ? '  ' + gap.qualityMeasure : ''}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 13px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Reason for Deferral</label>
                            <select id="future-visit-reason" style="width: 100%; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; color: #333;">
                                <option value="not-today">Not appropriate for today's visit type</option>
                                <option value="needs-prep">Patient needs preparation (e.g., fasting, bowel prep)</option>
                                <option value="scheduling">Requires separate scheduling with specialist</option>
                                <option value="patient-preference">Patient prefers to address at next visit</option>
                                <option value="time-constraint">Time constraint - insufficient visit time remaining</option>
                                <option value="other">Other reason</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 13px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Target Visit (Optional)</label>
                            <select id="future-visit-target" style="width: 100%; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; color: #333;">
                                <option value="next-visit">Next Scheduled Visit</option>
                                <option value="awv">Annual Wellness Visit (12/15/2026)</option>
                                <option value="3-months">3-Month Follow-up</option>
                                <option value="6-months">6-Month Follow-up</option>
                                <option value="specific">Specific Date (to be determined)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 13px; font-weight: 600; color: #333; display: block; margin-bottom: 8px;">Additional Notes (Optional)</label>
                            <textarea id="future-visit-notes" placeholder="Add any notes for the future visit..." style="width: 100%; min-height: 60px; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 13px; color: #333; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        
                        <div style="background: #FFF3E0; border-left: 3px solid #FF9800; padding: 10px 14px; border-radius: 4px; font-size: 12px; color: #E65100; line-height: 1.5;">
                            <strong>Note:</strong> Florence will automatically add this gap to the pre-work summary for the target visit and send a reminder to the care team.
                        </div>
                    </div>
                    
                    <div style="padding: 12px 24px; background: #F9FAFB; border-top: 1px solid #E5E7EB; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeFutureVisitModal()" style="padding: 10px 20px; border: 2px solid #E5E7EB; border-radius: 8px; background: white; color: #333; font-size: 13px; font-weight: 600; cursor: pointer;">Cancel</button>
                        <button onclick="confirmFutureVisit(${gap.id})" style="padding: 10px 20px; border: none; border-radius: 8px; background: #7B1FA2; color: white; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(123,31,162,0.3);"> Defer to Future Visit</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeFutureVisitModal();
            });
        }
        
        function closeFutureVisitModal() {
            const modal = document.getElementById('future-visit-modal');
            if (modal) modal.remove();
        }
        
        function confirmFutureVisit(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            if (!gap) return;
            
            const reason = document.getElementById('future-visit-reason');
            const target = document.getElementById('future-visit-target');
            const notes = document.getElementById('future-visit-notes');
            
            const reasonText = reason.options[reason.selectedIndex].text;
            const targetText = target.options[target.selectedIndex].text;
            const notesText = notes ? notes.value.trim() : '';
            
            gap.deferred = true;
            gap.deferredTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            gap.deferralReason = reasonText;
            gap.deferralTarget = targetText;
            gap.deferralNotes = notesText;
            
            // Add deferred item to athenaOne quality measures section
            addDeferredToAthena(gap);
            
            // Update UI
            renderGaps();
            updateCounts();
            
            // Add to log
            addToLog('Gap Deferred', `${gap.title} deferred to ${targetText}. Reason: ${reasonText}`);
            
            // Close modal
            closeFutureVisitModal();
        }
        
        function addDeferredToAthena(gap) {
            const container = document.getElementById('quality-staged');
            if (!container) return;
            
            const deferredHtml = `
                <div class="staged-item cca-staging" id="deferred-${gap.id}" style="border-left: 3px solid #7B1FA2; background: #FAFAFA;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span class="deferred-badge"> DEFERRED TO FUTURE VISIT</span>
                    </div>
                    <div class="staged-title">${gap.title}</div>
                    <div class="staged-detail" style="font-size: 12px; color: #616161; margin: 4px 0;">${gap.description}</div>
                    <div style="font-size: 11px; color: #7B1FA2; margin-top: 8px; background: #F3E5F5; padding: 6px 10px; border-radius: 4px;">
                        <strong>Target:</strong> ${gap.deferralTarget}  <strong>Reason:</strong> ${gap.deferralReason}
                        ${gap.deferralNotes ? '<br><strong>Notes:</strong> ' + gap.deferralNotes : ''}
                    </div>
                    <div class="staged-meta" style="margin-top: 8px;">
                        <span>Sarah Chen, RN</span>
                        <span> Just now</span>
                        <button class="remove-btn" onclick="undeferGap(${gap.id})">Remove Deferral</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', deferredHtml);
        }
        
        function undeferGap(gapId) {
            const gap = gaps.find(g => g.id === gapId);
            if (!gap) return;
            
            gap.deferred = false;
            gap.deferredTime = null;
            gap.deferralReason = null;
            gap.deferralTarget = null;
            gap.deferralNotes = null;
            
            // Remove from athenaOne
            const deferredEl = document.getElementById('deferred-' + gapId);
            if (deferredEl) deferredEl.remove();
            
            // Add to log
            addToLog('Deferral Removed', `${gap.title} deferral removed`);
            
            renderGaps();
            updateCounts();
        }
        
        function toggleSummary() {
            const content = document.getElementById('summary-content');
            const toggle = document.getElementById('summary-toggle');
            content.classList.toggle('show');
            toggle.classList.toggle('expanded');
        }
        
        // ==================== TAB SWITCHING ====================
        function switchToTab(tabName) {
            document.querySelectorAll('.florence-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // Auto-hide workflow buttons on Overview and Documentation tabs
            const workflowButtons = document.querySelector('.workflow-buttons');
            const postVisitBtn = document.getElementById('post-visit-btn-relocated');
            
            if (tabName === 'facesheet' || tabName === 'documentation') {
                // Hide workflow buttons and post-visit button
                if (workflowButtons) workflowButtons.classList.add('hidden');
                if (postVisitBtn) postVisitBtn.style.display = 'none';
            } else {
                // Show workflow buttons and post-visit button on Transcript tab
                if (workflowButtons) workflowButtons.classList.remove('hidden');
                if (postVisitBtn) postVisitBtn.style.display = 'flex';
            }
            
            // Re-initialize filters after tab switch (v7 fix)
            if (tabName === 'facesheet') {
                setTimeout(() => {
                    renderGaps();
                }, 100);
            }
        }
        
        // ==================== WORKFLOW FUNCTIONS ====================
        function resetButtons() {
            const buttons = {
                engage: { text: 'Engage', icon: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>' },
                convene: { text: 'Convene', icon: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' },
                checkin: { text: 'Check-In', icon: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' }
            };

            Object.keys(buttons).forEach(key => {
                const btn = document.getElementById(key + '-btn');
                btn.classList.remove('active');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = buttons[key].text;
                btn.querySelector('svg').innerHTML = buttons[key].icon;
            });
        }
        
        function addMessage(msg, signal) {
            return new Promise((resolve, reject) => {
                if (signal && signal.aborted) {
                    reject(new Error('Aborted'));
                    return;
                }

                const container = document.getElementById('transcript-container');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}`;
                
                const speakerNames = {
                    florence: 'Florence',
                    patient: currentWorkflow === 'convene' ? 'Jane' : 'Jane',
                    'care-manager': 'Sarah Martinez (Care Manager)'
                };

                const speakerIcons = {
                    florence: '<circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line>',
                    patient: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>',
                    'care-manager': '<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line>'
                };
                
                if (msg.type === 'system') {
                    messageDiv.textContent = msg.text;
                    container.appendChild(messageDiv);
                    container.scrollTop = container.scrollHeight;
                    resolve();
                    return;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;">
                            ${speakerIcons[msg.type] || speakerIcons.patient}
                        </svg>
                        ${speakerNames[msg.type] || 'Unknown'}
                    </div>
                    <span class="message-text"></span>
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                // Typewriter effect
                const textSpan = messageDiv.querySelector('.message-text');
                const words = msg.text.split(' ');
                let wordIndex = 0;
                
                function typeWord() {
                    if (signal && signal.aborted) {
                        reject(new Error('Aborted'));
                        return;
                    }
                    if (wordIndex < words.length) {
                        textSpan.textContent += (wordIndex > 0 ? ' ' : '') + words[wordIndex];
                        wordIndex++;
                        container.scrollTop = container.scrollHeight;
                        setTimeout(typeWord, 80);
                    } else {
                        resolve();
                    }
                }
                typeWord();
            });
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('transcript-container');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        
        async function playConversation(workflowType, signal) {
            const script = scripts[workflowType];
            
            for (let i = 0; i < script.length; i++) {
                if (signal.aborted) throw new Error('Aborted');
                
                const msg = script[i];
                
                if (msg.type === 'patient' || msg.type === 'care-manager') {
                    showTypingIndicator();
                    await new Promise((r, reject) => {
                        const timeout = setTimeout(r, 1200);
                        signal.addEventListener('abort', () => {
                            clearTimeout(timeout);
                            reject(new Error('Aborted'));
                        });
                    });
                    hideTypingIndicator();
                }
                
                await addMessage(msg, signal);
                await new Promise((r, reject) => {
                    const timeout = setTimeout(r, 500);
                    signal.addEventListener('abort', () => {
                        clearTimeout(timeout);
                        reject(new Error('Aborted'));
                    });
                });
            }
            
            // Wait then switch to Documentation
            await new Promise((r, reject) => {
                const timeout = setTimeout(r, 2000);
                signal.addEventListener('abort', () => {
                    clearTimeout(timeout);
                    reject(new Error('Aborted'));
                });
            });
            
            switchToTab('documentation');
            showDocumentation(workflowType);
        }
        
        function showDocumentation(workflowType) {
            const doc = documentation[workflowType];
            document.getElementById('doc-title').textContent = doc.title;
            document.getElementById('doc-content').innerHTML = doc.content;
            document.getElementById('file-btn').classList.remove('hidden');
        }
        
        async function startWorkflow(workflowType) {
            // If same workflow is running, ignore
            if (currentWorkflow === workflowType && isWorkflowInProgress) return;
            
            // Cancel any existing workflow immediately
            if (isWorkflowInProgress && abortController) {
                abortController.abort();
                hideTypingIndicator();
                await new Promise(r => setTimeout(r, 50));
            }
            
            // Reset state
            isWorkflowInProgress = false;
            currentWorkflow = null;
            abortController = null;
            
            currentWorkflow = workflowType;
            isWorkflowInProgress = true;
            abortController = new AbortController();
            
            // Clear previous transcript
            document.getElementById('transcript-container').innerHTML = '';
            
            // Reset all buttons first
            resetButtons();
            
            // Switch to transcript tab
            switchToTab('transcript');
            
            // Update active button
            const btn = document.getElementById(workflowType + '-btn');
            btn.classList.add('active');
            btn.disabled = true;
            
            const inProgressText = {
                engage: 'In Call...',
                convene: 'In Session...',
                checkin: 'Checking In...'
            };
            btn.querySelector('.btn-text').textContent = inProgressText[workflowType];
            
            // Keep other buttons enabled so user can switch workflows
            ['engage', 'convene', 'checkin'].forEach(type => {
                if (type !== workflowType) {
                    document.getElementById(type + '-btn').disabled = false;
                }
            });
            
            // Add to log
            const workflowNames = {
                engage: 'Engage Call',
                convene: 'Convene Session',
                checkin: 'Check-In'
            };
            
            // Safely add to log (don't let logging errors break the workflow)
            try {
                addToLog(`${workflowNames[workflowType]} Started`, 'Workflow in progress...');
            } catch (logError) {
                console.warn('addToLog failed:', logError);
            }
            
            try {
                await playConversation(workflowType, abortController.signal);
                
                // Success - update button
                btn.querySelector('.btn-text').textContent = 'Completed';
                btn.querySelector('svg').innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
                
                // Add to log (safely)
                try {
                    addToLog(`${workflowNames[workflowType]} Completed`, 'Documentation generated');
                } catch (logError) {
                    console.warn('addToLog failed:', logError);
                }
                
                // Store the workflow type for fileToEHR (don't clear currentWorkflow yet)
                lastCompletedWorkflow = workflowType;
                
                setTimeout(() => {
                    resetButtons();
                    isWorkflowInProgress = false;
                    // Don't clear currentWorkflow so fileToEHR knows which note to file
                }, 2000);
                
            } catch (e) {
                if (e.message !== 'Aborted') {
                    console.error(e);
                }
                hideTypingIndicator();
            }
        }
        
        // Celebration overlay for sync moments
        function showSyncCelebration(title, subtitle, color) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.3); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            const card = document.createElement('div');
            card.style.cssText = `
                background: white; border-radius: 16px; padding: 32px 48px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                text-align: center; max-width: 500px;
                animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                border-top: 4px solid ${color};
            `;
            card.innerHTML = `
                <div style="width: 64px; height: 64px; border-radius: 50%; background: ${color}; margin: 0 auto 16px;
                    display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="32" height="32">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h2 style="font-size: 20px; font-weight: 700; color: #1a202c; margin-bottom: 8px;">${title}</h2>
                <p style="font-size: 14px; color: #718096;">${subtitle}</p>
                <div style="margin-top: 12px; font-size: 11px; color: #a0aec0;">Synced to athenaOne</div>
            `;
            overlay.appendChild(card);
            document.body.appendChild(overlay);
            
            // Auto-dismiss after 2 seconds
            setTimeout(() => {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }, 2000);
            
            // Also allow click to dismiss
            overlay.addEventListener('click', () => {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            });
        }
        
        // Sync notification system
        let syncNotificationCount = 0;
        
        function triggerSyncNotification(message) {
            syncNotificationCount++;
            const bell = document.getElementById('sync-notif-bell');
            const badge = document.getElementById('sync-notif-badge');
            
            if (bell && badge) {
                bell.classList.add('has-notifications');
                badge.textContent = syncNotificationCount;
                badge.style.display = 'block';
                
                // Show toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 420px;
                    background: white;
                    border-left: 4px solid #55B5B8;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    animation: slideInFromRight 0.3s ease;
                    max-width: 300px;
                    font-size: 13px;
                    color: #424242;
                `;
                toast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#55B5B8" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <strong style="color: #55B5B8;">Synced to athenaOne</strong>
                    </div>
                    <div style="margin-top: 4px; font-size: 12px; color: #666;">${message}</div>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }
        
        function clearSyncNotifications() {
            syncNotificationCount = 0;
            const bell = document.getElementById('sync-notif-bell');
            const badge = document.getElementById('sync-notif-badge');
            
            if (bell && badge) {
                bell.classList.remove('has-notifications');
                badge.style.display = 'none';
            }
        }
        
        function addToLog(title, description) {
            const logContainer = document.getElementById('log-container');
            const newLog = document.createElement('div');
            newLog.className = 'log-item';
            newLog.innerHTML = `
                <div class="log-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="log-content">
                    <h4>${title}</h4>
                    <p>${description}</p>
                </div>
                <span class="log-time">Just now</span>
            `;
            logContainer.insertBefore(newLog, logContainer.firstChild);
        }
    

// ========================================
// PHYSICIAN INTERACTIVE BUTTON HANDLERS
// ========================================

// Function to add problem to problem list (physician accepts staged diagnosis)
function addToProblemList(gapId) {
    console.log('Adding problem to problem list:', gapId);
    
    // Find the gap
    const gap = gaps.find(g => g.id === gapId);
    if (!gap) return;
    
    // Mark as documented
    gap.status = 'documented';
    gap.physicianAction = 'accepted';
    gap.documentedDate = new Date().toISOString();
    
    // Update UI - change button to " DOCUMENTED"
    const stagedProblem = document.querySelector(`[data-gap-id="${gapId}"]`);
    if (stagedProblem) {
        const addButton = stagedProblem.querySelector('button');
        if (addButton && addButton.textContent.includes('Add to Problem List')) {
            addButton.textContent = ' DOCUMENTED';
            addButton.style.backgroundColor = '#43A047';
            addButton.style.cursor = 'default';
            addButton.disabled = true;
        }
        
        // Change staged indicator to documented
        const stagedBadge = stagedProblem.querySelector('.staged-badge');
        if (stagedBadge) {
            stagedBadge.textContent = ' DOCUMENTED';
            stagedBadge.style.backgroundColor = '#43A047';
        }
    }
    
    // Add to log
    addLogEntry('Problem Added', `${gap.diagnosis} (${gap.icd10}) added to problem list by physician`, 'success');
    
    console.log('Problem added successfully');
}

// Function to dismiss staged problem (physician rejects) - redirects to modal
// The actual dismissal logic is in confirmDismissal() in the sync script block
function dismissStagedProblem(gapId) {
    console.log('Dismissing staged problem (showing modal):', gapId);
    // Prevent duplicate modal if already open
    if (document.getElementById('dismissal-modal-overlay')) {
        console.log('Dismissal modal already open, skipping');
        return;
    }
    if (typeof showDismissalModal === 'function') {
        showDismissalModal(gapId);
    } else {
        console.error('showDismissalModal not yet loaded');
    }
}

// Function to add log entry
function addLogEntry(title, description, type = 'info') {
    const logContent = document.querySelector('.log-content');
    if (!logContent) return;
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <div class="log-icon">${type === 'success' ? '' : type === 'warning' ? '' : ''}</div>
        <div class="log-details">
            <h4>${title}</h4>
            <p>${description}</p>
            <span class="log-time">Just now</span>
        </div>
    `;
    
    // Insert at the top
    logContent.insertBefore(logEntry, logContent.firstChild);
}

// Initialize button handlers when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing physician button handlers...');
    
    // Add click handlers to "Add to Problem List" buttons
    document.addEventListener('click', function(e) {
        const target = e.target;
        
        // Handle "Add to Problem List" button
        if (target.tagName === 'BUTTON' && target.textContent.includes('Add to Problem List')) {
            const stagedProblem = target.closest('[data-gap-id]');
            if (stagedProblem) {
                const gapId = stagedProblem.getAttribute('data-gap-id');
                addToProblemList(gapId);
            }
        }
        
        // Handle "Dismiss" button
        if (target.tagName === 'BUTTON' && target.textContent.trim() === 'Dismiss') {
            const stagedProblem = target.closest('[data-gap-id]');
            if (stagedProblem) {
                const gapId = stagedProblem.getAttribute('data-gap-id');
                dismissStagedProblem(gapId);
            }
        }
    });
    
    console.log('Button handlers initialized');
});

    </script>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    
/* Details Expandable Card (v7) */
.gap-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background: #f8f9fa;
    border-radius: 6px;
    margin-top: 12px;
}

.gap-details.expanded {
    max-height: 2000px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.gap-details-section {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
}

.gap-details-section:last-child {
    border-bottom: none;
}

.gap-details-section h4 {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin: 0 0 8px 0;
}

.gap-details-section p, .gap-details-section ul {
    font-size: 12px;
    color: #6c757d;
    margin: 0;
    line-height: 1.5;
}

.gap-details-section ul {
    padding-left: 20px;
}

.gap-details-section li {
    margin-bottom: 4px;
}

.coding-note {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 12px;
    margin: 12px 0;
    border-radius: 4px;
}

.coding-note h4 {
    color: #856404;
    margin: 0 0 6px 0;
}

.coding-note p {
    color: #856404;
    margin: 0;
}

/* CSS Transitions (v7) */
.tab-button {
    transition: all 0.2s ease;
}

.florence-summary {
    transition: max-height 0.3s ease-out;
}

button {
    transition: all 0.15s ease;
}

button:hover {
    transform: translateY(-1px);
}

.gap-action-btn {
    transition: all 0.2s ease;
}

.filter-chip {
    transition: all 0.15s ease;
}

.gap-card {
    transition: all 0.2s ease;
}

.gap-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}


        /* Sync Button (override) */
        .sync-button {
            position: static;
            background: linear-gradient(135deg, #55B5B8 0%, #4A9FA2 100%);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(85, 181, 184, 0.3);
            transition: all 0.2s ease;
        }
        
        .sync-button:hover {
            background: linear-gradient(135deg, #4A9FA2 0%, #3D8D90 100%);
            box-shadow: 0 4px 12px rgba(85, 181, 184, 0.4);
            transform: translateY(-1px);
        }
        
        .sync-button:active {
            transform: translateY(0);
        }
        
        .sync-button.syncing {
            opacity: 0.7;
            cursor: wait;
        }
        
        .sync-button.syncing svg {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Sync Report Modal */
        .sync-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .sync-report-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
        }
        
        .sync-report-header {
            background: linear-gradient(135deg, #55B5B8 0%, #4A9FA2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sync-report-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sync-report-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        
        .sync-report-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-report-body {
            padding: 24px;
        }
        
        .sync-report-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .sync-stat-card {
            background: #F5F5F5;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .sync-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .sync-stat-icon.confirmed {
            background: #E8F5E9;
            color: #43A047;
        }
        
        .sync-stat-icon.dismissed {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .sync-stat-icon.pending {
            background: #FFF9C4;
            color: #F57C00;
        }
        
        .sync-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        
        .sync-stat-label {
            font-size: 13px;
            color: #757575;
            font-weight: 500;
        }
        
        .sync-report-section {
            margin-bottom: 24px;
        }
        
        .sync-report-section-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-gap-item {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .sync-gap-item.confirmed {
            border-left: 4px solid #43A047;
            background: #F1F8F4;
        }
        
        .sync-gap-item.dismissed {
            border-left: 4px solid #C62828;
            background: #FFF5F5;
        }
        
        .sync-gap-item.pending {
            border-left: 4px solid #F57C00;
            background: #FFFBF0;
        }
        
        .sync-gap-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .sync-gap-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .sync-gap-code {
            font-size: 12px;
            color: #757575;
        }
        
        .sync-gap-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .sync-gap-badge.confirmed {
            background: #43A047;
            color: white;
        }
        
        .sync-gap-badge.dismissed {
            background: #C62828;
            color: white;
        }
        
        .sync-gap-badge.pending {
            background: #F57C00;
            color: white;
        }
        
        .sync-gap-documentation {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .sync-gap-doc-label {
            font-size: 11px;
            font-weight: 600;
            color: #757575;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .sync-gap-doc-text {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
        }


        /* ==================== DISMISSAL MODAL STYLES ==================== */
        .dismissal-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }

        .dismissal-modal-overlay.active {
            display: flex;
        }

        .dismissal-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .dismissal-modal-header {
            background: linear-gradient(135deg, #E45740 0%, #C62828 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dismissal-modal-header-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .dismissal-modal-header-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .dismissal-modal-header-content p {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
            font-weight: 400;
        }

        .dismissal-modal-body {
            padding: 24px;
        }

        .dismissal-gap-info-card {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .dismissal-gap-info-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .dismissal-gap-info-details {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .dismissal-gap-info-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dismissal-gap-info-detail strong {
            color: var(--text-dark);
        }

        .dismissal-info-banner {
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .dismissal-info-banner-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .dismissal-info-banner-content {
            font-size: 13px;
            color: #1E40AF;
            line-height: 1.5;
        }

        .dismissal-info-banner-content strong {
            font-weight: 600;
        }

        .dismissal-form-section {
            margin-bottom: 20px;
        }

        .dismissal-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .dismissal-form-label-required {
            color: var(--brand-red);
            margin-left: 2px;
        }

        .dismissal-form-helper {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .dismissal-reason-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dismissal-reason-option {
            display: flex;
            align-items: flex-start;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .dismissal-reason-option:hover {
            border-color: var(--brand-teal);
            background: #F0FDFA;
        }

        .dismissal-reason-option.selected {
            border-color: var(--brand-teal);
            background: #F0FDFA;
            box-shadow: 0 0 0 3px rgba(85, 181, 184, 0.1);
        }

        .dismissal-reason-option.recommended {
            border-color: var(--brand-purple);
            background: #F5F3FF;
        }

        .dismissal-reason-option.recommended:hover {
            border-color: var(--brand-purple);
            background: #EDE9FE;
        }

        .dismissal-reason-option.recommended.selected {
            border-color: var(--brand-purple);
            background: #EDE9FE;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .dismissal-reason-radio {
            margin-right: 12px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .dismissal-reason-content {
            flex: 1;
        }

        .dismissal-reason-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dismissal-reason-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--brand-purple);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dismissal-reason-description {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .dismissal-free-text-area {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-family: 'Lato', sans-serif;
            font-size: 13px;
            color: var(--text-dark);
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .dismissal-free-text-area:focus {
            outline: none;
            border-color: var(--brand-teal);
            box-shadow: 0 0 0 3px rgba(85, 181, 184, 0.1);
        }

        .dismissal-free-text-area::placeholder {
            color: #9CA3AF;
        }

        .dismissal-modal-footer {
            padding: 16px 24px;
            background: #F9FAFB;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .dismissal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dismissal-btn-secondary {
            background: white;
            color: var(--text-dark);
            border: 2px solid #E5E7EB;
        }

        .dismissal-btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }

        .dismissal-btn-primary {
            background: var(--brand-red);
            color: white;
            box-shadow: 0 2px 4px rgba(228, 87, 64, 0.2);
        }

        .dismissal-btn-primary:hover {
            background: #C62828;
            box-shadow: 0 4px 8px rgba(228, 87, 64, 0.3);
        }

        .dismissal-btn-primary:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ==================== PHASE 3: POST-VISIT TASK LIST ==================== */
        .post-visit-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F8FAFC;
            z-index: 50;
            overflow-y: auto;
            padding: 20px;
        }
        .post-visit-overlay.active {
            display: block;
        }
        .pv-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--brand-teal);
        }
        .pv-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .pv-header .pv-close {
            background: none;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-muted);
        }
        .pv-header .pv-close:hover {
            background: #F3F4F6;
        }
        .pv-section {
            margin-bottom: 20px;
        }
        .pv-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .pv-section-header .pv-count {
            background: var(--brand-teal);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        .pv-task-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }
        .pv-task-card:hover {
            border-color: var(--brand-teal);
            box-shadow: 0 2px 8px rgba(85, 181, 184, 0.1);
        }
        .pv-task-card.completed {
            background: #F0FDF4;
            border-color: #BBF7D0;
        }
        .pv-task-card.in-progress {
            background: #FFF7ED;
            border-color: #FED7AA;
        }
        .pv-task-card.pending {
            background: white;
        }
        .pv-task-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        .pv-task-icon.green { background: #DCFCE7; color: #16A34A; }
        .pv-task-icon.orange { background: #FED7AA; color: #EA580C; }
        .pv-task-icon.blue { background: #DBEAFE; color: #2563EB; }
        .pv-task-icon.purple { background: #EDE9FE; color: #7C3AED; }
        .pv-task-icon.red { background: #FEE2E2; color: #DC2626; }
        .pv-task-icon.teal { background: #CCFBF1; color: #0D9488; }
        .pv-task-body {
            flex: 1;
            min-width: 0;
        }
        .pv-task-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        .pv-task-detail {
            font-size: 11px;
            color: var(--text-muted);
        }
        .pv-task-action {
            flex-shrink: 0;
        }
        .pv-task-action button {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        .pv-btn-schedule {
            background: var(--brand-teal);
            color: white;
        }
        .pv-btn-schedule:hover {
            background: #449A9C;
        }
        .pv-btn-automate {
            background: var(--brand-purple);
            color: white;
        }
        .pv-btn-automate:hover {
            background: #7C3AED;
        }
        .pv-btn-send {
            background: #2563EB;
            color: white;
        }
        .pv-btn-send:hover {
            background: #1D4ED8;
        }
        .pv-btn-done {
            background: #DCFCE7;
            color: #16A34A;
            cursor: default;
        }
        .pv-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .pv-status-badge.confirmed { background: #DCFCE7; color: #16A34A; }
        .pv-status-badge.dismissed { background: #FEE2E2; color: #DC2626; }
        .pv-status-badge.deferred { background: #EDE9FE; color: #7C3AED; }
        .pv-status-badge.pending { background: #FEF3C7; color: #D97706; }
        .pv-status-badge.automated { background: #DBEAFE; color: #2563EB; }

        /* Referral Scheduling Modal */
        .referral-schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .referral-schedule-modal.active {
            display: flex;
        }
        .rs-modal-content {
            background: white;
            border-radius: 12px;
            width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .rs-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .rs-modal-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .rs-modal-header .rs-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
        }
        .rs-modal-body {
            padding: 20px 24px;
        }
        .rs-step {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            background: #F8FAFC;
            border: 1px solid #E5E7EB;
        }
        .rs-step.active {
            background: #EFF6FF;
            border-color: #93C5FD;
        }
        .rs-step.completed {
            background: #F0FDF4;
            border-color: #BBF7D0;
        }
        .rs-step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #E5E7EB;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .rs-step.active .rs-step-number {
            background: #2563EB;
            color: white;
        }
        .rs-step.completed .rs-step-number {
            background: #16A34A;
            color: white;
        }
        .rs-step-content {
            flex: 1;
        }
        .rs-step-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        .rs-step-detail {
            font-size: 12px;
            color: var(--text-muted);
        }
        .rs-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .rs-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        .rs-btn-secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid #D1D5DB;
        }
        .rs-btn-primary {
            background: var(--brand-teal);
            color: white;
        }
        .rs-btn-primary:hover {
            background: #449A9C;
        }

        /* Communication Timeline */
        .comm-timeline {
            padding: 0;
            list-style: none;
        }
        .comm-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .comm-item:last-child {
            border-bottom: none;
        }
        .comm-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .comm-icon.call { background: #DCFCE7; color: #16A34A; }
        .comm-icon.sms { background: #DBEAFE; color: #2563EB; }
        .comm-icon.email { background: #FEF3C7; color: #D97706; }
        .comm-icon.auto { background: #EDE9FE; color: #7C3AED; }
        .comm-body {
            flex: 1;
        }
        .comm-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
        }
        .comm-detail {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .comm-time {
            font-size: 10px;
            color: #9CA3AF;
            flex-shrink: 0;
        }

        /* Florence Automation Indicator */
        .automation-pulse {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #EDE9FE, #DBEAFE);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: #7C3AED;
        }
        .automation-pulse::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #7C3AED;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }

        /* Post-Visit Summary Stats */
        .pv-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .pv-stat {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        .pv-stat-number {
            font-size: 20px;
            font-weight: 700;
        }
        .pv-stat-number.green { color: #16A34A; }
        .pv-stat-number.orange { color: #EA580C; }
        .pv-stat-number.red { color: #DC2626; }
        .pv-stat-number.purple { color: #7C3AED; }
        .pv-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 2px;
        }
    </style>
    
    <!-- Referral Scheduling Modal -->
    <div class="referral-schedule-modal" id="referral-schedule-modal">
        <div class="rs-modal-content">
            <div class="rs-modal-header">
                <h3 id="rs-modal-title">Schedule Referral</h3>
                <button class="rs-close" onclick="closeReferralModal()">&times;</button>
            </div>
            <div class="rs-modal-body" id="rs-modal-body">
                <!-- Steps rendered dynamically -->
            </div>
            <div class="rs-modal-footer">
                <button class="rs-btn rs-btn-secondary" onclick="closeReferralModal()">Cancel</button>
                <button class="rs-btn rs-btn-primary" id="rs-action-btn" onclick="advanceReferralStep()">Start Outreach</button>
            </div>
        </div>
    </div>

    <!-- Physician Acceptance Workflow Script (Inline for Demo) -->
    <script>
// Physician Acceptance Workflow JavaScript
// Handles staged items, batch sync, completion tracking, and staging preview

// ===== DATA STRUCTURES =====

// Track staged items and their status
const stagedItems = [];
const visitActions = {
    accepted: [],
    dismissed: [],
    edited: []
};

// ===== STAGED PROBLEMS FUNCTIONALITY =====

function renderStagedProblems() {
    const stagedContainer = document.getElementById('problem-list-staged');
    if (!stagedContainer) return;
    
    const stagedProblems = stagedItems.filter(item => item.type === 'problem');
    
    if (stagedProblems.length === 0) {
        stagedContainer.innerHTML = '';
        return;
    }
    
    let html = `
        <div class="staged-section-header">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
            STAGED PROBLEMS (${stagedProblems.length})
        </div>
    `;
    
    stagedProblems.forEach(problem => {
        html += `
            <div class="problem-item staged" data-gap-id="${problem.gapId}">
                <div class="problem-header">
                    <span class="problem-status staged"> STAGED</span>
                    <span class="problem-diagnosis">${problem.diagnosis} (${problem.icd10})</span>
                    ${problem.hccs.map(hcc => `<span class="hcc-badge">HCC ${hcc}</span>`).join('')}
                </div>
                <div class="problem-details">
                    <span class="staged-source">Source: Florence AI  ${new Date().toLocaleDateString()}</span>
                    <div class="problem-actions">
                        <button class="btn-approve" onclick="approveStagedItem('${problem.gapId}')">
                             Add to Problem List
                        </button>
                        <button class="btn-dismiss" onclick="dismissStagedProblem('${problem.gapId}')">
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    stagedContainer.innerHTML = html;
}

function approveStagedItem(gapId) {
    // Convert gapId to number to handle string/number mismatch
    gapId = parseInt(gapId);
    const problem = stagedItems.find(item => item.gapId === gapId);
    if (!problem) return;
    
    // Track action for batch sync
    visitActions.accepted.push({
        gapId: gapId,
        type: 'problem',
        diagnosis: problem.diagnosis,
        icd10: problem.icd10,
        hccs: problem.hccs,
        timestamp: new Date().toISOString(),
        action: 'added_to_problem_list'
    });
    
    // Remove from staged items
    const index = stagedItems.findIndex(item => item.gapId === gapId);
    if (index > -1) {
        stagedItems.splice(index, 1);
    }
    
    // Add to active problem list
    const problemListActive = document.getElementById('problem-list-active');
    if (problemListActive) {
        const newProblem = document.createElement('div');
        newProblem.className = 'problem-item active';
        newProblem.innerHTML = `
            <div class="problem-header">
                <span class="problem-status"> ACTIVE</span>
                <span class="problem-diagnosis">${problem.diagnosis} (${problem.icd10})</span>
                ${problem.hccs.map(hcc => `<span class="hcc-badge">HCC ${hcc}</span>`).join('')}
            </div>
            <div class="problem-details">
                <span>Onset: ${new Date().toLocaleDateString()}</span>
                <div class="problem-actions">
                    <button class="btn-link-small">Edit</button>
                    <button class="btn-link-small">Change Status</button>
                </div>
            </div>
        `;
        problemListActive.insertBefore(newProblem, problemListActive.firstChild);
    }
    
    // Re-render
    renderStagedProblems();
    updateCompletionTracker();
    
    // Show toast
    showToast(` ${problem.diagnosis} added to Problem List`, 'success');
    
    // Add log entry
    addLogEntry('Problem Added', `${problem.diagnosis} (${problem.icd10}) added to Problem List`);
}

// ===== MEAT CRITERIA EDITING =====

function editMeatCriteria(gapId) {
    const apBlock = document.getElementById('ap-staged-' + gapId);
    if (!apBlock) return;
    
    // Find the gap data
    const gap = gaps.find(g => g.id === gapId);
    if (!gap || !gap.meatText) return;
    
    const meat = gap.meatText;
    
    // Replace the plan text with editable textareas
    const apText = apBlock.querySelector('.ap-text');
    if (!apText) return;
    
    apText.innerHTML = `
        <div class="meat-edit-container" style="display: flex; flex-direction: column; gap: 8px;">
            <div class="meat-edit-field">
                <label style="font-size: 11px; font-weight: 700; color: #1a237e; text-transform: uppercase; letter-spacing: 0.5px;">Monitor</label>
                <textarea id="meat-monitor-${gapId}" style="width: 100%; min-height: 50px; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical; background: #fff;">${meat.monitor}</textarea>
            </div>
            <div class="meat-edit-field">
                <label style="font-size: 11px; font-weight: 700; color: #1a237e; text-transform: uppercase; letter-spacing: 0.5px;">Evaluate</label>
                <textarea id="meat-evaluate-${gapId}" style="width: 100%; min-height: 50px; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical; background: #fff;">${meat.evaluate}</textarea>
            </div>
            <div class="meat-edit-field">
                <label style="font-size: 11px; font-weight: 700; color: #1a237e; text-transform: uppercase; letter-spacing: 0.5px;">Assess</label>
                <textarea id="meat-assess-${gapId}" style="width: 100%; min-height: 50px; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical; background: #fff;">${meat.assess}</textarea>
            </div>
            <div class="meat-edit-field">
                <label style="font-size: 11px; font-weight: 700; color: #1a237e; text-transform: uppercase; letter-spacing: 0.5px;">Treat</label>
                <textarea id="meat-treat-${gapId}" style="width: 100%; min-height: 50px; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical; background: #fff;">${meat.treat}</textarea>
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px;">
                <button onclick="cancelMeatEdit(${gapId})" style="padding: 6px 16px; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #666; cursor: pointer; font-size: 12px;">Cancel</button>
                <button onclick="saveMeatEdit(${gapId})" style="padding: 6px 16px; border: none; border-radius: 4px; background: #1a237e; color: white; cursor: pointer; font-size: 12px; font-weight: 600;">Save Changes</button>
            </div>
        </div>
    `;
    
    // Change the Edit button to show "Editing..."
    const editBtn = apBlock.querySelector('.btn-link-small');
    if (editBtn) {
        editBtn.textContent = 'Editing...';
        editBtn.style.color = '#e65100';
        editBtn.onclick = null;
    }
    
    // Add log entry
    addLogEntry('MEAT Edit', `Physician editing MEAT criteria for ${gap.title}`);
}

function saveMeatEdit(gapId) {
    const gap = gaps.find(g => g.id === gapId);
    if (!gap) return;
    
    // Get edited values
    const monitor = document.getElementById('meat-monitor-' + gapId).value;
    const evaluate = document.getElementById('meat-evaluate-' + gapId).value;
    const assess = document.getElementById('meat-assess-' + gapId).value;
    const treat = document.getElementById('meat-treat-' + gapId).value;
    
    // Track what changed
    const changes = [];
    if (monitor !== gap.meatText.monitor) changes.push('Monitor');
    if (evaluate !== gap.meatText.evaluate) changes.push('Evaluate');
    if (assess !== gap.meatText.assess) changes.push('Assess');
    if (treat !== gap.meatText.treat) changes.push('Treat');
    
    // Update the gap data
    gap.meatText.monitor = monitor;
    gap.meatText.evaluate = evaluate;
    gap.meatText.assess = assess;
    gap.meatText.treat = treat;
    
    // Track the edit in visitActions
    visitActions.edited.push({
        gapId: gapId,
        diagnosis: gap.title,
        icd10: gap.icd,
        fieldsChanged: changes,
        timestamp: new Date().toISOString(),
        editedBy: 'Dr. Campbell'
    });
    
    // Re-render the A&P block with updated text
    const apBlock = document.getElementById('ap-staged-' + gapId);
    if (apBlock) {
        const apText = apBlock.querySelector('.ap-text');
        if (apText) {
            apText.innerHTML = `
                <div class="meat-section"><strong>Monitor:</strong> ${monitor}</div>
                <div class="meat-section"><strong>Evaluate:</strong> ${evaluate}</div>
                <div class="meat-section"><strong>Assess:</strong> ${assess}</div>
                <div class="meat-section"><strong>Treat:</strong> ${treat}</div>
                <div style="margin-top: 6px; padding: 4px 8px; background: #e8f5e9; border-radius: 4px; font-size: 11px; color: #2e7d32;">
                     Edited by Dr. Campbell  ${changes.length > 0 ? 'Modified: ' + changes.join(', ') : 'No changes'}  ${new Date().toLocaleTimeString()}
                </div>
            `;
        }
        
        // Reset the Edit button
        const editBtn = apBlock.querySelector('.btn-link-small');
        if (editBtn) {
            editBtn.textContent = 'Edit';
            editBtn.style.color = '';
            editBtn.onclick = function() { editMeatCriteria(gapId); };
        }
    }
    
    // Show toast
    if (changes.length > 0) {
        showToast(` MEAT criteria updated for ${gap.title} (${changes.join(', ')})`, 'success');
    } else {
        showToast(`No changes made to ${gap.title}`, 'info');
    }
    
    // Add log entry
    addLogEntry('MEAT Saved', `Dr. Campbell saved MEAT edits for ${gap.title}${changes.length > 0 ? ' (Modified: ' + changes.join(', ') + ')' : ''}`);
}

function cancelMeatEdit(gapId) {
    const gap = gaps.find(g => g.id === gapId);
    if (!gap || !gap.meatText) return;
    
    const apBlock = document.getElementById('ap-staged-' + gapId);
    if (apBlock) {
        const apText = apBlock.querySelector('.ap-text');
        if (apText) {
            // Restore original MEAT text
            apText.innerHTML = `
                <div class="meat-section"><strong>Monitor:</strong> ${gap.meatText.monitor}</div>
                <div class="meat-section"><strong>Evaluate:</strong> ${gap.meatText.evaluate}</div>
                <div class="meat-section"><strong>Assess:</strong> ${gap.meatText.assess}</div>
                <div class="meat-section"><strong>Treat:</strong> ${gap.meatText.treat}</div>
            `;
        }
        
        // Reset the Edit button
        const editBtn = apBlock.querySelector('.btn-link-small');
        if (editBtn) {
            editBtn.textContent = 'Edit';
            editBtn.style.color = '';
            editBtn.onclick = function() { editMeatCriteria(gapId); };
        }
    }
}


// ===== DISMISSAL MODAL FUNCTIONS =====

// Global variable to track current dismissal
let currentDismissalGapId = null;

// Determine smart default dismissal reason based on gap type
function getSmartDefaultReason(gap) {
    if (!gap) return 'duplicate';
    
    // For diagnosis gaps (HCC-bearing conditions), default to "duplicate"
    if (gap.hcc && gap.hcc > 0) {
        return 'duplicate';
    }
    
    // For screening/quality gaps, default to "patient-refused"
    if (gap.category === 'Quality' || gap.type === 'screening') {
        return 'patient-refused';
    }
    
    // For frailty assessments, default to "timing"
    if (gap.category === 'Frailty') {
        return 'timing';
    }
    
    // Default fallback
    return 'duplicate';
}

// Show dismissal modal
function showDismissalModal(gapId) {
    // Prevent duplicate modal
    const existingModal = document.getElementById('dismissal-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }
    
    currentDismissalGapId = gapId;
    const problem = stagedItems.find(item => item.gapId === parseInt(gapId));
    if (!problem) return;
    
    // Determine smart default reason
    const defaultReason = getSmartDefaultReason(problem);
    
    // Create modal HTML
    const modalHTML = `
        <div class="dismissal-modal-overlay active" id="dismissal-modal-overlay">
            <div class="dismissal-modal">
                <!-- Modal Header -->
                <div class="dismissal-modal-header">
                    <div class="dismissal-modal-header-icon"></div>
                    <div class="dismissal-modal-header-content">
                        <h3>Confirm Gap Dismissal</h3>
                        <p>Help us improve AI recommendations</p>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="dismissal-modal-body">
                    <!-- Gap Info Card -->
                    <div class="dismissal-gap-info-card">
                        <div class="dismissal-gap-info-title">${problem.diagnosis}</div>
                        <div class="dismissal-gap-info-details">
                            ${problem.icd10 ? `<div class="dismissal-gap-info-detail"><strong>ICD-10:</strong> ${problem.icd10}</div>` : ''}
                            ${problem.hcc ? `<div class="dismissal-gap-info-detail"><strong>HCC:</strong> ${problem.hcc}</div>` : ''}
                            <div class="dismissal-gap-info-detail"><strong>Source:</strong> Florence AI</div>
                        </div>
                    </div>

                    <!-- Info Banner -->
                    <div class="dismissal-info-banner">
                        <div class="dismissal-info-banner-icon"></div>
                        <div class="dismissal-info-banner-content">
                            <strong>Your feedback helps Florence learn.</strong> Dismissal reasons improve AI accuracy for all providers.
                        </div>
                    </div>

                    <!-- Dismissal Reason Section -->
                    <div class="dismissal-form-section">
                        <label class="dismissal-form-label">
                            Why are you dismissing this gap?
                            <span class="dismissal-form-label-required">*</span>
                        </label>
                        <div class="dismissal-reason-options">
                            <!-- Duplicate - Already Documented -->
                            <label class="dismissal-reason-option ${defaultReason === 'duplicate' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="duplicate" class="dismissal-reason-radio" ${defaultReason === 'duplicate' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Duplicate - Already Documented
                                        ${defaultReason === 'duplicate' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        This diagnosis is already in the problem list or documented elsewhere
                                    </div>
                                </div>
                            </label>

                            <!-- Incorrect Diagnosis -->
                            <label class="dismissal-reason-option ${defaultReason === 'incorrect' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="incorrect" class="dismissal-reason-radio" ${defaultReason === 'incorrect' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Incorrect Diagnosis
                                        ${defaultReason === 'incorrect' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        Patient does not have this condition or AI suggestion is clinically incorrect
                                    </div>
                                </div>
                            </label>

                            <!-- Patient Refused -->
                            <label class="dismissal-reason-option ${defaultReason === 'patient-refused' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="patient-refused" class="dismissal-reason-radio" ${defaultReason === 'patient-refused' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Patient Refused
                                        ${defaultReason === 'patient-refused' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        Patient declined screening, testing, or documentation of this condition
                                    </div>
                                </div>
                            </label>

                            <!-- Clinically Inappropriate -->
                            <label class="dismissal-reason-option ${defaultReason === 'inappropriate' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="inappropriate" class="dismissal-reason-radio" ${defaultReason === 'inappropriate' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Clinically Inappropriate
                                        ${defaultReason === 'inappropriate' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        Not appropriate for this patient's clinical situation or care plan
                                    </div>
                                </div>
                            </label>

                            <!-- Timing Issue -->
                            <label class="dismissal-reason-option ${defaultReason === 'timing' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="timing" class="dismissal-reason-radio" ${defaultReason === 'timing' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Timing Issue
                                        ${defaultReason === 'timing' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        Will address in a future visit or not appropriate for today's encounter
                                    </div>
                                </div>
                            </label>

                            <!-- Other Reason -->
                            <label class="dismissal-reason-option ${defaultReason === 'other' ? 'recommended selected' : ''}">
                                <input type="radio" name="dismissal-reason" value="other" class="dismissal-reason-radio" ${defaultReason === 'other' ? 'checked' : ''}>
                                <div class="dismissal-reason-content">
                                    <div class="dismissal-reason-title">
                                        Other Reason
                                        ${defaultReason === 'other' ? '<span class="dismissal-reason-badge">Recommended</span>' : ''}
                                    </div>
                                    <div class="dismissal-reason-description">
                                        Different reason not listed above
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Optional Free Text Section -->
                    <div class="dismissal-form-section">
                        <label class="dismissal-form-label">
                            Additional Comments (Optional)
                        </label>
                        <textarea 
                            id="dismissal-comments"
                            class="dismissal-free-text-area" 
                            placeholder="Add any additional context or details that would help improve Florence's recommendations..."
                            maxlength="500"
                        ></textarea>
                        <div class="dismissal-form-helper">Maximum 500 characters</div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="dismissal-modal-footer">
                    <button class="dismissal-btn dismissal-btn-secondary" onclick="closeDismissalModal()">
                        Cancel
                    </button>
                    <button class="dismissal-btn dismissal-btn-primary" onclick="confirmDismissal()">
                        <span></span>
                        Confirm Dismissal
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add click handlers for radio options
    document.querySelectorAll('.dismissal-reason-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.dismissal-reason-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input[type="radio"]').checked = true;
        });
    });
    
    // Close modal on overlay click
    document.getElementById('dismissal-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDismissalModal();
        }
    });
}

// Close dismissal modal
function closeDismissalModal() {
    const overlay = document.getElementById('dismissal-modal-overlay');
    if (overlay) {
        overlay.remove();
    }
    currentDismissalGapId = null;
}

// Confirm dismissal with reason
function confirmDismissal() {
    if (currentDismissalGapId === null) return;
    
    // Get selected reason
    const selectedReason = document.querySelector('input[name="dismissal-reason"]:checked');
    if (!selectedReason) {
        alert('Please select a dismissal reason');
        return;
    }
    
    const reason = selectedReason.value;
    const comments = document.getElementById('dismissal-comments').value.trim();
    
    // Get gap details
    const gapId = parseInt(currentDismissalGapId);
    const problem = stagedItems.find(item => item.gapId === gapId);
    if (!problem) return;
    
    // Track action for batch sync with enhanced data
    visitActions.dismissed.push({
        gapId: gapId,
        type: 'problem',
        diagnosis: problem.diagnosis,
        icd10: problem.icd10,
        hcc: problem.hcc,
        category: problem.category,
        timestamp: new Date().toISOString(),
        action: 'dismissed',
        dismissalReason: reason,
        dismissalComments: comments,
        dismissedBy: 'Dr. Campbell' // In production, get from session
    });
    
    // Remove from staged items
    const index = stagedItems.findIndex(item => item.gapId === gapId);
    if (index > -1) {
        stagedItems.splice(index, 1);
    }
    
    // Re-render
    renderStagedProblems();
    updateCompletionTracker();
    
    // Show toast with reason
    const reasonLabels = {
        'duplicate': 'Duplicate - Already Documented',
        'incorrect': 'Incorrect Diagnosis',
        'patient-refused': 'Patient Refused',
        'inappropriate': 'Clinically Inappropriate',
        'timing': 'Timing Issue',
        'other': 'Other Reason'
    };
    showToast(`${problem.diagnosis} dismissed: ${reasonLabels[reason]}`, 'info');
    
    // Add log entry with reason
    addLogEntry('Problem Dismissed', `${problem.diagnosis} (${problem.icd10}) dismissed by provider. Reason: ${reasonLabels[reason]}${comments ? '. Comments: ' + comments : ''}`);
    
    // Close modal
    closeDismissalModal();
}

// dismissStagedProblem is defined in the main script block above
// It includes duplicate modal prevention and calls showDismissalModal()


// ===== COMPLETION TRACKER =====

function renderCompletionTracker() {
    const container = document.getElementById('completion-tracker-container');
    if (!container) return;
    
    const totalGaps = 10; // From the original gaps list
    const accepted = visitActions.accepted.length;
    const dismissed = visitActions.dismissed.length;
    const pending = totalGaps - accepted - dismissed;
    const completionRate = Math.round((accepted / totalGaps) * 100);
    
    const html = `
        <div class="completion-tracker">
            <div class="completion-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                </svg>
                CCA Completion Status
            </div>
            <div class="completion-stats">
                <div class="completion-stat">
                    <div class="completion-stat-icon accepted"></div>
                    <div>
                        <div style="font-weight: 600; color: #43A047;">${accepted}</div>
                        <div style="font-size: 10px; color: #757575;">Accepted</div>
                    </div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-icon dismissed"></div>
                    <div>
                        <div style="font-weight: 600; color: #C62828;">${dismissed}</div>
                        <div style="font-size: 10px; color: #757575;">Dismissed</div>
                    </div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-icon pending"></div>
                    <div>
                        <div style="font-weight: 600; color: #F57C00;">${pending}</div>
                        <div style="font-size: 10px; color: #757575;">Pending</div>
                    </div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-icon edited"></div>
                    <div>
                        <div style="font-weight: 600; color: #1976D2;">${visitActions.edited.length}</div>
                        <div style="font-size: 10px; color: #757575;">Edited</div>
                    </div>
                </div>
            </div>
            <div class="completion-progress">
                <div class="completion-progress-bar" style="width: ${completionRate}%"></div>
            </div>
            <div class="completion-summary">
                Overall CCA Completion: ${accepted}/${totalGaps} gaps documented (${completionRate}%)
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function updateCompletionTracker() {
    renderCompletionTracker();
}

// ===== STAGING PREVIEW MODAL =====

function showStagingPreview(gapData) {
    const modal = document.createElement('div');
    modal.className = 'staging-preview-modal';
    modal.id = 'staging-preview-modal';
    
    modal.innerHTML = `
        <div class="staging-preview-content">
            <div class="staging-preview-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Staging Preview
            </div>
            
            <div class="staging-preview-section">
                <div class="staging-preview-section-title">
                     Problem List Entry
                </div>
                <div class="staging-preview-item">
                    <strong>${gapData.diagnosis} (${gapData.icd10})</strong><br>
                    ${gapData.hccs.map(hcc => `HCC ${hcc}`).join(', ')}<br>
                    <span style="color: #757575;">Status: STAGED (awaiting physician approval)</span>
                </div>
            </div>
            
            <div class="staging-preview-section">
                <div class="staging-preview-section-title">
                     Assessment & Plan Block
                </div>
                <div class="staging-preview-item">
                    <strong>1. ${gapData.diagnosis} (${gapData.icd10})</strong><br>
                    ${gapData.hccs.map(hcc => `HCC ${hcc}`).join(', ')}<br><br>
                    <strong>Assessment:</strong><br>
                    ${gapData.assessment || 'Assessment text will be generated based on MEAT criteria...'}
                </div>
            </div>
            
            ${gapData.orders && gapData.orders.length > 0 ? `
            <div class="staging-preview-section">
                <div class="staging-preview-section-title">
                     Orders (${gapData.orders.length})
                </div>
                ${gapData.orders.map(order => `
                    <div class="staging-preview-item">
                         ${order}
                    </div>
                `).join('')}
            </div>
            ` : ''}
            
            <div class="staging-preview-footer">
                <div class="staging-preview-time">
                    Estimated Provider Review Time: 30 seconds
                </div>
                <div class="staging-preview-actions">
                    <button class="modal-btn cancel" onclick="closeStagingPreview()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmStaging('${gapData.gapId}')">Confirm Stage</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeStagingPreview() {
    const modal = document.getElementById('staging-preview-modal');
    if (modal) {
        modal.remove();
    }
}

function confirmStaging(gapId) {
    // Add to staged items
    const gapData = careGaps.find(gap => gap.id === gapId);
    if (gapData) {
        stagedItems.push({
            gapId: gapData.id,
            type: 'problem',
            diagnosis: gapData.title,
            icd10: gapData.icd10,
            hccs: gapData.hcc ? [gapData.hcc] : [],
            assessment: gapData.details,
            orders: gapData.orders || [],
            stagedAt: new Date().toISOString()
        });
        
        // Re-render
        renderStagedProblems();
        updateCompletionTracker();
        
        // Show toast
        showToast(` ${gapData.title} staged for provider review`, 'success');
        
        // Add log entry
        addLogEntry('Gap Staged', `${gapData.title} staged for provider review`);
    }
    
    closeStagingPreview();
    closeModal();
}

// ===== BATCH SYNC MECHANISM =====

function showSyncIndicator(status, message) {
    let indicator = document.getElementById('sync-indicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'sync-indicator';
        indicator.className = 'sync-indicator';
        document.body.appendChild(indicator);
    }
    
    if (status === 'syncing') {
        indicator.className = 'sync-indicator syncing';
        indicator.innerHTML = `
            <div class="sync-indicator-icon"></div>
            <div class="sync-indicator-text">
                <div class="sync-indicator-title">Syncing to CCA...</div>
                <div class="sync-indicator-subtitle">${message}</div>
            </div>
        `;
    } else if (status === 'success') {
        indicator.className = 'sync-indicator';
        indicator.innerHTML = `
            <div class="sync-indicator-icon"></div>
            <div class="sync-indicator-text">
                <div class="sync-indicator-title">Sync Complete</div>
                <div class="sync-indicator-subtitle">${message}</div>
            </div>
        `;
        
        setTimeout(() => {
            indicator.remove();
        }, 3000);
    } else if (status === 'error') {
        indicator.className = 'sync-indicator';
        indicator.innerHTML = `
            <div class="sync-indicator-icon" style="background: #FFEBEE; color: #C62828;"></div>
            <div class="sync-indicator-text">
                <div class="sync-indicator-title">Sync Failed</div>
                <div class="sync-indicator-subtitle">${message}</div>
            </div>
        `;
        
        setTimeout(() => {
            indicator.remove();
        }, 5000);
    }
}

async function batchSyncToCCA() {
    const totalActions = visitActions.accepted.length + visitActions.dismissed.length + visitActions.edited.length;
    
    if (totalActions === 0) {
        console.log('No actions to sync');
        return;
    }
    
    showSyncIndicator('syncing', `Syncing ${totalActions} actions...`);
    
    // Simulate API call (replace with actual API endpoint)
    const syncData = {
        visit_id: `visit_${Date.now()}`,
        provider_id: 'prov_12345',
        timestamp: new Date().toISOString(),
        gaps: [
            ...visitActions.accepted.map(action => ({
                ...action,
                status: 'accepted_and_documented'
            })),
            ...visitActions.dismissed.map(action => ({
                ...action,
                status: 'dismissed'
            })),
            ...visitActions.edited.map(action => ({
                ...action,
                status: 'accepted_with_edits'
            }))
        ]
    };
    
    console.log('Batch sync data:', syncData);
    
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Simulate success
    showSyncIndicator('success', `${totalActions} actions synced to CCA`);
    
    // Add log entry
    addLogEntry('CCA Synced', `${totalActions} gap actions synced to CCA form`);
    
    // In production, this would be:
    // try {
    //     const response = await fetch('/api/cca/visits/sync', {
    //         method: 'POST',
    //         headers: { 'Content-Type': 'application/json' },
    //         body: JSON.stringify(syncData)
    //     });
    //     
    //     if (response.ok) {
    //         showSyncIndicator('success', `${totalActions} actions synced to CCA`);
    //     } else {
    //         throw new Error('Sync failed');
    //     }
    // } catch (error) {
    //     showSyncIndicator('error', 'Failed to sync. Please try again.');
    // }
}

// ===== HOOK INTO SIGN & CLOSE BUTTON =====

function setupBatchSync() {
    const signCloseButton = document.querySelector('.btn-sign');
    if (signCloseButton) {
        signCloseButton.addEventListener('click', async function(e) {
            // Perform batch sync before closing
            await batchSyncToCCA();
            
            // Then proceed with normal sign & close
            // (In production, this would actually close the visit)
        });
    }
}

// ===== INITIALIZE =====

document.addEventListener('DOMContentLoaded', function() {
    // Add completion tracker container to Florence panel
    const florenceTabs = document.querySelector('.florence-tabs');
    if (florenceTabs && florenceTabs.nextElementSibling) {
        const trackerContainer = document.createElement('div');
        trackerContainer.id = 'completion-tracker-container';
        florenceTabs.parentNode.insertBefore(trackerContainer, florenceTabs.nextElementSibling);
        renderCompletionTracker();
    }
    
    // Setup batch sync
    setupBatchSync();
    
    // Initial render
    renderStagedProblems();
});

// ===== HELPER FUNCTIONS =====

function showToast(message, type = 'info') {
    // Reuse existing toast function or create simple one
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#43A047' : type === 'error' ? '#C62828' : '#55B5B8'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function addLogEntry(title, description) {
    // Add to log container if it exists
    const logContainer = document.getElementById('log-container');
    if (logContainer) {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        logItem.innerHTML = `
            <div class="log-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="log-content">
                <h4>${title}</h4>
                <p>${description}</p>
            </div>
            <span class="log-time">Just now</span>
        `;
        logContainer.insertBefore(logItem, logContainer.firstChild);
    }
}

    </script>

    <!-- Sync Functionality Script -->
    <script>
// ===== SYNC FUNCTIONALITY =====
// Syncs physician documentation from athenaOne back to Florence

function addSyncButton() {
    // Attach event listener to existing sync button
    const syncButton = document.getElementById('sync-button');
    if (!syncButton) {
        console.error('Sync button not found in DOM');
        return;
    }
    
    // Attach click handler
    syncButton.onclick = performSync;
    console.log('Sync button event listener attached');
}

window.performSync = async function() {
    const syncButton = document.getElementById('sync-button');
    if (!syncButton) return;
    
    // Show syncing state
    syncButton.classList.add('syncing');
    syncButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
        </svg>
        Syncing...
    `;
    
    // Simulate sync delay (in real app, this would be API call)
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Extract documentation from athenaOne DOM
    const syncResults = extractDocumentationFromAthena();
    
    // Reset button
    syncButton.classList.remove('syncing');
    syncButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
        </svg>
        Sync from athenaOne
    `;
    
    // Show sync report
    showSyncReport(syncResults);
    
    // Add log entry (if function exists)
    if (typeof addLogEntry === 'function') {
        addLogEntry('Sync Complete', `Synced ${syncResults.confirmed.length + syncResults.dismissed.length + syncResults.pending.length} gaps from athenaOne`);
    }
}

function extractDocumentationFromAthena() {
    // Extract what the physician actually documented in athenaOne
    const results = {
        confirmed: [],
        dismissed: [],
        pending: []
    };
    
    // Get all active problems from Problem List
    const activeProblemElements = document.querySelectorAll('#problem-list .problem-item:not(.staged)');
    const stagedProblemElements = document.querySelectorAll('#problem-list-staged .problem-item.staged');
    
    // Get A&P documentation
    const apElements = document.querySelectorAll('#ap-container .ap-block');
    
    // Match staged items with what was documented
    if (typeof gaps !== 'undefined') {
        gaps.forEach(gap => {
            if (gap.staged) {
                // FIRST: Check if physician accepted it in current session
                const acceptedInSession = visitActions && visitActions.accepted && 
                    visitActions.accepted.some(action => action.gapId === gap.id);
                
                // Check if it was added to active problems
                const isInProblemList = Array.from(activeProblemElements).some(el => 
                    el.textContent.includes(gap.title) || el.textContent.includes(gap.icd)
                );
                
                // Check if there's A&P documentation
                const hasAPDoc = Array.from(apElements).some(el => 
                    el.textContent.includes(gap.title) || el.textContent.includes(gap.icd)
                );
                
                if (acceptedInSession || isInProblemList || hasAPDoc) {
                    // Confirmed and documented
                    results.confirmed.push({
                        id: gap.id,
                        title: gap.title,
                        icd: gap.icd,
                        hcc: gap.hcc,
                        documentation: extractDocumentation(gap, apElements),
                        problemListAdded: isInProblemList,
                        apDocumented: hasAPDoc
                    });
                } else {
                    // FIRST: Check if physician dismissed it in current session
                    const dismissedInSession = visitActions && visitActions.dismissed && 
                        visitActions.dismissed.some(action => action.gapId === gap.id);
                    
                    if (dismissedInSession) {
                        results.dismissed.push({
                            id: gap.id,
                            title: gap.title,
                            icd: gap.icd,
                            hcc: gap.hcc,
                            reason: 'Dismissed by physician'
                        });
                    } else {
                        // Check if still staged (pending) or removed (dismissed)
                        const isStillStaged = Array.from(stagedProblemElements).some(el => 
                            el.textContent.includes(gap.title) || el.textContent.includes(gap.icd)
                        );
                        
                        if (isStillStaged) {
                            results.pending.push({
                                id: gap.id,
                                title: gap.title,
                                icd: gap.icd,
                                hcc: gap.hcc,
                                reason: 'Still awaiting physician review'
                            });
                        } else {
                            results.dismissed.push({
                                id: gap.id,
                                title: gap.title,
                                icd: gap.icd,
                                hcc: gap.hcc,
                                reason: 'Not documented by physician'
                            });
                        }
                    }
                }
            } else {
                // Not staged yet
                results.pending.push({
                    id: gap.id,
                    title: gap.title,
                    icd: gap.icd,
                    hcc: gap.hcc,
                    reason: 'Not yet staged for review'
                });
            }
        });
    }
    
    return results;
}

function extractDocumentation(gap, apElements) {
    // Extract the actual documentation text for this gap
    const relevantBlock = Array.from(apElements).find(el => 
        el.textContent.includes(gap.title) || el.textContent.includes(gap.icd)
    );
    
    if (relevantBlock) {
        // Get the text content, clean it up
        const text = relevantBlock.textContent.trim();
        return text.length > 300 ? text.substring(0, 300) + '...' : text;
    }
    
    return 'No detailed documentation found';
}

function showSyncReport(results) {
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'sync-report-modal';
    modal.id = 'sync-report-modal';
    
    const totalGaps = results.confirmed.length + results.dismissed.length + results.pending.length;
    const completionRate = totalGaps > 0 ? Math.round((results.confirmed.length / totalGaps) * 100) : 0;
    
    modal.innerHTML = `
        <div class="sync-report-content">
            <div class="sync-report-header">
                <div class="sync-report-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                    </svg>
                    Sync Report - ${new Date().toLocaleString()}
                </div>
                <button class="sync-report-close" onclick="closeSyncReport()"></button>
            </div>
            
            <div class="sync-report-body">
                <div class="sync-report-summary">
                    <div class="sync-stat-card">
                        <div class="sync-stat-icon confirmed"></div>
                        <div class="sync-stat-value">${results.confirmed.length}</div>
                        <div class="sync-stat-label">Confirmed & Documented</div>
                    </div>
                    <div class="sync-stat-card">
                        <div class="sync-stat-icon dismissed"></div>
                        <div class="sync-stat-value">${results.dismissed.length}</div>
                        <div class="sync-stat-label">Dismissed</div>
                    </div>
                    <div class="sync-stat-card">
                        <div class="sync-stat-icon pending"></div>
                        <div class="sync-stat-value">${results.pending.length}</div>
                        <div class="sync-stat-label">Pending Review</div>
                    </div>
                </div>
                
                <div style="background: #E8F5E9; border-left: 4px solid #43A047; padding: 12px 16px; border-radius: 6px; margin-bottom: 24px;">
                    <strong style="color: #2E7D32;">CCA Completion: ${completionRate}%</strong>
                    <div style="font-size: 12px; color: #558B2F; margin-top: 4px;">
                        ${results.confirmed.length} of ${totalGaps} gaps documented by physician
                    </div>
                </div>
                
                ${results.confirmed.length > 0 ? `
                <div class="sync-report-section">
                    <div class="sync-report-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#43A047" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Confirmed & Documented (${results.confirmed.length})
                    </div>
                    ${results.confirmed.map(gap => `
                        <div class="sync-gap-item confirmed">
                            <div class="sync-gap-header">
                                <div>
                                    <div class="sync-gap-title">${gap.title}</div>
                                    <div class="sync-gap-code">${gap.icd} ${gap.hcc ? ' ' + gap.hcc : ''}</div>
                                </div>
                                <span class="sync-gap-badge confirmed"> Documented</span>
                            </div>
                            ${gap.problemListAdded ? '<div style="font-size: 12px; color: #43A047; margin-bottom: 8px;"> Added to Problem List</div>' : ''}
                            ${gap.apDocumented ? '<div style="font-size: 12px; color: #43A047; margin-bottom: 8px;"> A&P Block Documented</div>' : ''}
                            ${gap.documentation && gap.documentation !== 'No detailed documentation found' ? `
                            <div class="sync-gap-documentation">
                                <div class="sync-gap-doc-label">Physician Documentation:</div>
                                <div class="sync-gap-doc-text">${gap.documentation}</div>
                            </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${results.dismissed.length > 0 ? `
                <div class="sync-report-section">
                    <div class="sync-report-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#C62828" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Dismissed (${results.dismissed.length})
                    </div>
                    ${results.dismissed.map(gap => `
                        <div class="sync-gap-item dismissed">
                            <div class="sync-gap-header">
                                <div>
                                    <div class="sync-gap-title">${gap.title}</div>
                                    <div class="sync-gap-code">${gap.icd} ${gap.hcc ? ' ' + gap.hcc : ''}</div>
                                </div>
                                <span class="sync-gap-badge dismissed"> Not Documented</span>
                            </div>
                            <div style="font-size: 12px; color: #C62828; margin-top: 8px;">
                                ${gap.reason}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${results.pending.length > 0 ? `
                <div class="sync-report-section">
                    <div class="sync-report-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F57C00" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Pending Review (${results.pending.length})
                    </div>
                    ${results.pending.map(gap => `
                        <div class="sync-gap-item pending">
                            <div class="sync-gap-header">
                                <div>
                                    <div class="sync-gap-title">${gap.title}</div>
                                    <div class="sync-gap-code">${gap.icd} ${gap.hcc ? ' ' + gap.hcc : ''}</div>
                                </div>
                                <span class="sync-gap-badge pending"> Pending</span>
                            </div>
                            <div style="font-size: 12px; color: #F57C00; margin-top: 8px;">
                                ${gap.reason}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeSyncReport();
        }
    });
}

window.closeSyncReport = function() {
    const modal = document.getElementById('sync-report-modal');
    if (modal) {
        modal.remove();
    }
}

// Initialize sync button when page loads
// Use a more robust approach that waits for the button to exist
function initializeSyncButton() {
    const syncButton = document.getElementById('sync-button');
    if (syncButton) {
        syncButton.addEventListener('click', performSync);
        console.log(' Sync button event listener attached successfully');
    } else {
        console.error(' Sync button not found - retrying in 100ms');
        setTimeout(initializeSyncButton, 100);
    }
}

// Start initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSyncButton);
} else {
        initializeSyncButton();
    }

// Execute the sync button initialization
addSyncButton();

// ==================== PHASE 3: POST-VISIT TASK LIST & AUTOMATION ====================

// Post-visit state
let postVisitTasks = [];
let communicationLog = [];
let referralSchedulingState = { step: 0, referralType: '', taskId: null };

// Show post-visit task list
function showPostVisitView() {
    const overlay = document.getElementById('post-visit-overlay');
    if (overlay) {
        overlay.classList.add('active');
        buildPostVisitTasks();
        renderPostVisitTasks();
        renderCommunicationTimeline();
        if (typeof addLogEntry === 'function') {
            addLogEntry('Post-Visit View', 'Navigator opened post-visit task list');
        }
    }
}

function closePostVisitView() {
    const overlay = document.getElementById('post-visit-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
}

// Build tasks from current gap states
function buildPostVisitTasks() {
    postVisitTasks = [];
    
    // Get gaps from the main script scope
    const allGaps = window.gaps || [];
    
    // Confirmed diagnoses (staged and accepted by physician)
    allGaps.forEach(gap => {
        if (gap.staged && (gap.type === 'recapture' || gap.type === 'suspect')) {
            postVisitTasks.push({
                id: 'confirmed-' + gap.id,
                section: 'confirmed',
                title: gap.title,
                detail: gap.icd ? `${gap.icd} - Added to problem list` : gap.description.substring(0, 60) + '...',
                icon: 'green',
                iconText: '\u2713',
                status: 'confirmed',
                gapId: gap.id
            });
        }
    });
    
    // Pending orders / referrals
    const pendingOrders = [
        {
            id: 'order-bmp',
            section: 'orders',
            title: 'BMP Lab Order',
            detail: 'Basic Metabolic Panel - CKD monitoring (eGFR 42)',
            icon: 'blue',
            iconText: '\uD83E\uDDEA',
            status: 'pending',
            automatable: true,
            automationType: 'lab'
        },
        {
            id: 'order-a1c',
            section: 'orders',
            title: 'HbA1c Lab Order',
            detail: 'Hemoglobin A1c - Diabetes monitoring (last: 8.9%)',
            icon: 'blue',
            iconText: '\uD83E\uDDEA',
            status: 'pending',
            automatable: true,
            automationType: 'lab'
        },
        {
            id: 'referral-nephro',
            section: 'referrals',
            title: 'Nephrology Referral',
            detail: 'CKD Stage 3a management - eGFR 42 mL/min',
            icon: 'orange',
            iconText: '\uD83C\uDFE5',
            status: 'pending',
            schedulable: true,
            referralType: 'nephrology'
        },
        {
            id: 'referral-statin',
            section: 'referrals',
            title: 'Statin Therapy Follow-up',
            detail: 'Atorvastatin 20mg initiated - 6-week lipid panel needed',
            icon: 'orange',
            iconText: '\uD83D\uDC8A',
            status: 'pending',
            automatable: true,
            automationType: 'followup'
        }
    ];
    postVisitTasks.push(...pendingOrders);
    
    // Dismissed gaps
    allGaps.forEach(gap => {
        if (gap.dismissed) {
            postVisitTasks.push({
                id: 'dismissed-' + gap.id,
                section: 'dismissed',
                title: gap.title + ' - DISMISSED',
                detail: gap.dismissalReason || 'Provider declined',
                icon: 'red',
                iconText: '\u2717',
                status: 'dismissed',
                gapId: gap.id
            });
        }
    });
    
    // Deferred items
    allGaps.forEach(gap => {
        if (gap.deferred) {
            postVisitTasks.push({
                id: 'deferred-' + gap.id,
                section: 'deferred',
                title: gap.title + ' - DEFERRED',
                detail: `Target: ${gap.deferralTarget || 'Next Visit'} | ${gap.deferralReason || 'Deferred to future visit'}`,
                icon: 'purple',
                iconText: '\uD83D\uDCC5',
                status: 'deferred',
                gapId: gap.id
            });
        }
    });
    
    // Patient education tasks
    postVisitTasks.push({
        id: 'edu-ckd',
        section: 'education',
        title: 'CKD Patient Education',
        detail: 'Send kidney health education materials via patient portal',
        icon: 'teal',
        iconText: '\uD83D\uDCDA',
        status: 'pending',
        automatable: true,
        automationType: 'education'
    });
    postVisitTasks.push({
        id: 'edu-diabetes',
        section: 'education',
        title: 'Diabetes Self-Management',
        detail: 'Send blood sugar monitoring guide and dietary recommendations',
        icon: 'teal',
        iconText: '\uD83D\uDCDA',
        status: 'pending',
        automatable: true,
        automationType: 'education'
    });
    postVisitTasks.push({
        id: 'edu-fall',
        section: 'education',
        title: 'Fall Prevention Guide',
        detail: 'Send home safety checklist and exercise program',
        icon: 'teal',
        iconText: '\uD83D\uDCDA',
        status: 'pending',
        automatable: true,
        automationType: 'education'
    });
    
    // Build initial communication log
    if (communicationLog.length === 0) {
        communicationLog = [
            {
                type: 'call',
                title: 'TCM Outreach Call',
                detail: 'Post-discharge call completed. Medications verified. Appointment scheduled for Mon 2/18.',
                time: '2:15 PM',
                icon: 'call'
            },
            {
                type: 'sms',
                title: 'Appointment Confirmation SMS',
                detail: 'Sent to (555) 202-0700: "Your appointment with Dr. Campbell is confirmed for Mon, Feb 18 at 10:00 AM."',
                time: '2:20 PM',
                icon: 'sms'
            },
            {
                type: 'auto',
                title: 'Care Gap Analysis Complete',
                detail: '9 gaps identified. 4 suspect diagnoses, 3 quality measures, 2 frailty indicators staged for review.',
                time: '2:25 PM',
                icon: 'auto'
            }
        ];
    }
}

function renderPostVisitTasks() {
    const container = document.getElementById('pv-task-sections');
    if (!container) return;
    
    const sections = [
        { key: 'confirmed', label: 'Confirmed Diagnoses', icon: '\u2705' },
        { key: 'orders', label: 'Pending Orders', icon: '\uD83E\uDDEA' },
        { key: 'referrals', label: 'Referrals to Schedule', icon: '\uD83C\uDFE5' },
        { key: 'education', label: 'Patient Education', icon: '\uD83D\uDCDA' },
        { key: 'deferred', label: 'Deferred to Future Visit', icon: '\uD83D\uDCC5' },
        { key: 'dismissed', label: 'Dismissed by Provider', icon: '\u274C' }
    ];
    
    let html = '';
    let confirmedCount = 0, pendingCount = 0, dismissedCount = 0, automatedCount = 0;
    
    sections.forEach(section => {
        const tasks = postVisitTasks.filter(t => t.section === section.key);
        if (tasks.length === 0) return;
        
        html += `<div class="pv-section">`;
        html += `<div class="pv-section-header">${section.icon} ${section.label} <span class="pv-count">${tasks.length}</span></div>`;
        
        tasks.forEach(task => {
            const statusClass = task.status === 'completed' ? 'completed' : task.status === 'in-progress' ? 'in-progress' : 'pending';
            
            html += `<div class="pv-task-card ${statusClass}" id="task-${task.id}">`;
            html += `<div class="pv-task-icon ${task.icon}">${task.iconText}</div>`;
            html += `<div class="pv-task-body">`;
            html += `<div class="pv-task-title">${task.title}</div>`;
            html += `<div class="pv-task-detail">${task.detail}</div>`;
            html += `</div>`;
            
            // Action buttons
            html += `<div class="pv-task-action">`;
            if (task.status === 'completed') {
                html += `<button class="pv-btn-done">\u2713 Done</button>`;
                automatedCount++;
            } else if (task.status === 'in-progress') {
                html += `<span class="automation-pulse">In Progress</span>`;
            } else if (task.schedulable) {
                html += `<button class="pv-btn-schedule" onclick="openReferralScheduling('${task.id}', '${task.referralType}')">Schedule</button>`;
                pendingCount++;
            } else if (task.automatable) {
                html += `<button class="pv-btn-automate" onclick="automateTask('${task.id}', '${task.automationType}')">Automate</button>`;
                pendingCount++;
            } else if (task.status === 'confirmed') {
                html += `<span class="pv-status-badge confirmed">\u2713 Confirmed</span>`;
                confirmedCount++;
            } else if (task.status === 'dismissed') {
                html += `<span class="pv-status-badge dismissed">Dismissed</span>`;
                dismissedCount++;
            } else if (task.status === 'deferred') {
                html += `<span class="pv-status-badge deferred">Deferred</span>`;
                pendingCount++;
            } else {
                pendingCount++;
            }
            html += `</div>`;
            html += `</div>`;
        });
        
        html += `</div>`;
    });
    
    container.innerHTML = html;
    
    // Update stats
    document.getElementById('pv-confirmed-count').textContent = confirmedCount;
    document.getElementById('pv-pending-count').textContent = pendingCount;
    document.getElementById('pv-dismissed-count').textContent = dismissedCount;
    document.getElementById('pv-automated-count').textContent = automatedCount;
}

function renderCommunicationTimeline() {
    const container = document.getElementById('comm-timeline');
    const countEl = document.getElementById('comm-count');
    if (!container) return;
    
    let html = '';
    communicationLog.forEach(item => {
        html += `<div class="comm-item">`;
        html += `<div class="comm-icon ${item.icon}">`;
        if (item.icon === 'call') html += '\uD83D\uDCDE';
        else if (item.icon === 'sms') html += '\uD83D\uDCF1';
        else if (item.icon === 'email') html += '\uD83D\uDCE7';
        else if (item.icon === 'auto') html += '\uD83E\uDD16';
        html += `</div>`;
        html += `<div class="comm-body">`;
        html += `<div class="comm-title">${item.title}</div>`;
        html += `<div class="comm-detail">${item.detail}</div>`;
        html += `</div>`;
        html += `<div class="comm-time">${item.time}</div>`;
        html += `</div>`;
    });
    
    container.innerHTML = html;
    if (countEl) countEl.textContent = communicationLog.length;
}

// Florence Automation - execute automated tasks
function automateTask(taskId, automationType) {
    const task = postVisitTasks.find(t => t.id === taskId);
    if (!task) return;
    
    // Set to in-progress
    task.status = 'in-progress';
    renderPostVisitTasks();
    
    // Simulate automation with delay
    const automationMessages = {
        lab: {
            title: 'Lab Order Sent',
            detail: `Florence sent ${task.title} order to Quest Diagnostics. Patient will receive SMS with lab location and instructions.`,
            commTitle: `Lab Scheduled: ${task.title}`,
            commDetail: `Order sent to Quest Diagnostics (Main St location). SMS sent to patient with instructions and fasting requirements.`
        },
        education: {
            title: 'Education Materials Sent',
            detail: `Florence sent ${task.title} materials to patient portal and via SMS.`,
            commTitle: `Education Sent: ${task.title}`,
            commDetail: `Materials delivered via patient portal and SMS to (555) 202-0700.`
        },
        followup: {
            title: 'Follow-up Scheduled',
            detail: `Florence scheduled ${task.title} reminder for 6 weeks from today.`,
            commTitle: `Follow-up Reminder Set: ${task.title}`,
            commDetail: `Automated reminder set for 03/29/2026. Patient will receive SMS 3 days before.`
        }
    };
    
    const msg = automationMessages[automationType] || automationMessages.education;
    
    setTimeout(() => {
        task.status = 'completed';
        
        // Add to communication log
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        communicationLog.unshift({
            type: 'auto',
            title: msg.commTitle,
            detail: msg.commDetail,
            time: timeStr,
            icon: 'auto'
        });
        
        renderPostVisitTasks();
        renderCommunicationTimeline();
        
        if (typeof addLogEntry === 'function') {
            addLogEntry('Florence Automation', msg.detail);
        }
    }, 2000);
}

// Referral Scheduling Workflow
function openReferralScheduling(taskId, referralType) {
    referralSchedulingState = { step: 1, referralType, taskId };
    
    const modal = document.getElementById('referral-schedule-modal');
    const title = document.getElementById('rs-modal-title');
    const body = document.getElementById('rs-modal-body');
    const actionBtn = document.getElementById('rs-action-btn');
    
    const referralNames = {
        nephrology: 'Nephrology Consultation',
        cardiology: 'Cardiology Follow-up',
        endocrinology: 'Endocrinology Consultation'
    };
    
    title.textContent = `Schedule: ${referralNames[referralType] || referralType}`;
    actionBtn.textContent = 'Step 1: Send SMS to Patient';
    
    body.innerHTML = `
        <div class="rs-step active" id="rs-step-1">
            <div class="rs-step-number">1</div>
            <div class="rs-step-content">
                <div class="rs-step-title">Send SMS to Patient</div>
                <div class="rs-step-detail">Florence will text Jane to confirm availability and preferred times for the ${referralNames[referralType] || referralType} appointment.</div>
            </div>
        </div>
        <div class="rs-step" id="rs-step-2">
            <div class="rs-step-number">2</div>
            <div class="rs-step-content">
                <div class="rs-step-title">Patient Responds</div>
                <div class="rs-step-detail">Waiting for patient to confirm availability...</div>
            </div>
        </div>
        <div class="rs-step" id="rs-step-3">
            <div class="rs-step-number">3</div>
            <div class="rs-step-content">
                <div class="rs-step-title">3-Way Call to Specialist</div>
                <div class="rs-step-detail">Florence connects patient with specialist office to schedule.</div>
            </div>
        </div>
        <div class="rs-step" id="rs-step-4">
            <div class="rs-step-number">4</div>
            <div class="rs-step-content">
                <div class="rs-step-title">Appointment Confirmed</div>
                <div class="rs-step-detail">Appointment details filed to EHR and patient notified.</div>
            </div>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeReferralModal() {
    document.getElementById('referral-schedule-modal').classList.remove('active');
    referralSchedulingState = { step: 0, referralType: '', taskId: null };
}

function advanceReferralStep() {
    const state = referralSchedulingState;
    const actionBtn = document.getElementById('rs-action-btn');
    
    if (state.step === 1) {
        // Step 1 -> 2: SMS sent, waiting for patient
        document.getElementById('rs-step-1').className = 'rs-step completed';
        document.getElementById('rs-step-2').className = 'rs-step active';
        document.getElementById('rs-step-2').querySelector('.rs-step-detail').textContent = 
            'SMS sent to (555) 202-0700. Simulating patient response...';
        actionBtn.textContent = 'Waiting for Response...';
        actionBtn.disabled = true;
        
        // Add to comm log
        const now = new Date();
        communicationLog.unshift({
            type: 'sms',
            title: 'Referral Scheduling SMS Sent',
            detail: `"Hi Jane, Dr. Campbell has referred you to a ${state.referralType} specialist. Are you available next week for an appointment? Reply YES or preferred dates."`,
            time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
            icon: 'sms'
        });
        renderCommunicationTimeline();
        
        // Simulate patient response after 2s
        setTimeout(() => {
            document.getElementById('rs-step-2').querySelector('.rs-step-detail').textContent = 
                'Patient replied: "YES, Tuesday or Wednesday morning works best."';
            document.getElementById('rs-step-2').className = 'rs-step completed';
            document.getElementById('rs-step-3').className = 'rs-step active';
            actionBtn.textContent = 'Step 3: Initiate 3-Way Call';
            actionBtn.disabled = false;
            state.step = 2;
            
            communicationLog.unshift({
                type: 'sms',
                title: 'Patient Response Received',
                detail: 'Jane replied: "YES, Tuesday or Wednesday morning works best."',
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                icon: 'sms'
            });
            renderCommunicationTimeline();
        }, 2500);
        
        state.step = 1.5; // intermediate
        return;
    }
    
    if (state.step === 2) {
        // Step 3: 3-way call
        document.getElementById('rs-step-3').querySelector('.rs-step-detail').textContent = 
            'Connecting Florence, Jane, and specialist office...';
        actionBtn.textContent = 'Connecting...';
        actionBtn.disabled = true;
        
        setTimeout(() => {
            document.getElementById('rs-step-3').querySelector('.rs-step-detail').textContent = 
                'Call completed. Appointment scheduled for Tuesday, Feb 25, 2026 at 9:30 AM with Dr. Patel (Nephrology).';
            document.getElementById('rs-step-3').className = 'rs-step completed';
            document.getElementById('rs-step-4').className = 'rs-step completed';
            document.getElementById('rs-step-4').querySelector('.rs-step-detail').textContent = 
                'Appointment confirmed and filed to EHR. Patient will receive reminder SMS 24 hours before.';
            actionBtn.textContent = 'Done - Close';
            actionBtn.disabled = false;
            state.step = 4;
            
            // Update the task
            const task = postVisitTasks.find(t => t.id === state.taskId);
            if (task) {
                task.status = 'completed';
                task.detail = 'Scheduled: Tue, Feb 25, 2026 at 9:30 AM - Dr. Patel (Nephrology)';
            }
            
            communicationLog.unshift({
                type: 'call',
                title: 'Referral Appointment Scheduled',
                detail: `3-way call completed. ${state.referralType} appointment: Tue, Feb 25, 2026 at 9:30 AM with Dr. Patel.`,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                icon: 'call'
            });
            
            renderPostVisitTasks();
            renderCommunicationTimeline();
            
            if (typeof addLogEntry === 'function') {
                addLogEntry('Referral Scheduled', `${state.referralType} appointment scheduled for Tue, Feb 25 at 9:30 AM`);
            }
            
            // Write referral to athenaOne Referrals section
            const referralsStaged = document.getElementById('referrals-staged');
            if (referralsStaged) {
                const referralBlock = document.createElement('div');
                referralBlock.className = 'referral-item signed';
                referralBlock.style.cssText = 'animation: slideInFromRight 0.5s ease; border-left: 3px solid #4CAF50; background: #f1f8e9;';
                referralBlock.innerHTML = `
                    <div class="referral-header">
                        <span class="referral-status signed"> SIGNED</span>
                        <span class="referral-specialty">Nephrology - CKD Management</span>
                    </div>
                    <div class="referral-details">
                        <div><strong>Linked to:</strong> CKD Stage 3a (N18.3)</div>
                        <div><strong>Signed:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })} by Dr. Campbell</div>
                        <div><strong>Status:</strong> <span style="color: #43A047;"> Scheduled - Appt 02/25/2026 9:30 AM</span></div>
                        <div style="font-size: 11px; color: #757575; margin-top: 4px;">Scheduled by Florence AI via 3-way call with patient on ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}</div>
                    </div>
                `;
                referralsStaged.appendChild(referralBlock);
                
                // Scroll to referrals section to show the update
                setTimeout(() => {
                    const referralsSection = document.getElementById('section-referrals');
                    if (referralsSection) {
                        referralsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        referralsSection.style.transition = 'all 0.5s ease';
                        referralsSection.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.5)';
                        referralsSection.style.background = '#f1f8e9';
                        setTimeout(() => {
                            referralsSection.style.boxShadow = '';
                            referralsSection.style.background = '';
                        }, 2500);
                    }
                }, 500);
                
                // Play ding sound for referral update
                syncSounds.playDing();
                
                // Trigger sync notification
                if (typeof triggerSyncNotification === 'function') {
                    triggerSyncNotification('Nephrology referral scheduled and filed to EHR');
                }
            }
        }, 2000);
        
        state.step = 3;
        return;
    }
    
    if (state.step === 4) {
        closeReferralModal();
    }
}

// Add "Post-Visit Tasks" button to the Florence panel header
function addPostVisitButton() {
    const syncBtn = document.getElementById('sync-button');
    if (!syncBtn) return;
    
    // Check if button already exists
    if (document.getElementById('post-visit-btn')) return;
    
    const pvBtn = document.createElement('button');
    pvBtn.id = 'post-visit-btn';
    pvBtn.className = 'sync-button';
    pvBtn.style.cssText = 'background: linear-gradient(135deg, #8B5CF6, #6D28D9); margin-top: 6px; font-size: 11px;';
    pvBtn.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
        </svg>
        Post-Visit Tasks
    `;
    pvBtn.onclick = showPostVisitView;
    syncBtn.parentNode.insertBefore(pvBtn, syncBtn.nextSibling);
}

// Make functions globally available
window.showPostVisitView = showPostVisitView;
window.closePostVisitView = closePostVisitView;
window.automateTask = automateTask;
window.openReferralScheduling = openReferralScheduling;
window.closeReferralModal = closeReferralModal;
window.advanceReferralStep = advanceReferralStep;

// Initialize post-visit button
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addPostVisitButton);
} else {
    addPostVisitButton();
}

// ==================== POST-ENCOUNTER DEMO WALKTHROUGH ====================
// This function runs an automated demo of the post-encounter follow-through
// for the salesperson to show during the demo
async function runPostEncounterDemo() {
    const demoBtn = document.getElementById('run-demo-btn');
    if (!demoBtn) return;
    demoBtn.disabled = true;
    demoBtn.innerHTML = '&#9654; Running...';
    demoBtn.style.opacity = '0.7';
    
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    
    // Helper to scroll the post-visit overlay to a specific task
    function scrollToTask(taskId) {
        const taskEl = document.getElementById('task-' + taskId);
        if (taskEl) {
            taskEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            taskEl.style.transition = 'all 0.3s ease';
            taskEl.style.boxShadow = '0 0 15px rgba(85, 181, 184, 0.5)';
            setTimeout(() => { taskEl.style.boxShadow = ''; }, 2000);
        }
    }
    
    // STEP 1: Automate BMP Lab Order
    scrollToTask('order-bmp');
    await wait(1500);
    automateTask('order-bmp', 'lab');
    await wait(3000);
    
    // STEP 2: Automate HbA1c Lab Order
    scrollToTask('order-a1c');
    await wait(1000);
    automateTask('order-a1c', 'lab');
    await wait(3000);
    
    // STEP 3: Schedule Nephrology Referral (the big one)
    scrollToTask('referral-nephro');
    await wait(1500);
    openReferralScheduling('referral-nephro', 'nephrology');
    await wait(2000);
    
    // Auto-advance through the referral steps
    advanceReferralStep(); // Step 1: Send SMS
    await wait(4000); // Wait for patient response simulation
    advanceReferralStep(); // Step 3: 3-way call
    await wait(3500); // Wait for call completion
    advanceReferralStep(); // Step 4: Close modal
    await wait(1500);
    
    // STEP 4: Automate CKD Patient Education
    scrollToTask('edu-ckd');
    await wait(1000);
    automateTask('edu-ckd', 'education');
    await wait(2500);
    
    // STEP 5: Automate Diabetes Education
    scrollToTask('edu-diabetes');
    await wait(1000);
    automateTask('edu-diabetes', 'education');
    await wait(2500);
    
    // STEP 6: Automate Fall Prevention Guide
    scrollToTask('edu-fall');
    await wait(1000);
    automateTask('edu-fall', 'education');
    await wait(2500);
    
    // STEP 7: Automate Statin Therapy Follow-up
    scrollToTask('referral-statin');
    await wait(1000);
    automateTask('referral-statin', 'followup');
    await wait(3000);
    
    // Scroll to communication timeline to show all the activity
    const commTimeline = document.getElementById('comm-timeline');
    if (commTimeline) {
        commTimeline.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Show completion celebration
    await wait(1000);
    
    // Play celebration sound for completion
    syncSounds.playCelebration();
    
    showSyncCelebration(
        ' Post-Encounter Follow-Through Complete',
        'All tasks automated. Labs ordered, referral scheduled, education sent.',
        '#8B5CF6'
    );
    
    // Reset demo button
    demoBtn.disabled = false;
    demoBtn.innerHTML = '\u2713 Demo Complete';
    demoBtn.style.background = 'linear-gradient(135deg, #10B981, #059669)';
    demoBtn.style.opacity = '1';
}

    </script>

    <!-- Bulk Gap Staging Button (floating) -->
    <button id="bulk-stage-btn" class="bulk-stage-btn" onclick="openBulkStagingModal()">Stage Selected (0)</button>

    <!-- Bulk Gap Staging Modal -->
    <div id="bulk-staging-modal" class="modal-overlay">
        <div class="modal bulk-modal">
            <div class="modal-header">
                <h3>Stage Multiple Gaps for MD Review</h3>
                <button class="modal-close" onclick="closeBulkStagingModal()"></button>
            </div>
            <div class="modal-body">
                <div id="bulk-gap-list" class="bulk-gap-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBulkStagingModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmBulkStaging()">Confirm Stage All</button>
            </div>
        </div>
    </div>

</body>
</html>
<- Improve UX for sales trigger deploy -->
